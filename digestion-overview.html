<!DOCTYPE html>
<html>
<link rel="import" href="nextprot-elements-shared-styles.html">
<link rel="import" href="external-scripts.html">
<link rel="import" href="evidence-item.html">
<link rel="import" href="quality-label.html">
<link rel="import" href="heatmap-table-row.html">
<script src="../nextprot/src/nextprot-core.js"></script>
<script src="../nextprot/src/nextprot-utils.js"></script>
<!-- <link rel="import" href="/nextprot-js/dataenzymes.html"> -->

<!-- <script src="../../jquery/dist/jquery.js"></script>
<script src="../../bootstrap/dist/js/bootstrap.js"></script> -->

<!--
`digestion-overview`
Digestion overview
@demo demo/digestion-overview-demo.html
-->
<dom-module id="digestion-overview">

    <template>
        <div id="isoform-digestion" ></div>
        <div>
            <!-- <template is="dom-if" if="[[digestByProtease.proteases]]"></template> -->
            <h2>Digested peptides </h2>
            Enter Isoform AC <input id="Isoform" type="text" value="{{entryName}}"> or 
            <input type="button" id="sequence" value="sequence"><br><br>
            <label for="MaxMC"> Max missed cleavages </label>
            <select id="MaxMC">
                <option selected="selected" value="0">0</option>
                <option value="1">1</option>
                <option value="2">2</option>
                <option value="3">3</option>
            </select>
            Peptide size min<input id="minSize" type="number" name="min" value="7">
            max <input id="maxSize" type="number" name="max" value="">
            <input type="submit" name="Digest" value="DIGEST" on-click="_digestIsoform">
            <input type="reset" name="reset" value="RESET" >
        </div>
        </div>
    </template>

    <script>
        Polymer({
            is: 'digestion-overview',
            properties: {
                nxConfig: {
                    type: Object,
                    value: {"env": "pro"}
                },
                dataloaded: {
                    type: Boolean,
                    observer: 'updateSpinnerStatus'
                },
                proteases: {
                    type: Array,
                    value: []
                }, 
                promises: {
                    type: Array,
                    value: []
                },
                entryName : {
                    type: String, 
                    value: ""
                },
                maxmissedcleavages: {
                    type: Number,
                    value: '0',
                },
                minPeptideSize: {
                    type: Number,
                    value: '7'
                },
                maxPeptideSize:{
                    type: Number,
                    value: ''
                },
                digestsByProtease: {
                    type: Object,
                    value: {}
                },
                _digestIsoform: {function(proteases){
                }},
            },
            
            ready: function () {
                var nx = new Nextprot.Client("digestion", "Calipho Group");
                this._initApiClient();
                this._npClient.getJSON("/digestion/available-protease-list.json", "true")
                    .then(function (proteases) {
                        console.log(proteases);
                    });
                this._buildURL();
            },
            _initApiClient: function () {
                this._npClient = new Nextprot.Client("neXtProt protein overview", "Calipho Group");

                if (this.nxConfig.env) {
                    this._npClient.updateEnvironment(this.nxConfig.env);
                }
            },
            _buildURL: function (entryName, maxmissedcleavages, minPeptideSize, maxPeptideSize, protease) {
                var urladdress = "/digestion/" + entryName + ".json?protease=" + protease + "&minpeplen=" + minPeptideSize + "&maxpeplen=" + maxPeptideSize + "&maxmissedcleavages=" + maxmissedcleavages + "&digestmaturepartsonly=true";
                return urladdress;
                console.log(urladdress);
            },
            _digestIsoform: function (proteases) {
                console.log(this.entryName);
                for (var i = 0; i < proteases.length; i++) {
                    var protease = proteases[i];
                    var url = this.buildURL(entryName, maxmissedcleavages, minPeptideSize, maxPeptideSize, protease);
                    this.promises.push(this._npClient.getJSON(url, "true").then(function (digests) {

                        digestsByProtease.protease = digests;
                        return digests;
                        console.log(digests);
                    }));
                }

                Promise.all(this.promises).then(function (results) {
                    console.log(results);
                    return results; 
                })
            },
        });

    </script>
</dom-module>
</html>