<!DOCTYPE html>
<html>
<link rel="import" href="nextprot-elements-shared-styles.html">
<link rel="import" href="external-scripts.html">
<link rel="import" href="evidence-item.html">
<link rel="import" href="quality-label.html">
<link rel="import" href="heatmap-table-row.html">
<script src="../nextprot/src/nextprot-core.js"></script>
<script src="../nextprot/src/nextprot-utils.js"></script>
<!-- <link rel="import" href="/nextprot-js/dataenzymes.html"> -->

<!-- <script src="../../jquery/dist/jquery.js"></script>
<script src="../../bootstrap/dist/js/bootstrap.js"></script> -->

<!--
`digestion-overview`
Digestion overview
@demo demo/digestion-overview-demo.html
-->
<dom-module id="digestion-overview">

    <template>
        <div id="isoform-digestion"></div>
        <div>
            <!-- <template is="dom-if" if="[[digestByProtease.proteases]]"></template> -->
            <h2>Protein digestion tool </h2>
            <paper-input label="Enter primary Uniprot/neXtProt accession number, i.e NX_P50222-1" value={{entryName}}></paper-input>
            <paper-input  label="Max missed cleavages" auto-validate pattern="[0-3]*" error-message="Number of max missed cleaveages only between 0 and 3" value="{{maxmissedcleavages}}" ></paper-input>
            <paper-input label="Min peptide length" value="{{minPeptideSize}}"></paper-input>
            <paper-input label="Max peptide length" value="{{maxPeptideSize}}"></paper-input>
            <input type="submit" name="Digest" value="DIGEST" on-click="_digestIsoform">
            <input type="reset" name="reset" value="RESET">
        </div>
        </div>
        <div>
            <h3> Digested peptides for each protease : </h3>
                <table>
                    <thead>
                        <tr>
                            <td> Protease name</td>
                            <td> Peptide count</td>
                            <td> Unique peptide count </td>
                        </tr>
                    </thead>
                    <tbody>
                            <template is="dom-repeat" items="{{digestsByProtease}}" as="dBP">

                        <tr> 
                            <td>[[dBP.name]]</td>
                            <td>
                                [[dBP.peptide_count]]
                            </td>
                            <td>
                                [[dBP.unique_peptide_count]]
                            </td>
                            <!-- <td>
                                <template is="dom-repeat" items="[[dBP.peptide_list]]" as="pep">
                                    <span>[[pep]] , </span>
                                </template>
                            </td> -->
                        </tr>
                    </tbody>
                </table>
                <h3> Select a protease : </h3>
                <paper-input label="Select a protease" value="{{protease}}"></paper-input>    
                <input type="submit" name="Digest" value="DIGEST" on-click="_peptidesList">  
                <table>
                        <thead>
                            <tr>
                                <td> Peptide sequence</td>
                            </tr>
                        </thead>
                        <tbody>    
                            <tr> 
                                <td></td>
                            </tr>
                        </tbody>
                    </table>
        </div>
            </template>
        </div>
    </template>


    <script>
        Polymer({
            is: 'digestion-overview',
            properties: {
                nxConfig: {
                    type: Object,
                    value: { "env": "pro" }
                },
                dataloaded: {
                    type: Boolean,
                    observer: 'updateSpinnerStatus'
                },
                proteases: {
                    type: Array,
                    value: []
                },
                promises: {
                    type: Array,
                    value: []
                },
                entryName: {
                    type: String,
                    value: "NX_P01308-1"
                },
                maxmissedcleavages: {
                    type: Number,
                    value: '0',
                },
                minPeptideSize: {
                    type: Number,
                    value: '7'
                },
                maxPeptideSize: {
                    type: Number,
                    value: ''
                },
                protease_data: {
                    type: Array,
                    value: [],
                },
                protease:{
                    type: String,
                    value:""
                },
                results:{
                    type: Array,
                    value: []
                }
            },
           
            ready: function () {
                this.nx = new Nextprot.Client("digestion", "Calipho Group");
                this._initApiClient();
                var self = this;
                this._npClient.getJSON("/digestion/available-protease-list.json", "true")
                    .then(function (proteases) {
                        self.proteases = proteases;
                    });
            },
            _initApiClient: function () {
                this._npClient = new Nextprot.Client("neXtProt protein overview", "Calipho Group");

                if (this.nxConfig.env) {
                    this._npClient.updateEnvironment(this.nxConfig.env);
                }
            },
            _buildURL: function (entryName, maxmissedcleavages, minPeptideSize, maxPeptideSize, protease) {
                var urladdress = "/digestion/" + entryName + ".json?protease=" + protease + "&minpeplen=" + minPeptideSize + "&maxpeplen=" + maxPeptideSize + "&maxmissedcleavages=" + maxmissedcleavages + "&digestmaturepartsonly=true";
                return urladdress;
            },
            _digestIsoform: function () {
                console.log(this.entryName);
                var full_peptide_list = [];
                var proteases = this.proteases;

                var self = this;
                var protease_data = []

                for (var i = 0; i < proteases.length; i++) {
                    var protease = proteases[i];
                    var url = this._buildURL(this.entryName, this.maxmissedcleavages, this.minPeptideSize, this.maxPeptideSize, protease);
                    this.promises.push(this._npClient.getJSON(url, "true"));
                }
                Promise.all(this.promises).then(function (results) {
                    console.log("results", results);
                    console.log("self.digestsByProtease", self.digestsByProtease);
                    for (var i = 0; i < proteases.length; i++) {
                        var digests = results[i];
                        var pepcount = digests.length;
                        protease_data.push(
                            {
                                "name": proteases[i],
                                "peptide_list": digests,
                                "peptide_count": pepcount
                            });
                        console.log("Peptide count", pepcount);
                        full_peptide_list = full_peptide_list.concat(digests)
                    }
                    full_peptide_list = full_peptide_list.filter(function(item, pos, self) {
                        return self.indexOf(item) == pos;
                    })
                    console.log('uniq peptide list submitted to pepx : ',full_peptide_list.length);
                    var peplist_to_str = full_peptide_list.join(",");
                    console.log("char count : " + peplist_to_str.length);
                    self.nx.getEntryforPeptide(peplist_to_str).then(function(data){
                        console.log("pepx response data length", data.length)
                        console.log(data)
                        var new_pep_map = self._createPeptideMap(data);
                        console.log('new_pep_map',new_pep_map)

                        for(var i=0; i < protease_data.length;i++){
                            var uniq_count = 0;
                            protease_data[i].peptide_list.forEach(function(peptide){
                                if (new_pep_map[peptide].uniqueness) uniq_count +=1;
                            })
                            protease_data[i]['unique_peptide_count'] = uniq_count;
                        }
                        console.log("new version of protease_data : ",protease_data);
                        
                        self.set('digestsByProtease', protease_data);  
                    })
                })
            },
            _createPeptideMap: function(data){
                var pepMap = {}
                data.forEach(function(el){
                    el.annotationsByCategory["pepx-virtual-annotation"].forEach(function(pep){
                        if(!pepMap.hasOwnProperty(pep.cvTermName)){
                            pepMap[pep.cvTermName] = {
                                'entries': [el.uniqueName],
                                'uniqueness': pep.properties.filter(function(pp){return pp.name === "peptide unicity"})[0].value === "UNIQUE"
                            }
                        }
                        else{
                            pepMap[pep.cvTermName].entries.push(el.uniqueName);
                        }
                    });
                });
                return pepMap;
            },
            _peptidesList: function(){
                console.log("Protease name :",this.protease);
                console.log("Entry name :",this.entryName);
                console.log("Peptides list", this.digestsByProtease);
                var results = this.digestsByProtease.filter(
                    (a) => a.name == this.protease
                )[0].peptide_list;
                console.log("results",results);
            },
        });

    </script>
</dom-module>

</html>