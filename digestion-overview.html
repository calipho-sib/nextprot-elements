<!DOCTYPE html>
<html>
<link rel="import" href="nextprot-elements-shared-styles.html">
<link rel="import" href="external-scripts.html">
<link rel="import" href="evidence-item.html">
<link rel="import" href="quality-label.html">
<link rel="import" href="heatmap-table-row.html">
<script src="../nextprot/src/nextprot-core.js"></script>
<script src="../nextprot/src/nextprot-utils.js"></script>
<!-- <script src="https://code.jquery.com/jquery-3.3.1.js"></script>
<script src="https://cdn.datatables.net/1.10.19/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.datatables.net/1.10.19/js/dataTables.bootstrap.min.js"></script> -->

<!-- <link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/1.10.18/css/jquery.dataTables.min.css"/>
<link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/buttons/1.5.6/css/buttons.dataTables.min.css"/> -->

<!-- export extension :  -->
<!-- <script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.1.53/pdfmake.min.js"></script>
<script src="https://cdn.datatables.net/buttons/1.5.6/js/dataTables.buttons.min.js"></script>
<script src="https://cdn.datatables.net/buttons/1.5.6/js/buttons.flash.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.1.3/jszip.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.1.53/vfs_fonts.js"></script>
<script src="https://cdn.datatables.net/buttons/1.5.6/js/buttons.html5.min.js"></script>
<script src="https://cdn.datatables.net/buttons/1.5.6/js/buttons.print.min.js"></script> -->

<link rel="stylesheet" type="text/css"
    href="https://cdn.datatables.net/v/bs-3.3.7/jszip-2.5.0/dt-1.10.18/b-1.5.6/b-flash-1.5.6/b-html5-1.5.6/b-print-1.5.6/sl-1.3.0/datatables.min.css" />

<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.1.36/pdfmake.min.js"></script>
<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.1.36/vfs_fonts.js"></script>
<!-- <script type="text/javascript" src="https://cdn.datatables.net/fixedcolumns/3.2.6/js/dataTables.fixedColumns.min.js"></script> -->
<script type="text/javascript"
    src="https://cdn.datatables.net/v/bs-3.3.7/jszip-2.5.0/dt-1.10.18/b-1.5.6/b-flash-1.5.6/b-html5-1.5.6/b-print-1.5.6/sl-1.3.0/datatables.min.js"></script>

<style>
#table.dataTable tbody tr.selected,#table.dataTable tbody tr.selected td {
    color: white;
    /* background-color: rgba(197, 0, 99, 0.1); */
    background-color:#00780066;
}
.pagination>.active>a,
.pagination>.active>a:focus,
.pagination>.active>a:hover, 
.pagination>.active>span,
.pagination>.active>span:focus,
.pagination>.active>span:hover {
    background-color: #007800;
    /* background-color: #C50063; */
}
.pagination>li>a {
    color: #007800;
    /* color: #C50063; */
}
</style>

<!-- <link type="text/css" href="//gyrocode.github.io/jquery-datatables-checkboxes/1.2.11/css/dataTables.checkboxes.css" rel="stylesheet" />
<script type="text/javascript" src="//gyrocode.github.io/jquery-datatables-checkboxes/1.2.11/js/dataTables.checkboxes.min.js"></script> -->
<!-- <script src="../../jquery/dist/jquery.js"></script>
    <script src="../../bootstrap/dist/js/bootstrap.js"></script> -->
<!--
`digestion-overview`
Digestion overview
@demo demo/digestion-overview-demo.html
-->

<dom-module id="digestion-overview">
    <style>
        :host {
            margin: 10px;
        }

        h1 {
            font-family: "Helvetica Neue";
            font-weight: 500;
            font-size: 30px;
            text-align: center;
            margin-bottom: 30px;
        }

        h3 {
            font-family: 'Roboto';
            font-size: 16px;
            font-weight: 900;
            margin: 30px 10px;
            /* letter-spacing: 0.2px; */
        }

        paper-button.blue {
            /* background-color: var(--paper-blue-500); */
            background-color: #C50063;
            color: white;
        }

        paper-button {
            padding: 5px;
            margin-bottom: 10px;
        }

        paper-input {
            --paper-input-container-focus-color: #C50063;
        }

        a {
            text-decoration: none;
            color: palevioletred;
        }

        .form-container {
            display: flex;
            flex-direction: row;
            align-items: flex-end;
            align-content: flex-end;
            margin: 0px 10px;
        }

        .form-container paper-input {
            margin: 0px 10px;
            flex-grow: 1;
        }

        .table-container {
            margin: 10px;
        }

        .dt-buttons {
            float: left;
        }
       
        .dataTables_wrapper.btn-group {
            float: left;
        }
        #table.dataTable tbody tr.selected {
            color: white !important;
            background-color: #C50063 !important;
        }
    </style>

    <template>
        <!-- <div id="isoform-digestion"></div> -->
        <div id="isoform-digestion">
            <h1>Protein digestion tool </h1>
            <div class="description" style="font-size:18px; display:inline-block; text-align: center; font-style: italic; font-weight: 300">
                    The protein digestion tool allowed scientists for their proteomic experiments by predicting peptides sequences after enzymatic digestion with parameters (missed cleavages, unicity).
            </div>
            <div class="documentation" style="font-size:15px; display:inline-block; font-weight: 300">
                <a href="https://www.nextprot.org/help/protein-digestion" target="_blank"> The documentation of this tool is available on this link</a>
            </div>
            <hr id="separationLine" class="" style="margin:15px 0px 15px;">
            <div id="first-form">
                <div class="form-container">
                    <paper-input style="flex-grow:7" 
                        label="Enter primary neXtProt accession number, i.e NX_P50222-1" value={{isoformAC}}
                        always-float-label required></paper-input>
                    <paper-input style="flex-grow:1" label="Max missed cleavages" type=number min=0 max=3
                        error-message="Number of max missed cleaveages only between 0 and 3"
                        value="{{maxmissedcleavages}}" always-float-label></paper-input>
                    <paper-input style="flex-grow:1" label="Min peptide length" type=number min=7
                    error-message="Minimum peptide size is 7"
                    value="{{minPeptideSize}}" always-float-label></paper-input>
                    <paper-input style="flex-grow:1" label="Max peptide length" type=number min={{minPeptideSize}} value="{{maxPeptideSize}}"
                        always-float-label></paper-input>
                    <paper-button raised class="custom blue" on-click="_resetValues">RESET</paper-button>
                    <paper-button raised class="custom blue" on-click="_digestIsoform">DIGEST</paper-button>
                </div>
            </div>
            <template is="dom-if" if="[[digestsByProtease.length]]">
                <h3> DIGESTED PEPTIDES FOR EACH PROTEASE :</h3>
            </template>
            <div class="table-container">
                <table id="table" class="table table-striped table-bordered table-condensed display" width="100%">
                    <!-- <thead>
                            <tr>
                                <th></th>
                                <th>First name</th>
                                <th>Last name</th>
                                <th>Position</th>
                            </tr>
                        </thead> -->
                </table>
            </div>
            <template is="dom-if" if="[[digestsByProtease.length]]">
                <div>
                    <div class="form-container">
                        <paper-input label="Select a protease" value="{{proteases_selected}}" always-float-label></paper-input>
                        <!-- <div> -->
                        <paper-button raised class="custom blue" on-click="_resetProtease">RESET</paper-button>
                        <paper-button raised class="custom blue" on-click="_peptidesList">DIGEST</paper-button>
                    </div>
                    <div class="table-container">
                        <table id="table_2" class="table table-striped table-bordered table-condensed" width="100%">
                    </div>  
                </div>
            </template>
        </div>
    </template>

    <script>
        Polymer({
            is: 'digestion-overview',
            properties: {
                nxConfig: {
                    type: Object,
                    value: { "env": "pro" }
                },
                dataloaded: {
                    type: Boolean,
                    observer: 'updateSpinnerStatus'
                },
                proteases: {
                    type: Array,
                    value: []
                },
                promises: {
                    type: Array,
                    value: []
                },
                isoformAC: {
                    type: String,
                    value: ""
                },
                maxmissedcleavages: {
                    type: Number,
                    value: '0',
                },
                minPeptideSize: {
                    type: Number,
                    value: '7'
                },
                maxPeptideSize: {
                    type: Number,
                    value: ''
                },
                digestsByProtease: {
                    type: Array,
                    value: [],
                },
                proteases_selected: {
                    type: String,
                    value: ""
                },
                results: {
                    type: Array,
                    value: []
                },
                peptides_data: {
                    type: Array,
                    value: []
                },
                new_pep_map: {
                    type: Object,
                    value: {}
                },
                isoform_seq: {
                    type: String,
                    value: ""
                },
                peptide_mapping: {
                    type: Array,
                    value: []
                }
            },

        ready: function () {
            this.nx = new Nextprot.Client("digestion", "Calipho Group");
            this._initApiClient();
            var self = this;
            this._npClient.getJSON("/digestion/available-protease-list.json", "true")
                .then(function (proteases) {
                    self.proteases = proteases;
                });
        },
        _initApiClient: function () {
            this._npClient = new Nextprot.Client("neXtProt protein overview", "Calipho Group");
            if (this.nxConfig.env) {
                this._npClient.updateEnvironment(this.nxConfig.env);
            }
        },
        _buildURL: function (isoformAC, maxmissedcleavages, minPeptideSize, maxPeptideSize, protease) {
            var urladdress = "/digestion/" + isoformAC + ".json?protease=" + protease + "&minpeplen=" + minPeptideSize + "&maxpeplen=" + maxPeptideSize + "&maxmissedcleavages=" + maxmissedcleavages + "&digestmaturepartsonly=true";
            return urladdress;
        },
        _resetValues: function(){
            this.isoformAC="";
            this.maxmissedcleavages=0;
            this.minPeptideSize=7;
            this.maxPeptideSize="";
        },
        _resetProtease: function(){
        },
        _digestIsoform: function () {
            console.log(this.isoformAC);
            var full_peptide_list = [];
            var proteases = this.proteases;

            var self = this;
            var protease_data = []
            var protease_api_call = []
            var peptide_mapping_calls = []

            peptide_mapping_calls.push(this.nx.getProteinSequence(this.isoformAC));
            peptide_mapping_calls.push(this.nx.getAnnotationsByCategory(this.isoformAC, "peptide-mapping"));
            peptide_mapping_calls.push(this.nx.getAnnotationsByCategory(this.isoformAC, "srm-peptide-mapping"));


            Promise.all(peptide_mapping_calls).then(function (peptide_nextprot) {
                // console.log("peptide_nextprot", peptide_nextprot);
                self.isoform_seq = peptide_nextprot[0].filter(function (iso) { return iso.isoformAccession === self.isoformAC })[0];
                var natural_pep = peptide_nextprot[1].annot;
                var synthetic_pep = peptide_nextprot[2].annot;
                // console.log("peptide_natural", natural_pep)
                console.log("peptide_synthetic", synthetic_pep)
                var peptide_mapping = [];
                for (var i = 0; i < natural_pep.length; i++) {
                    if (natural_pep[i].targetingIsoformsMap.hasOwnProperty(self.isoformAC)) {
                        var key = natural_pep[i].targetingIsoformsMap[self.isoformAC].firstPosition + "-" + natural_pep[i].targetingIsoformsMap[self.isoformAC].lastPosition;
                        if (peptide_mapping.hasOwnProperty(key)) {
                            peptide_mapping[key].natural = true;
                        }
                        else {
                            peptide_mapping[key] = {
                                "natural": true,
                                "synthetic": false
                            }
                        }
                    }
                }
                for (var i = 0; i < synthetic_pep.length; i++) {
                    if (synthetic_pep[i].targetingIsoformsMap.hasOwnProperty(self.isoformAC)) {
                        var key = synthetic_pep[i].targetingIsoformsMap[self.isoformAC].firstPosition + "-" + synthetic_pep[i].targetingIsoformsMap[self.isoformAC].lastPosition;
                        if (peptide_mapping.hasOwnProperty(key)) {
                            peptide_mapping[key].synthetic = true;
                        }
                        else {
                            peptide_mapping[key] = {
                                "natural": false,
                                "synthetic": true
                            }
                        }
                    }
                }

                self.set('peptide_mapping', peptide_mapping);
                console.log("peptide_mapping", peptide_mapping);


                for (var i = 0; i < proteases.length; i++) {
                    var protease = proteases[i];
                    var url = self._buildURL(self.isoformAC, self.maxmissedcleavages, self.minPeptideSize, self.maxPeptideSize, protease);
                    protease_api_call.push(self._npClient.getJSON(url, true));
                }

                Promise.all(protease_api_call).then(function (results) {
                    for (var i = 0; i < proteases.length; i++) {
                        var digests = results[i];
                        var pepcount = digests.length;


                        protease_data.push(
                            {
                                "name": proteases[i],
                                "peptide_list": digests,
                                "peptide_count": pepcount
                            });
                        // console.log("Peptide count", pepcount);
                        full_peptide_list = full_peptide_list.concat(digests)
                    }
                    full_peptide_list = full_peptide_list.filter(function (item, pos, self) {
                        return self.indexOf(item) == pos;
                    })
                    console.log('Peptide list submitted to pepx : ', full_peptide_list.length);
                    var peplist_to_str = full_peptide_list.join(",");
                    // console.log("char count : " + peplist_to_str.length);
                    self.nx.getEntryforPeptide(peplist_to_str).then(function (data) {
                        // console.log("pepx response data length", data.length)
                        console.log("Entry for peptide", data);
                        self.new_pep_map = self._createPeptideMap(data);
                        console.log('new_pep_map', self.new_pep_map)

                        for (var i = 0; i < protease_data.length; i++) {
                            var uniq_count = 0;
                            protease_data[i].peptide_list.forEach(function (peptide) {
                                if (self.new_pep_map[peptide].uniqueness !== "NOT_UNIQUE") uniq_count += 1;

                            })
                            protease_data[i]['unique_peptide_count'] = uniq_count;
                        }
                        console.log("Proteases with list of peptides and counts: ", protease_data);

                        self.set('digestsByProtease', protease_data);
                        $(document).ready(function () {
                            console.log("protease_data", protease_data)
                            var d1_table = $('#table').DataTable({
                                dom: "<'row firstHeadTable'<'col-md-12'B>>" +
                                    "<'row secondHeadTable'<'col-sm-3 col-md-4'i><'col-sm-6 pull-right'f>>" +
                                    "<'row no_overmargin'<'col-sm-12 table_overflow'tr>>" +
                                    "<'row no_overmargin'<'col-sm-3 col-md-2'l><'col-sm-9 pull-right pageTable'p>>",
                                buttons: [
                                    'copy', 'csv', 'excel', 'pdf', 'print'
                                ],
                                deferRender: true,
                                processing: true,
                                data: protease_data,
                                columns: [
                                    { defaultContent: '' },
                                    { data: 'name', title: 'Protease name', className: "uniqueClassName"},
                                    { data: 'peptide_count', title: 'Peptide count', className: "uniqueClassName"},
                                    { data: 'unique_peptide_count', title: 'Unique peptide count',className: "uniqueClassName" }
                                ],
                                scrollY:        300 ,
                                scrollCollapse: true,
                                paging:         false,
                                columnDefs: [{
                                    orderable: false,
                                    className: 'select-checkbox',
                                    targets: 0
                                }],
                                select: {
                                    style: 'single'
                                },
                                order: [[1, 'asc']]

                            });
                            d1_table
                                .on('select', function (e, dt, type, indexes) {
                                    var selected_rows = d1_table.rows({ selected: true });
                                    // console.log("selected_rows", selected_rows[0])
                                    self._updateProteaseSelected(selected_rows[0]);
                                    // var rowData = d1_table.rows( indexes ).data().toArray();
                                    // events.prepend( '<div><b>'+type+' selection</b> - '+JSON.stringify( rowData )+'</div>' );
                                })
                                .on('deselect', function (e, dt, type, indexes) {
                                    var selected_rows = d1_table.rows({ selected: true });
                                    // console.log("selected_rows", selected_rows[0])
                                    self._updateProteaseSelected(selected_rows[0]);
                                    // var rowData = d1_table.rows( indexes ).data().toArray();
                                    // events.prepend( '<div><b>'+type+' <i>de</i>selection</b> - '+JSON.stringify( rowData )+'</div>' );
                                });
                        });
                    })
                })
            })
        },
        _updateProteaseSelected: function (protease_indexes) {
            var self = this;
            var proteases_list = protease_indexes.map(function(elem){
                // console.log(self.digestsByProtease)
                return self.digestsByProtease[elem]['name']
            })
            console.log('proteases_list',proteases_list);
            this.set('proteases_selected',proteases_list)
        },
        _createPeptideMap: function (data) {
            var pepMap = {}
            data.forEach(function (el) {
                el.annotationsByCategory["pepx-virtual-annotation"].forEach(function (pep) {
                    if (!pepMap.hasOwnProperty(pep.cvTermName)) {
                        var uniqueness = pep.properties.filter(function (pp) { return pp.name === "peptide unicity" })[0].value;
                        pepMap[pep.cvTermName] = {
                            'entries': [el.uniqueName],
                            'uniqueness':  uniqueness
                        }
                    }
                    else {
                        pepMap[pep.cvTermName].entries.push(el.uniqueName);
                    }
                });
            });
            return pepMap;
        },

        _peptidesList: function () {
            console.log("Protease name :", this.proteases_selected);
            console.log("Entry name :", this.isoformAC);
            var results = this.digestsByProtease.filter(
                (a) => a.name == this.proteases_selected)[0].peptide_list;
            console.log("results", results);
            var pep_data = this._getPeptidesPosition(results);
            for (var i = 0; i < pep_data.length; i++) {
                pep_data[i]["link"]= this.peptide_mapping.hasOwnProperty(pep_data[i].position) && this.peptide_mapping[pep_data[i].position].natural ? ('See details in peptide view'.link('https://www.nextprot.org/entry/'+ this.isoformAC + '/peptides')) :  this.peptide_mapping.hasOwnProperty(pep_data[i].position) && this.peptide_mapping[pep_data[i].position].synthetic ? "See details in peptide view".link('https://www.nextprot.org/entry/'+ this.isoformAC + '/peptides'):"";
                pep_data[i]["length"] = pep_data[i].sequence.length;
                pep_data[i]["uniqueness"] = this.new_pep_map[pep_data[i].sequence].uniqueness === "UNIQUE" ? "Yes" : this.new_pep_map[pep_data[i].sequence].uniqueness === "PSEUDO_UNIQUE" ? "PSEUDO_UNIQUE" : "No";
                pep_data[i]["natural"] = this.peptide_mapping.hasOwnProperty(pep_data[i].position) && this.peptide_mapping[pep_data[i].position].natural ? "Yes" : "No";
                pep_data[i]["synthetic"] = this.peptide_mapping.hasOwnProperty(pep_data[i].position) && this.peptide_mapping[pep_data[i].position].synthetic ? "Yes" : "No";
            }
            var self = this;
            console.log("result of getpeptidePosition", pep_data);

            $.fn.dataTable.ext.search.push(
                function( settings, data, dataIndex ) {
                    var min = parseInt( $('#min').val(), 10 );
                    var max = parseInt( $('#max').val(), 10 );
                    var age = parseFloat( data[5] ) || 0; // use data for the age column
            
                    if ( ( isNaN( min ) && isNaN( max ) ) ||
                        ( isNaN( min ) && age <= max ) ||
                        ( min <= age   && isNaN( max ) ) ||
                        ( min <= age   && age <= max ) )
                    {
                        return true;
                    }
                    return false;
                }
            );
            
            $(document).ready(function() {
                var table = $('#example').DataTable();
                
                // Event listener to the two range filtering inputs to redraw on input
                $('#min, #max').keyup( function() {
                    table.draw();
                } );
            } );

            $(document).ready(function () {
                $.fn.dataTableExt.oSort["test-desc"] = function (x, y)
                    {
                        var x = parseInt(x.split('-')[0]);
                        var y = parseInt(y.split('-')[0]);
                        if ( x > y)
                        {
                            return -1;
                        }
                        return 1;
                    };
                    $.fn.dataTableExt.oSort["test-asc"] = function (x, y)
                    {
                        var x = parseInt(x.split('-')[0]);
                        var y = parseInt(y.split('-')[0]);
                        if ( x > y)
                        {
                            return 1;
                        }
                        return -1;
                    }
                for (var i = 0; i < pep_data.length; i ++) {
                    pep_data[i]["sequence_truncated"] = (pep_data[i]["sequence"].length > 22) ? pep_data[i]["sequence"].substring(0, 10) + " .. " + pep_data[i]["sequence"].substring(pep_data[i]["sequence"].length - 10) : pep_data[i]["sequence"];
                }   

                $('#table_2').DataTable({
                    dom: "<'row firstHeadTable'<'col-md-12'B>>" +
                        "<'row secondHeadTable'<'col-sm-3 col-md-4'i><'col-sm-6 pull-right'f>>" +
                        "<'row no_overmargin'<'col-sm-12 table_overflow'tr>>" +
                        "<'row no_overmargin'<'col-sm-3 col-md-2'l><'col-sm-9 pull-right pageTable'p>>",
                    buttons: [
                        'copy', 'csv', 'excel', 'pdf', 'print'
                    ],
                    data: pep_data,
                    columns: [
                        { data: 'link', title: 'Link to neXtProt', className: "uniqueClassName" },                    
                        { data: 'sequence_truncated', title:'Peptide sequence', className: "uniqueClassName"  },
                        { data: 'sequence', title:'Entire peptide sequence'}, 
                        { data: 'length', title:'Length', className: "uniqueClassName"  },
                        { data:'missed_cleavages', title: 'Missed cleavages', className: "uniqueClassName" },
                        { data: 'position', title:'Position', className: "uniqueClassName" },
                        { data: 'uniqueness', title: 'Unique without variants', className: "uniqueClassName" },
                        { data: 'natural', title: 'Natural', className: "uniqueClassName" },
                        { data: 'synthetic', title: 'Synthetic', className: "uniqueClassName" },
                    ], 
                    order :[[4,"asc"]], 
                    buttons: [
                        'copy', 'csv', 'excel', 'pdf', 'print'
                    ],
                    columnDefs: [
                        { "type": "test", targets: 4 },  
                        { "width": "20%", "targets": 1 },
                        {
                            "targets": [ 2 ],
                            "visible": false,
                            "searchable": false
                        },
                    ],
                } );
            } );  
        },
        _getPeptidesPosition: function (pep_seqs) {
            var pep_data = [];
            console.log("Isoform sequence :", this.isoform_seq);
            console.log("peptides list for 1 enzyme", pep_seqs)
            for (var pep in pep_seqs) {
                var position_first = this.isoform_seq.sequence.indexOf(pep_seqs[pep]) + 1;
                var position_last = position_first + pep_seqs[pep].length - 1;
                var peptide_position = position_first + "-" + position_last;
                pep_data.push({
                    "sequence": pep_seqs[pep],
                    "position": peptide_position,
                    "missed_cleavages": "<= " + this.maxmissedcleavages
                })
            }
            return pep_data;
        },
    });           

</script>
</dom-module>

</html>
