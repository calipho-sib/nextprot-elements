<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="../iron-icon/iron-icon.html">
<link rel="import" href="../iron-collapse/iron-collapse.html">
<link rel="import" href="../paper-spinner/paper-spinner-lite.html">
<link rel="import" href="evidence-item.html">
<link rel="import" href="quality-label.html">
<link rel="import" href="nextprot-elements-shared-styles.html">
<script>
    //Load JQuery if necessary
    if(typeof jQuery === "undefined"){
        (function(){
            var newscript = document.createElement('script');
            newscript.type = 'text/javascript';
            newscript.src = '../../jquery/dist/jquery.min.js';
            (document.getElementsByTagName('head')[0]||document.getElementsByTagName('body')[0]).appendChild(newscript);
        })();
    }
</script>
<script src="../nextprot-js/src/nextprot-core.js"></script>
<!--
`generic-annotation-section`
Annotation section used in function, medical, and expression views.

#### Example
    <generic-annotation-section section="function" categories='[ "GENERAL-ANNOTATION" ]'></generic-annotation-section>


@demo demo/generic-annotation-demo.html
-->
<dom-module id="generic-annotation-section">
    <template>
        <style include="nextprot-elements-shared-styles">
            :host {
                display: block;
            }
            #evidenceButton {
                padding: 0px 5px 0px 0px;
                margin-bottom: 10px;
            }
            #biophysicochemical-properties-section {
                border: 1px solid #E7EAEC;
                margin-top: 2em;
            }
            .xeno-label, .isoform-label {
                color: #999;
                border: 1px solid;
                border-radius: 2px;
                padding: 0px 2px;
                margin-left: 5px;
            }
            .grey-x {
                margin-bottom: 10px;
            }
        </style>
        <div class="category-main">
            <template is="dom-if" if="[[data]]">
                <button id="evidenceButton" class="btn btn-default" on-tap="_toggleAllEvidences">
                    <template is="dom-if" if="[[evidencesShown]]">
                        <iron-icon icon="arrow-drop-up"></iron-icon>
                        hide evidences
                    </template>
                    <template is="dom-if" if="[[!evidencesShown]]">
                        <iron-icon icon="arrow-drop-down"></iron-icon>
                        show evidences
                    </template>
                </button>
            </template>
            <paper-spinner-lite id="spinner" active></paper-spinner-lite>
            <template is="dom-repeat" items="[[_toArray(data)]]" as="category">
                <div class="row category-row">
                    <div class="col-xl-1 col-lg-12 col-md-12 col-sm-12 col-xs-12">
                        <h4 class="annotation-category-title"> [[category.name]]</h4>
                    </div>
                    <div id="[[_stringToId(category.name)]]-section">
                        <template is="dom-repeat" items="[[_toArray(category.value)]]" as="annotation" sort="_sort" filter="_filterGold" initial-count="10" target-framerate="1">
                            <template is="dom-if" if="[[annotation.value.newSection]]">
                                <div class="grey-x">Interactions for Isoform [[annotation.value.isoformSpecific]]</div>
                            </template>
                            <div class="row annotation-row">
                                <div class="col-xl-11 col-lg-10 col-md-9 col-sm-7 col-xs-7">
                                    <div class="annotation-title-container">
                                        <template is="dom-if" if="[[annotation.value.prefix]]">
                                            <div class="grey-x">[[annotation.value.prefix]]</div>
                                        </template>
                                        <template is="dom-if" if="[[annotation.value.chemicalName]]">
                                            <template is="dom-if" if="[[_checkIfChebi(annotation.value.database)]]">
                                                <p class="annotation-title col-lg-12 col-md-12 col-sm-12 col-xs-12" style="text-transform: capitalize">
                                                    [[annotation.value.chemicalName]]
                                                    <a href="https://www.ebi.ac.uk/chebi/searchId.do?chebiId=[[annotation.value.accession]]" class="ext-link" target="_blank">[[annotation.value.accession]]</a>
                                                    <quality-label quality="[[annotation.value.qualityQualifier]]"></quality-label>
                                                </p>
                                            </template>
                                        </template>
                                        <template is="dom-if" if="[[annotation.value.cvTermAccessionCode]]">
                                            <p class="annotation-title" inner-h-t-m-l="[[_boldPattern(annotation.value.description, 'Contributes to')]]"></p>
                                            <div class="annotation-labels">
                                                <a class="accession-code-link" href="/term/[[annotation.value.cvTermAccessionCode]]">[[annotation.value.cvTermAccessionCode]]</a>
                                                <span id="description-button-[[annotation.value.id]]" class="colored-label definition-button" on-tap="_toggle">Definition</span>
                                                <quality-label quality="[[annotation.value.qualityQualifier]]"></quality-label>
                                            </div>
                                        </template>
                                        <template is="dom-if" if="[[annotation.value.parentXref]]">
                                            <p class="annotation-title col-lg-8 col-md-8 ol-sm-8 col-xs-8">[[annotation.value.description]]</p>
                                            <div class="col-lg-4 col-md-4 col-sm-4 col-xs-4 right">
                                                <a class="accession-code-link btn btn-sm selectable" href="[[annotation.value.parentXref.resolvedUrl]]">[[annotation.value.parentXref.accession]]</a>
                                            </div>
                                        </template>
                                        <template is="dom-if" if="[[!_checkIfContainsAccessionOrXref(annotation.value)]]">
                                                <template is="dom-if" if="[[_isBiophysicochemicalProperty(annotation.value.category)]]">
                                                    <template is="dom-if" if="[[annotation.value.newBpSection]]">
                                                        <div class="grey-x">[[annotation.value.subcategory]]</div>
                                                    </template>
                                                    <div class="col-lg-2 col-md-2 col-sm-3 col-xs-4" inner-h-t-m-l="[[annotation.value.label]]"></div>
                                                    <div class="col-lg-10 col-md-10 col-sm-9 col-xs-8" inner-h-t-m-l="[[annotation.value.description]]"></div>
                                                </template>
                                            <p class="annotation-title">
                                                <template is="dom-if" if="[[!_isBinaryInteractionOrCofactorOrBiophysical(annotation.value.category)]]">
                                                    <template is="dom-if" if="[[annotation.value.isoformSpecific]]">
                                                        <span class="isoform-label">Isoform [[annotation.value.isoformSpecific]]</span>
                                                    </template>
                                                    <span inner-h-t-m-l="[[annotation.value.description]]"></span>
                                                </template>
                                                <template is="dom-if" if="[[!_isBinaryInteractionOrCofactorOrBiophysical(annotation.value.category)]]">
                                                    <quality-label quality="[[annotation.value.qualityQualifier]]"></quality-label>
                                                </template>
                                            </p>
                                            <template is="dom-if" if="[[annotation.value.selfInteraction]]">
                                                <p class="annotation-title col-lg-12 col-md-12 col-sm-12 col-xs-12">Itself</p>
                                            </template>
                                            <template is="dom-if" if="[[annotation.value.geneName]]">
                                                <p class="annotation-title col-lg-12 col-md-12 col-sm-12 col-xs-12">
                                                    <template is="dom-if" if="[[_checkIfNextprot(annotation.value.database)]]">
                                                        <a href="[[annotation.value.url]]">[[annotation.value.geneName]]</a>
                                                        <template is="dom-if" if="[[annotation.value.proteinName]]">
                                                            >> [[annotation.value.proteinName]]
                                                        </template>
                                                    </template>
                                                    <template is="dom-if" if="[[!_checkIfNextprot(annotation.value.database)]]">
                                                        [[annotation.value.geneName]] >> [[annotation.value.database]]: <a href="[[annotation.value.url]]" class="ext-link">[[annotation.value.accession]]</a>
                                                    </template>
                                                    <template is="dom-if" if="[[annotation.value.interactantIsoform]]">
                                                        <span class="isoform-label">Isoform [[annotation.value.interactantIsoform]]</span>
                                                    </template>
                                                    <template is="dom-if" if="[[annotation.value.xeno]]">
                                                        <span class="xeno-label">Xeno</span>
                                                    </template>
                                                    <quality-label quality="[[annotation.value.qualityQualifier]]"></quality-label>
                                                </p>
                                            </template>
                                        </template>
                                    </div>
                                    <iron-collapse id="description-container-[[annotation.value.id]]">
                                        <div class="well blue-well">
                                            [[annotation.value.cvTermDescription]]
                                        </div>
                                    </iron-collapse>
                                    <template is="dom-if" if="[[_countItems(annotation.value.evidences)]]">
                                        <iron-collapse id="evidences-container-[[annotation.value.id]]">
                                            <div class="evidences-container hidden-xs">
                                                <template is="dom-repeat" items="[[annotation.value.evidences]]" as="evidence">
                                                    <evidence-item data="[[evidence]]" index="[[_getIndex(index)]]"></evidence-item>
                                                </template>
                                            </div>
                                        </iron-collapse>
                                    </template>
                                </div>
                                <template is="dom-if" if="[[_countItems(annotation.value.evidences)]]">
                                    <div class="col-lg-2 col-md-3 col-sm-5 col-xs-5">
                                        <div class="show-references-button">
                                            <a id="evidences-button-[[annotation.value.id]]" class="btn" on-tap="_toggle">
                                                <p class="show-references-button-counter">[[_countItems(annotation.value.evidences)]]</p>
                                                <p class="show-references-button-label">ev</p>
                                            </a>
                                            <div class="reference-label-container">
                                                <template is="dom-repeat" items="[[annotation.value.evidenceSources]]" as="source">
                                                    <div class="reference-label">[[source]]</div>
                                                </template>
                                            </div>
                                        </div>
                                    </div>
                                </template>
                            </div>
                            <iron-collapse id="evidences-container-sm-[[annotation.value.id]]" opened>
                                <div class="evidence-container hidden-lg hidden-md">
                                    <template is="dom-repeat" items="[[annotation.value.evidences]]" as="evidence">
                                        <evidence-item data="[[evidence]]" index="[[_getIndex(index)]]"></evidence-item>
                                    </template>
                                </div>
                            </iron-collapse>
                        </template>
                    </div>
                </div>
            </template>
        </div>
    </template>

    <script>
        Polymer({
            is: 'generic-annotation-section',
            properties: {
                nxConfig: {
                    type: Object,
                    value: {}
                },
                categories: {
                    type: Array,
                    value: []
                },
                categoryTitles: {
                    type: Object,
                    value: {}
                },
                section: {
                    type: String
                },
                goldOnly: {
                    type: Boolean,
                    observer: "_getAnnotationsByView"
                },
                showEvidences: {
                    type: Boolean,
                    value: false
                },
                count: {
                    type: Number,
                    notify: true
                }
            },
            ready: function(){
                if(this.evidencesShown===undefined) this._toggleAllEvidences();
                var nx = new Nextprot.Client("neXtprot annotation loader", "Calipho Group");
                var apiCall = [];
                var self = this;
                this.categories.forEach(function(a){
                    apiCall.push(nx.getAnnotationsByCategory(self.nxConfig.entry, a))
                });
                var self = this;
                Promise.all(apiCall)
                        .then(function (categories) {
                            self.annotationsByCategory = categories;
                            self._getAnnotationsByView();
                            self.$.spinner.removeAttribute('active');
                        });//.catch(function (err) {
                            // catch any error that happened so far
                            //console.log("Argh, broken: " + err.message);
                            //console.log("Error at line : " + err.stack);
                            //self.$.spinner.removeAttribute('active');
                            //self.count = 0;
                        //});
            },
            _getAnnotationsByView: function() {
                var data_xrefs = [];
                var data_publi = [];
                var data_isoforms = [];
                var data_annot = [];
                this.count = 0;
                this.annotationsByCategory.forEach(function(d) {
                    Object.assign(data_xrefs, d.xrefs);
                    Object.assign(data_publi, d.publi);
                    Object.assign(data_isoforms, d.isoforms);
                    $.merge(data_annot, d.annot);
                });
                data = {};
                var self = this;
                bpSection = false;
                bpDepSection = false;
                data_annot.forEach(function (a) {
                    if (a.category=="cofactor") {
                        a.chemicalName = a.bioObject.properties["chemical name"] ?
                                a.bioObject.properties["chemical name"] : undefined;
                        a.prefix = "It requires the following cofactor "
                    }
                    if (a.category=="catalytic activity") a.prefix = "This protein acts as an enzyme. It is known to catalyze the following reaction";
                    if (a.category=="enzyme regulation") a.prefix = "It is regulated in the following manner";
                    if(a.category=="pathway") a.category=self._getUniqueListOfEvidenceSources(a.evidences)+" pathways";
                    if(a.category.toLowerCase()=="uniprot pathways") a.category="UNIPATHWAYS";
                    if(a.category=="subcellular location info") {
                        a.category="";
                        a.description = "<b>Note:</b> "+ a.description;}
                    if (a.category=="kinetic KM" || a.category=="kinetic note") {
                        if(a.category=="kinetic KM") a.label="K<sub>M</sub>";
                        a.category= "BIOPHYSICOCHEMICAL PROPERTIES"; a.subcategory="KINETIC PARAMETERS";
                        if(!bpSection) {a.newBpSection=true; bpSection=true;}
                    }
                    if (a.category=="pH dependence" || a.category=="temperature dependence") {
                        if(a.category=="temperature dependence") a.label="Temperature";
                        if(a.category=="pH dependence") a.label="pH";
                        a.category= "BIOPHYSICOCHEMICAL PROPERTIES"; a.subcategory="DEPENDENCE";
                        if(!bpDepSection) {a.newBpSection=true; bpDepSection=true;}
                    }
                    {}
                    if (a.category=="kinetic Vmax" ) {a.category= "BIOPHYSICOCHEMICAL PROPERTIES"; a.subcategory="KINETIC PARAMETERS"; a.label="V<sub>Max</sub>"};
                    if (a.category=="kinetic note" ) {a.category= "BIOPHYSICOCHEMICAL PROPERTIES"; a.subcategory="KINETIC PARAMETERS";};
                    if (a.category=="absorption max") {a.category= "BIOPHYSICOCHEMICAL PROPERTIES"; a.subcategory="ABSORPTION"; a.label="Abs max";}
                    if (a.category=="absorption note") {a.category= "BIOPHYSICOCHEMICAL PROPERTIES"; a.subcategory="ABSORPTION";}
                    if (a.category=="redox potential") {a.category= "BIOPHYSICOCHEMICAL PROPERTIES"; a.subcategory="REDOX POTENTIAL";}
                    if(Object.keys(self.categoryTitles).indexOf(a.category)!=-1) a.category = self.categoryTitles[a.category];
                    if (a.description) a.description= a.description.charAt(0).toUpperCase()+ self._addPubmedLink(a.description).slice(1);
                    if (a.cvTermName) a.cvTermName=a.cvTermName.charAt(0).toUpperCase()+a.cvTermName.slice(1);

                    if (a.bioObject) {
                        a.geneName=a.bioObject.properties.geneName;
                        a.proteinName=a.bioObject.properties.proteinName;
                        a.url=a.bioObject.properties.url;
                        a.database=a.bioObject.database;
                        a.accession=a.bioObject.accession;
                        if(a.bioObject.bioType=="PROTEIN_ISOFORM") {a.interactantIsoform=a.bioObject.properties.isoformName;};
                    }
                    a.selfInteraction = a.propertiesMap.selfInteraction ? a.propertiesMap.selfInteraction[0].value : false;
                    a.xeno = a.database!="neXtProt" ? true : false;
                    if (!data.hasOwnProperty(a.category)) data[a.category]=[];
                    a.evidences.forEach(function(obj){
                        if(obj.negativeEvidence==true && !a.description.startsWith("<b>Not </b>")) a.description = "<b>Not </b>"+a.description
                    });
                    if(a.annotationId===0) a.annotationId=data_annot.indexOf(a);
                    if (a.category=="overview" || a.category=="Binary Interactions") {
                        for (i in a.targetingIsoformsMap){
                            var isoform = a.targetingIsoformsMap[i];
                            if (isoform.specificity=="SPECIFIC"){
                                a.isoformSpecific = data_isoforms[isoform.isoformAccession].mainEntityName.name;
                            }
                        }
                    }
                    data[a.category].push({
                        id: a.annotationId,
                        description: a.description || a.cvTermName,
                        category: a.category.toUpperCase(),
                        subcategory: a.subcategory,
                        label: a.label || null,
                        newBpSection: a.newBpSection,
                        prefix: a.prefix,
                        cvTermAccessionCode: a.cvTermAccessionCode,
                        cvTermDescription: a.cvTermDescription,
                        selfInteraction: a.selfInteraction=="true",
                        xeno: a.xeno,
                        geneName: a.geneName,
                        proteinName: a.proteinName,
                        accession: a.accession,
                        chemicalName: a.chemicalName,
                        url: a.url,
                        database: a.database,
                        parentXref: a.parentXref,
                        evidences: a.evidences ? self._getEvidence(a.evidences, data_xrefs, data_publi) : [],
                        evidenceSources: self._getUniqueListOfEvidenceSources(a.evidences),
                        qualityQualifier: a.qualityQualifier,
                        isoformSpecific: a.isoformSpecific,
                        interactantIsoform: a.interactantIsoform
                    });
                });
                Object.keys(data).forEach(function(d){self.count+=data[d].length;});
                this.data = data;
            },
            _sort: function(a,b) {
                if (a.value.category=="OVERVIEW") this._sortOverview(a,b);
                if (a.value.category=="BIOPHYSICOCHEMICAL PROPERTIES") this._sortBiophysicochemical(a,b);
                if (a.value.category!="BINARY INTERACTIONS" && a.value.category!="ENZYMATIC ACTIVITY") return a.value.description.toLowerCase() > b.value.description.toLowerCase() ? 1 : -1;
                if (a.value.isoformSpecific && !b.value.isoformSpecific) return 1
                if (!a.value.isoformSpecific && b.value.isoformSpecific) return -1
                if (a.value.isoformSpecific && b.value.isoformSpecific && b.value.isoformSpecific===a.value.isoformSpecific){
                    if(a.value.geneName.toLowerCase() > b.value.geneName.toLowerCase()) {
                        a.value.newSection=false;
                        b.value.newSection=true;
                    } else {
                        a.value.newSection=true;
                        b.value.newSection=false;
                    }
                }
                if (a.value.isoformSpecific && b.value.isoformSpecific && a.value.isoformSpecific!==b.value.isoformSpecific){
                    a.value.newSection=true;
                    b.value.newSection=true;
                    return a.value.isoformSpecific.toLowerCase() > b.value.isoformSpecific.toLowerCase() ? 1 : -1;
                }
                if (a.value.selfInteraction) return -1;
                if (b.value.selfInteraction) return 1;
                if (a.value.geneName=="-") return 1;
                if (b.value.geneName=="-") return -1;
                if (a.value.geneName)
                return a.value.geneName.toLowerCase() > b.value.geneName.toLowerCase() ? 1 : -1;

            },
            _sortOverview: function(a,b) {
                return (a.value.isoformSpecific && !b.value.isoformSpecific) ? 1 : -1;
            },
            _sortBiophysicochemical: function(a,b) {
                if(a.value.subcategory=="ABSORPTION" && b.value.subcategory!="ABSORPTION") return -1;
                if(a.value.subcategory=="ABSORPTION" && b.value.subcategory=="ABSORPTION") {
                    if(a.value.label){
                        a.value.newBpSection=true;
                        b.value.newBpSection=false;
                        return -1;
                    }
                    a.value.newBpSection=false;
                    b.value.newBpSection=true;
                    return 1;
                }
                if(a.value.subcategory=="KINETIC PARAMETERS" && b.value.subcategory=="KINETIC PARAMETERS") {
                    if(a.value.id > b.value.id) {
                        return 1;
                    }
                    return -1;
                }
                if(a.value.subcategory=="KINETIC PARAMETERS" && b.value.subcategory=="ABSORPTION") return 1;
                if(a.value.subcategory=="KINETIC PARAMETERS" && b.value.subcategory=="DEPENDENCE") return -1;
                if(a.value.subcategory=="DEPENDENCE" && b.value.subcategory!="DEPENDENCE") {a.value.newBpSection=true; return 1;}
            },
            _filterGold: function(item){
                if (this.goldOnly) return item.value.qualityQualifier==="GOLD";
                return true;
            },
            _toggleAllEvidences: function(){
                this.async(function() {
                    this.evidencesShown=true;
                    var evidenceContainers = Polymer.dom(this.root).querySelectorAll(".evidences-container");
                    for (var e in evidenceContainers) {
                        if (this.showEvidences == true) {
                            evidenceContainers[e].parentNode.opened = true;
                        } else {
                            evidenceContainers[e].parentNode.opened = false;
                        }
                    }
                    this.evidencesShown = this.showEvidences;
                    this.showEvidences = !this.showEvidences;
                }, 1);
            },
            _getEvidence: function(ev, xrefs, publi){
                function getUrl(id){
                    if (xrefs.hasOwnProperty(id)) {
                        return xrefs[id].resolvedUrl;
                    }
                    return "";
                }
                var self = this;
                return ev.map(function(e){
                    e.assignedBy=e.assignedBy.replace('NextProt', 'neXtProt');
                    e.assignedBy=e.assignedBy.replace('Uniprot', 'UniProt');
                    e.assignedBy=e.assignedBy.replace('GO_central', 'RefGenome');
                    e.assignedBy=e.assignedBy.replace('KEGG_PTW', 'KEGG');
                    e.numberOfExperiments = e.properties ? e.properties.numberOfExperiments : undefined;
                    return {
                        "evidenceCodeName": e.evidenceCodeName,
                        "resourceAccession": e.resourceAccession,
                        "assignedBy": e.assignedBy,
                        "resourceDb": e.resourceDb,
                        "negative": e.negativeEvidence,
                        "qualityQualifier": e.qualityQualifier,
                        "numberOfExperiments": e.numberOfExperiments,
                        "url": getUrl(e.resourceId),
                        "publication": self._getPublication(publi[e.resourceId])
                    }
                })
            },
            _getPublication: function(pub){
                if(pub){
                    return {
                        publicationId: pub.publicationId,
                        localUrl: "/publications/"+pub.publicationId,
                        title: pub.title,
                        authors: pub.authors,
                        journalResourceLocator: pub.journalResourceLocator,
                        volume: pub.volume,
                        firstPage: pub.firstPage,
                        lastPage: pub.lastPage,
                        publicationYear: pub.publicationYear,
                        dbXrefs: pub.dbXrefs,
                        abstractText: pub.abstractText
                    }
                }
            },
            _getUniqueListOfEvidenceSources: function(evidenceList){
                var evidenceSourceList = [];
                evidenceList.forEach(function(evidence){
                    if (evidence.assignedBy.endsWith("_PTW")) evidence.assignedBy = evidence.assignedBy.replace("_PTW","");
                    if(evidenceSourceList.indexOf(evidence.assignedBy) < 0) {
                        evidenceSourceList.push(evidence.assignedBy);
                    }
                });
                return evidenceSourceList;
            },
            _checkIfContainsAccessionOrXref: function(annotation){
                return Boolean(annotation.cvTermAccessionCode || annotation.parentXref);
            },
            _toArray: function(obj) {
                if (typeof obj === 'object') {
                    return Object.keys(obj).map(function(key) {
                        return {
                            name: key,
                            value: obj[key]
                        };
                    });
                }
                return null;
            },
            _getIndex: function(index){
                return index+1;
            },
            _countItems: function(obj){
                return obj.length;
            },
            _toggle: function(mouseEvent){
                var srcElementId = mouseEvent.target.id || mouseEvent.target.parentNode.id;
                this.$$("#"+srcElementId.replace('button','container')).toggle();
            },
            _boldPattern: function(str, pattern){
                return str.replace(pattern, "<b>"+pattern+"</b>");
            },
            _isNewPathwayCategory: function(category, name){
                if (category=="pathway" && this.pathwayCategory!=new String(name).split('_')[0]) {
                    this.pathwayCategory = new String(name).split('_')[0];
                    return true;
                }
                return false;
            },
            _checkIfNextAnnotHasTheSameSource: function(categoryObj, index){
                var firstAnnotCat = categoryObj[index]['evidenceSources'][0];
                var secondAnnotCat = categoryObj[index+1] ?
                        categoryObj[index+1]['evidenceSources'][0] : undefined;
                return firstAnnotCat===secondAnnotCat;
            },
            _checkIfNextprot: function(databaseName){
                return databaseName.toLowerCase()==="nextprot";
            },
            _checkIfChebi: function(databaseName){
                return databaseName.toLowerCase()==="chebi";
            },
            _isBinaryInteractionOrCofactorOrBiophysical: function (category){
                return (category==="BINARY INTERACTIONS" || category==="COFACTOR" || category==="BIOPHYSICOCHEMICAL PROPERTIES");
            },
            _isBiophysicochemicalProperty: function(category){
                return category==="BIOPHYSICOCHEMICAL PROPERTIES";
            },
            _stringToId: function(str){
                return str.toLowerCase().replace(" ", "-");
            },
            _addPubmedLink: function(text){
                var pmidRegexp = /PubMed:\d{7,9}\.{0,1}\d{0,1}/g
                var matches = text.match(pmidRegexp);
                if (matches) {
                    for (var i in matches){
                        var pmid = matches[i].split(":")[1];
                        text = text.replace(
                            matches[i],
                            'PubMed: <a href="https://www.ncbi.nlm.nih.gov/pubmed/'+pmid+'" class="ext-link style-scope generic-annotation-section" target="_blank">'+pmid+'</a>'
                        );
                    }
                }
                return text;

            }
        });
    </script>
</dom-module>