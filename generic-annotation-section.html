<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="../iron-icon/iron-icon.html">
<link rel="import" href="../iron-icons/iron-icons.html">
<link rel="import" href="../iron-collapse/iron-collapse.html">
<link rel="import" href="../paper-spinner/paper-spinner-lite.html">
<link rel="import" href="evidence-item.html">
<link rel="import" href="quality-label.html">
<link rel="import" href="external-scripts.html">
<link rel="import" href="nextprot-elements-shared-styles.html">
<!--
`generic-annotation-section`
Annotation section used in function, medical, and expression views.

#### Example
    <generic-annotation-section section="function" categories='[ "GENERAL-ANNOTATION" ]'></generic-annotation-section>


@demo demo/generic-annotation-demo.html
-->
<dom-module id="generic-annotation-section">
    <template>
        <style include="nextprot-elements-shared-styles">
            :host {
                display: block;
                min-height: 35px;
            }
            .xeno-label, .isoform-label {
                color: #999;
                border: 1px solid;
                border-radius: 2px;
                padding: 0px 2px;
            }
            .front-label {
                margin-right: 5px;
            }
            .end-label {
                margin-left: 5px;
            }
            .annotation-container {
                float: left;
                display: inline;
                width: calc(100% - 175px);
            }
            .annotation-row {
                margin-right: 0px;
                margin-bottom: 0px;
            }
            .annotation-title-container > .isoform-label {
                margin-top: 3px;
            }
            .BINARY_INTERACTION {
                max-width: calc(100% - 55px);
            }
            .annotation-title > .grey-x {
                display: inline;
            }
            .evidences-button-container {
                display: inline;
                width: 175px;
            }
            .evidences-container {
                margin: 0px 200px 15px 0px;
            }
            .blue-well {
                margin: 5px 190px 10px 10px;
            }
            .right-column-header {
                display: inline;
                float: right;
                margin-right: 180px;
                text-transform: initial;
            }
            .experiments-counter {
                float: right;
                color: #999;
                font-weight: 600;
                font-size: 1.3em;
                line-height: 1.3em;
                padding-right: 30px;
            }
            @media (max-width: 1080px) {
                .evidences-container {
                    margin: 0px 25px 20px 0px;
                }
                .blue-well {
                    margin: 5px 15px 10px 10px;
                }
            }
            #evidenceButton {
                float: right;
                padding: 0px 5px 0px 0px;
            }
            #notice {
                margin: 0 0 0 5px;
            }
            #biophysicochemical-properties-section {
                border: 1px solid #E7EAEC;
                margin-top: 2em;
            }
        </style>
        <div class="category-main">
            <template is="dom-if" if="[[data]]">
                <button id="evidenceButton" class="btn btn-default" on-tap="_toggleAllEvidences">
                    <template is="dom-if" if="[[evidencesShown]]">
                        <iron-icon icon="arrow-drop-up"></iron-icon>
                        Hide evidences
                    </template>
                    <template is="dom-if" if="[[!evidencesShown]]">
                        <iron-icon icon="arrow-drop-down"></iron-icon>
                        Show evidences
                    </template>
                </button>
            </template>
            <div id="notice" class="grey-x"><i>Annotations in this section apply to all the isoforms if not specified otherwise.</i><paper-spinner-lite id="spinner" active></paper-spinner-lite></div>
            <template is="dom-repeat" items="[[_toArray(data)]]" as="category">
                <template is="dom-if" if="[[_checkCategoryLabel(category.name)]]">
                    <div class="row category-row">
                    <div>
                        <h4 class="annotation-category-title"> [[category.name]]
                            <template is="dom-if" if="[[_isProteinProteinInteraction(category)]]">
                                <div class="grey-x right-column-header">Number of IntAct expt.</div>
                            </template>
                        </h4>
                    </div>
                    <div id="[[_stringToId(category.name)]]-section">
                        <template is="dom-repeat" items="[[_toArray(category.value)]]" as="annotation" initial-count="1" target-framerate="1000">
                            <template is="dom-if" if="[[_isNewIsoformSection(category.value, index)]]">
                                <div class="grey-x">Interactions for [[annotation.value.isoformSpecific]]</div>
                            </template>
                            <div class="row annotation-row">
                                <template is="dom-if" if="[[annotation.value.prefix]]">
                                    <div class="grey-x">[[annotation.value.prefix]]</div>
                                </template>
                                <div class="annotation-container">
                                    <div class$="annotation-title-container [[annotation.value.category]]">
                                        <template is="dom-if" if="[[annotation.value.chemicalName]]">
                                            <template is="dom-if" if="[[_checkIfChebi(annotation.value.database)]]">
                                                <p class="annotation-title" style="text-transform: capitalize">
                                                    [[annotation.value.chemicalName]]
                                                    <a href="https://www.ebi.ac.uk/chebi/searchId.do?chebiId=[[annotation.value.accession]]" class="ext-link" target="_blank">[[annotation.value.accession]]</a>
                                                </p>
                                            </template>
                                        </template>
                                        <template is="dom-if" if="[[annotation.value.cvTermAccessionCode]]">
                                            <template is="dom-if" if="[[annotation.value.isoformSpecific]]">
                                                <div class="annotation-title"><span class="isoform-label front-label">[[annotation.value.isoformSpecific]]</span></div>
                                            </template>
                                            <template is="dom-if" if="[[annotation.value.matureProtein]]">
                                                <div class="annotation-title"><span class="isoform-label front-label">[[annotation.value.matureProtein]]</span></div>
                                            </template>
                                            <template is="dom-if" if="[[_checkIfSubcellularLocation(annotation.value)]]">
                                                <div class="annotation-title">
                                                    <template is="dom-if" if="[[annotation.value.conflict]]"><span class="colored-label warning-label">Conflict</span></template>
                                                    <p inner-h-t-m-l="[[annotation.value.cvTermName]]"></p>
                                                    <a class="accession-code-link" href="/term/[[annotation.value.cvTermAccessionCode]]">[[annotation.value.cvTermAccessionCodeLabel]]</a>
                                                    <span id="description-button-[[annotation.value.id]]" class="colored-label definition-button" on-tap="_toggle">Definition</span>
                                                    <template is="dom-if" if="[[annotation.value.nameModifier]]">
                                                        <p inner-h-t-m-l="[[annotation.value.nameModifier]]"></p>
                                                    </template>
                                                        <quality-label quality="[[annotation.value.qualityQualifier]]"></quality-label>
                                                </div>
                                            </template>
                                            <template is="dom-if" if="[[!_checkIfSubcellularLocation(annotation.value)]]">
                                                <div class="annotation-title">
                                                    <template is="dom-if" if="[[annotation.value.conflict]]"><span class="colored-label warning-label">Conflict</span></template>
                                                    <p inner-h-t-m-l="[[annotation.value.description]]"></p>
                                                    <div class="annotation-labels">
                                                        <template is="dom-if" if="[[!_checkIfDisease(annotation.value)]]">
                                                            <a class="accession-code-link" href="/term/[[annotation.value.cvTermAccessionCode]]">[[annotation.value.cvTermAccessionCodeLabel]]</a>
                                                            <span id="description-button-[[annotation.value.id]]" class="colored-label definition-button" on-tap="_toggle">Definition</span>
                                                        </template>
                                                        <quality-label quality="[[annotation.value.qualityQualifier]]"></quality-label>
                                                    </div>
                                                </div>
                                            </template>
                                        </template>
                                        <template is="dom-if" if="[[annotation.value.parentXref]]">
                                            <div class="annotation-title">
                                                <template is="dom-if" if="[[annotation.value.conflict]]"><span class="colored-label warning-label">Conflict</span></template>
                                                <p>[[annotation.value.description]]</p>
                                                <div class="annotation-labels">
                                                    <a class="accession-code-link ext-link selectable" href="[[annotation.value.parentXref.resolvedUrl]]" target="_blank">[[annotation.value.parentXref.accession]]</a>
                                                    <quality-label quality="[[annotation.value.qualityQualifier]]"></quality-label>
                                                </div>
                                            </div>
                                        </template>
                                        <template is="dom-if" if="[[!_checkIfContainsAccessionOrXref(annotation.value)]]">
                                            <template is="dom-if" if="[[_isBiophysicochemicalProperty(annotation.value.category)]]">
                                                <template is="dom-if" if="[[_isNewSubcategory(category.value, index)]]">
                                                    <div class="grey-x">[[annotation.value.subcategory]]</div>
                                                </template>
                                                <div class="col-lg-2 col-md-2 col-sm-3 col-xs-4" inner-h-t-m-l="[[annotation.value.label]]"></div>
                                                <div class="col-lg-10 col-md-10 col-sm-9 col-xs-8" inner-h-t-m-l="[[annotation.value.description]]"></div>
                                            </template>
                                            <p class="annotation-title justify">
                                                <template is="dom-if" if="[[!_isBinaryInteractionOrBiophysical(annotation.value.category)]]">
                                                    <template is="dom-if" if="[[annotation.value.isoformSpecific]]">
                                                        <span class="isoform-label front-label">[[annotation.value.isoformSpecific]]</span>
                                                    </template>
                                                    <template is="dom-if" if="[[annotation.value.matureProtein]]">
                                                        <span class="isoform-label front-label">[[annotation.value.matureProtein]]</span>
                                                    </template>
                                                    <span inner-h-t-m-l="[[annotation.value.description]]"></span>
                                                    <quality-label quality="[[annotation.value.qualityQualifier]]"></quality-label>
                                                </template>
                                            </p>
                                            <template is="dom-if" if="[[annotation.value.selfInteraction]]">
                                                <p class="annotation-title">Itself <quality-label quality="[[annotation.value.qualityQualifier]]"></quality-label></p>
                                            </template>
                                            <template is="dom-if" if="[[!annotation.value.selfInteraction]]">
                                                <template is="dom-if" if="[[annotation.value.geneName]]">
                                                    <p class="annotation-title">
                                                        <template is="dom-if" if="[[annotation.value.conflict]]"><span class="colored-label warning-label">Conflict</span></template>
                                                        <template is="dom-if" if="[[_checkIfNextprot(annotation.value.database)]]">
                                                            <a href="[[annotation.value.url]]">[[annotation.value.geneName]]</a>
                                                            <template is="dom-if" if="[[annotation.value.proteinName]]">
                                                                → [[annotation.value.proteinName]]
                                                            </template>
                                                        </template>
                                                        <template is="dom-if" if="[[!_checkIfNextprot(annotation.value.database)]]">
                                                            [[annotation.value.geneName]] → [[annotation.value.database]]: <a href="[[annotation.value.url]]" class="ext-link" target="_blank">[[annotation.value.accession]]</a>
                                                        </template>
                                                        <template is="dom-if" if="[[annotation.value.interactantIsoform]]">
                                                            <span class="annotation-title isoform-label end-label">Isoform [[annotation.value.interactantIsoform]]</span>
                                                        </template>
                                                        <template is="dom-if" if="[[annotation.value.xeno]]">
                                                            <span class="xeno-label end-label">Xeno</span>
                                                        </template>
                                                        <quality-label quality="[[annotation.value.qualityQualifier]]"></quality-label>
                                                    </p>
                                                </template>
                                            </template>
                                        </template>
                                    </div>
                                    <template is="dom-repeat" items="[[annotation.value.additionalInfo]]" as="additionalInfo">
                                        <div class="row additional-info annotation-title"><div class="grey-x">[[additionalInfo.name]]</div> » [[additionalInfo.value]]
                                        <a class="accession-code-link" href="/term/[[additionalInfo.accession]]">[[additionalInfo.accession]]</a></div>
                                    </template>
                                    <div class="experiments-counter">[[annotation.value.numberOfExperiments]]</div>
                                </div>
                                <template is="dom-if" if="[[!_isPathwayOrTcdb(annotation.value.category)]]">
                                    <template is="dom-if" if="[[_countItems(annotation.value.evidences)]]">
                                        <div class="evidences-button-container">
                                            <div class="show-references-button">
                                                <a id="evidences-button-[[annotation.value.id]]" class="btn" on-tap="_toggle">
                                                    <p class="show-references-button-counter">[[_countItems(annotation.value.evidences)]]</p>
                                                    <p class="show-references-button-label">ev</p>
                                                </a>
                                                <div class="reference-label-container">
                                                    <template is="dom-repeat" items="[[annotation.value.evidenceSources]]" as="source">
                                                        <div class="reference-label">[[source]]</div>
                                                    </template>
                                                </div>
                                            </div>
                                        </div>
                                    </template>
                                </template>
                            </div>
                            <iron-collapse id="description-container-[[annotation.value.id]]">
                                <div class="well blue-well">
                                    [[annotation.value.cvTermDescription]]
                                </div>
                            </iron-collapse>
                            <template is="dom-if" if="[[!_isPathwayOrTcdb(annotation.value.category)]]">
                                <template is="dom-if" if="[[_countItems(annotation.value.evidences)]]">
                                    <iron-collapse id="evidences-container-[[annotation.value.id]]">
                                        <div class="evidences-container">
                                            <template is="dom-repeat" items="[[annotation.value.evidences]]" as="evidence">
                                                <evidence-item data="[[evidence]]" index="[[_getIndex(index)]]"></evidence-item>
                                            </template>
                                        </div>
                                    </iron-collapse>
                                </template>
                            </template>
                        </template>
                    </div>
                </div>
                </template>
            </template>
        </div>
    </template>

    <script>
        Polymer({
            is: 'generic-annotation-section',
            properties: {
                nxConfig: {
                    type: Object,
                    value: {}
                },
                categories: {
                    type: Array,
                    value: []
                },
                categoryTitles: {
                    type: Object,
                    value: {}
                },
                annotationsByCategory: {
                    type: Array,
                    value: []
                },
                section: {
                    type: String
                },
                goldOnly: {
                    type: Boolean,
                    observer: "_getAnnotationsByView"
                },
                showEvidences: {
                    type: Boolean,
                    value: false
                },
                count: {
                    type: Number,
                    notify: true
                },
                isoform: {
                    type: String,
                    observer: "_reloadIsoform"
                }
            },
            ready: function(){
                if(this.evidencesShown===undefined) this._toggleAllEvidences();
                Polymer.RenderStatus.afterNextRender(this, function() {
                    var nx = new Nextprot.Client("neXtprot annotation loader", "Calipho Group");
                    if (this.nxConfig.env) nx.updateEnvironment(this.nxConfig.env);
                    var apiCall = [];
                    for (var i in this.categories) {
                        if (typeof this.categories[i]==="object") apiCall.push(nx.getAnnotationsByCategory(this.nxConfig.entry, this.categories[i][0], this.categories[i][1]));
                        else apiCall.push(nx.getAnnotationsByCategory(this.nxConfig.entry, this.categories[i]));
                    }
                    var self = this;
                    Promise.all(apiCall)
                            .then(function (categories) {
                                self.annotationsByCategory = categories;
                                self._getAnnotationsByView();
                                self.$.spinner.removeAttribute('active');
                            }).catch(function (err) {
                                // catch any error that happened so far
                                console.log("Argh, broken: " + err.message);
                                console.log("Error at line : " + err.stack);
                                self.$.spinner.removeAttribute('active');
                                self.count = 0;
                            });
                });
            },
            _reloadIsoform: function(){
                if(this.count) this._getAnnotationsByView();
            },
            _getAnnotationsByView: function() {
                var data_xrefs = [];
                var data_publi = [];
                var data_isoforms = [];
                var data_annot = [];
                var count = 0;
                this.containsGoldEv = {};
                for(var i in this.annotationsByCategory) {
                    if (this.annotationsByCategory[i].childrenOfCvTerm) {
                        for(var j in this.annotationsByCategory[i].annot)
                            this.annotationsByCategory[i].annot[j].apicategory=this.annotationsByCategory[i].childrenOfCvTerm;
                    }
                    Object.assign(data_xrefs, this.annotationsByCategory[i].xrefs);
                    Object.assign(data_publi, this.annotationsByCategory[i].publi);
                    Object.assign(data_isoforms, this.annotationsByCategory[i].isoforms);
                    $.merge(data_annot, this.annotationsByCategory[i].annot);
                };
                data = {};
                var self = this;
                var annotCategoryList = [];
                for (var v in this._objectValues(data_annot)) annotCategoryList.push(data_annot[v].apicategory);
                annotCategoryCount = annotCategoryList.reduce( function (prev, item) {
                    if ( item in prev ) prev[item] ++;
                    else prev[item] = 1;
                    return prev;
                }, {} );
                for (var i in data_annot) {
                    var a = data_annot[i];
                    if (this.section==="function"){
                        if (a.apicategory==="GO_MOLECULAR_FUNCTION" && a.cvTermAccessionCode=="GO:0003674") continue;
                        if (a.apicategory==="GO_BIOLOGICAL_PROCESS" && a.cvTermAccessionCode=="GO:0008150") continue;
                        if (a.apicategory==="GO_CELLULAR_COMPONENT" && a.cvTermAccessionCode=="GO:0005575") continue;
                        if (a.apicategory==="CAUTION" && a.description=="Product of a dubious CDS prediction.") continue;
                        if (a.apicategory==="CAUTION" && a.description=="Product of a dubious gene prediction.") continue;
                        if (a.apicategory==="CAUTION" && a.description=="Could be the product of a pseudogene.") continue;
                        if (a.apicategory==="CAUTION" && a.description.startsWith("It is uncertain whether Met")) continue;
                        if (a.apicategory==="MISCELLANEOUS" && a.description.toLowerCase().match(/.*antibod.*/)) continue;
                        if (a.apicategory==="MISCELLANEOUS" && a.description.toLowerCase().match(/.*antigen.*/)) continue;
                        if (a.apicategory==="MISCELLANEOUS" && a.description.toLowerCase().match(/.*\sbind.*/)) continue;
                        if (a.apicategory==="MISCELLANEOUS" && a.description.toLowerCase().match(/^bind.*/)) continue;
                    } else if (this.section==="medical") {
                        if (a.apicategory==="DISEASE") a.description = this._parseDiseaseDescription(a);
                        if (a.apicategory==="MISCELLANEOUS"
                            && !(a.description.toLowerCase().match(/.*antibod.*/)
                            || a.description.toLowerCase().match(/.*antigen.*/)
                            || a.description.toLowerCase().match(/.*yamanaka factors.*/)
                            || a.description.toLowerCase().match(/.*assess cell proliferation.*/)
                            || a.description.toLowerCase().match(/.*potential pharmaceutical target.*/)
                            || a.description.toLowerCase().match(/.*diagnostic marker.*/))) continue;
                    } else if (this.section==="interactions"){
                        if (a.apicategory==="MISCELLANEOUS" && !(a.description.toLowerCase().match(/.*bind.*/) || a.description.toLowerCase().match(/^bind.*/))) continue;
                    }
                    if (a.cvTermAccessionCode && a.apicategory==="CATALYTIC_ACTIVITY") a.cvTermAccessionCodeLabel="EC "+a.cvTermAccessionCode;
                    else if (a.cvTermAccessionCode) a.cvTermAccessionCodeLabel=a.cvTermAccessionCode;
                    if (a.properties) {
                        for (var j in a.properties) if(a.properties[j].name==="rank") a.rank=a.properties[j].value;
                    }
                    if (a.apicategory==="COFACTOR") {
                        a.chemicalName = a.bioObject.properties["chemical name"] ?
                                a.bioObject.properties["chemical name"] : undefined;
                        if(this.section==="function") {
                            if (a.rank==1 &&  annotCategoryCount["COFACTOR"]>1) a.prefix = "It requires the following cofactors "
                            else if (a.rank==1) a.prefix = "It requires the following cofactor "
                            a.rank = 100+ a.rank;
                        }
                    }
                    if (a.apicategory==="COFACTOR_INFO" && this.section==="function") a.rank=200 + a.rank;
                    if (a.apicategory==="CATALYTIC_ACTIVITY" && a.rank==1 && annotCategoryCount["CATALYTIC_ACTIVITY"]>1) a.prefix = "This protein acts as an enzyme. It is known to catalyze the following reactions";
                    else if (a.apicategory=="CATALYTIC_ACTIVITY" && a.rank==1) a.prefix = "This protein acts as an enzyme. It is known to catalyze the following reaction";
                    if (a.apicategory==="ENZYME_REGULATION") {
                        if (a.rank==1 &&  annotCategoryCount["ENZYME_REGULATION"]>1) a.prefix = "It is regulated in the following manners "
                        if (a.rank==1) a.prefix = "It is regulated in the following manner";
                        a.rank = 200+ a.rank;
                    }
                    if(a.apicategory==="PATHWAY") a.apicategory=self._getUniqueListOfEvidenceSources(a.evidences)+" pathways";
                    if(a.apicategory==="UNIPROT_PATHWAYS") a.categoryLabel="UNIPATHWAYS";
                    if(a.apicategory==="SUBCELLULAR_LOCATION") {
                        a.additionalInfo = [];
                        for (var j in a.properties) {
                            if (a.properties[j].name==="long-name") a.cvTermName = a.properties[j].value;
                            if (a.properties[j].name==="name-modifier") a.nameModifier = a.properties[j].value;
                            if (["topology", "orientation"].indexOf(a.properties[j].name)!==-1) {
                                a.additionalInfo.push({
                                    name: a.properties[j].name.toUpperCase(),
                                    value: a.properties[j].value,
                                    accession: a.properties[j].accession});
                            }
                        }
                        a.additionalInfo = a.additionalInfo.sort(this._sortAdditionalInfo);
                    }
                    if(a.apicategory==="SUBCELLULAR_LOCATION_NOTE") {
                        a.categoryLabel="";
                        if(!a.description.startsWith("<b>Note:</b>")) a.description = "<b>Note:</b> "+ a.description;
                    }
                    if (["KINETIC_KM", "KINETIC_VMAX", "KINETIC_NOTE"].indexOf(a.apicategory)!==-1) {
                        if(a.apicategory==="KINETIC_KM") a.label="K<sub>M</sub>";
                        if(a.apicategory==="KINETIC_VMAX") a.label="V<sub>max</sub>";
                        a.categoryLabel= "BIOPHYSICOCHEMICAL PROPERTIES";
                        a.apicategory= "BIOPHYSICOCHEMICAL PROPERTIES";
                        a.subcategory="KINETIC PARAMETERS";
                    }
                    if (["PH_DEPENDENCE", "TEMPERATURE_DEPENDENCE"].indexOf(a.apicategory)!==-1) {
                        if(a.apicategory==="TEMPERATURE_DEPENDENCE") a.label="Temperature";
                        if(a.apicategory==="PH_DEPENDENCE") a.label="pH";
                        a.categoryLabel = "BIOPHYSICOCHEMICAL PROPERTIES";
                        a.apicategory= "BIOPHYSICOCHEMICAL PROPERTIES";
                        a.subcategory="DEPENDENCE";
                    }
                    if (["ABSORPTION_MAX", "ABSORPTION_NOTE"].indexOf(a.apicategory)!==-1) {
                        if (a.apicategory=="ABSORPTION_MAX") a.label="&lambda;<sub>max</sub>";
                        a.categoryLabel = "BIOPHYSICOCHEMICAL PROPERTIES";
                        a.apicategory= "BIOPHYSICOCHEMICAL PROPERTIES";
                        a.subcategory="ABSORPTION";
                    }
                    if (a.apicategory=="REDOX_POTENTIAL") {
                        a.categoryLabel = "BIOPHYSICOCHEMICAL PROPERTIES";
                        a.apicategory= "BIOPHYSICOCHEMICAL PROPERTIES";
                        a.subcategory="REDOX POTENTIAL";
                    }
                    if(Object.keys(self.categoryTitles).indexOf(a.apicategory)!=-1) a.categoryLabel = self.categoryTitles[a.apicategory];
                    else a.cateogryLabel = a.category.toUpperCase();
                    dontCapitalize = ["mRNA", "tRNA", "rRNA", "dsDNA", "ssDNA", "siRNA", "snRNA", "ssRNA", "tmRNA",
                    "dAMP", "dADP", "dATP", "dCMP", "dCDP", "dCTP", "dGMP", "dGDP", "dGTP",
                    "dTMP", "dTDP", "dTTP", "cAMP", "cGMP", "hnRNP", "snRNP", "bZIP", "cTAGE", "eIF", "mTERF"]
                    if (a.description && dontCapitalize.indexOf(a.description.split(" ")[0])===-1) a.description= a.description.charAt(0).toUpperCase()+ self._addPubmedLink(a.description).slice(1);
                    if (a.cvTermName && dontCapitalize.indexOf(a.cvTermName.split(" ")[0])===-1) a.cvTermName=a.cvTermName.charAt(0).toUpperCase()+a.cvTermName.slice(1);
                    if (a.apicategory==="TRANSPORT_ACTIVITY") a.categoryLabel = "TCDB TRANSPORT CLASSIFICATION";
                    if (a.bioObject) {
                        a.geneName=a.bioObject.properties.geneName;
                        a.proteinName=a.bioObject.properties.proteinName;
                        a.url=a.bioObject.properties.url;
                        a.database=a.bioObject.database;
                        a.accession=a.bioObject.accession;
                        if(a.bioObject.bioType=="PROTEIN_ISOFORM") {a.interactantIsoform=a.bioObject.properties.isoformName;};
                    }
                    a.selfInteraction = a.propertiesMap.selfInteraction ? a.propertiesMap.selfInteraction[0].value : false;
                    a.matureProtein = a.propertiesMap["mature protein"] ? a.propertiesMap["mature protein"][0].value : false;
                    a.xeno = a.database!="neXtProt" ? true : false;
                    if(!a.categoryLabel) a.categoryLabel = a.apicategory.replace(/_/g, " ");
                    if (!data.hasOwnProperty(a.categoryLabel)) data[a.categoryLabel]=[];
                    var evidences = self._getEvidence(a.evidences, data_xrefs, data_publi);
                    for (var e in evidences) if(e>0 && evidences[e].negative!==evidences[e-1].negative) {
                        a.conflict = true;
                        continue;
                    }
                    for(var j in a.evidences){
                        if(a.evidences[j].goQualifier==="contributes_to" && a.description && !a.description.startsWith("<i>Contributes to</i>&nbsp;")) a.description = a.description.replace("Contributes to ", "<i>Contributes to</i>&nbsp;");
                        if(a.evidences[j].goQualifier==="colocalizes_with" && a.description && !a.description.startsWith("<i>Colocalizes with</i>&nbsp;")) a.description = a.description.replace("Colocalizes with ", "<i>Colocalizes with</i>&nbsp;");
                        if(a.evidences[j].negativeEvidence==true && !a.conflict) {
                            if(a.description && !a.description.startsWith("<b>Not</b>")) a.description = "<b>Not</b>&nbsp;"+a.description.charAt(0).toLowerCase()+a.description.slice(1);
                            if(a.cvTermName && !a.cvTermName.startsWith("<b>Not</b>")) a.cvTermName = "<b>Not</b>&nbsp;"+a.cvTermName.charAt(0).toLowerCase()+a.cvTermName.slice(1);
                        };
                    };
                    if(a.annotationId===0) a.annotationId=data_annot.indexOf(a);
                    if(a.isoformsDisplayedAsSpecific){
                        if(a.isoformsDisplayedAsSpecific.length>1) for(var iso in a.isoformsDisplayedAsSpecific) {
                            if(!a.isoformSpecific) a.isoformSpecific = "Isoforms "+data_isoforms[a.isoformsDisplayedAsSpecific[iso]].mainEntityName.name;
                            else if(!a.isoformSpecific.match(data_isoforms[a.isoformsDisplayedAsSpecific[iso]].mainEntityName.name)) a.isoformSpecific = a.isoformSpecific+", "+data_isoforms[a.isoformsDisplayedAsSpecific[iso]].mainEntityName.name;
                        }
                        else if (a.isoformsDisplayedAsSpecific.length===1) a.isoformSpecific = "Isoform "+ data_isoforms[a.isoformsDisplayedAsSpecific[0]].mainEntityName.name;
                    }
                    if (a.apicategory=="BINARY_INTERACTION") {
                        for (var e in evidences) {
                            if (evidences[e].numberOfExperiments) {
                                a.numberOfExperiments = evidences[e].numberOfExperiments;
                                continue;
                            }
                        }
                    }
                    if (a.qualityQualifier==="GOLD") this.containsGoldEv[a.categoryLabel] = true;
                    data[a.categoryLabel].push({
                        id: a.annotationId,
                        description: a.description || a.cvTermName,
                        category: a.apicategory,
                        subcategory: a.subcategory,
                        label: a.label || null,
                        prefix: a.prefix,
                        cvTermAccessionCode: a.cvTermAccessionCode,
                        cvTermAccessionCodeLabel: a.cvTermAccessionCodeLabel,
                        cvTermName: a.cvTermName,
                        nameModifier: a.nameModifier,
                        additionalInfo: a.additionalInfo,
                        cvTermDescription: a.cvTermDescription,
                        selfInteraction: a.selfInteraction=="true",
                        matureProtein: a.matureProtein,
                        rank: a.rank,
                        xeno: a.xeno,
                        geneName: a.geneName,
                        proteinName: a.proteinName,
                        accession: a.accession,
                        chemicalName: a.chemicalName,
                        url: a.url,
                        database: a.database,
                        parentXref: a.parentXref,
                        evidences: evidences,
                        conflict: a.conflict,
                        evidenceSources: self._getUniqueListOfEvidenceSources(a.evidences),
                        qualityQualifier: a.qualityQualifier,
                        isoformSpecific: a.isoformSpecific,
                        isoformAccession: a.isoformAccession,
                        interactantIsoform: a.interactantIsoform,
                        numberOfExperiments: a.numberOfExperiments
                    });
                }
                for (var i in Object.keys(data)) {
                    var category = Object.keys(data)[i];
                    if (["ENZYMATIC ACTIVITY", "PROTEIN-COFACTOR INTERACTION", "COFACTOR", "NOTE", "CAUTION", "OVERVIEW"].indexOf(category.toUpperCase())!==-1) data[category] = data[Object.keys(data)[i]].filter(this._filter.bind(this)).sort(this._sortByRank);
                    else if (category==="INTERACTIONS") data[category] = data[Object.keys(data)[i]].filter(this._filter.bind(this)).sort(this._sortOverview);
                    else if (category==="SUBCELLULAR LOCATION") data[category] = data[Object.keys(data)[i]].filter(this._filter.bind(this)).sort(this._sortSubcellular);
                    else if (category==="BIOPHYSICOCHEMICAL PROPERTIES") data[category] = data[Object.keys(data)[i]].filter(this._filter.bind(this)).sort(this._sortBiophysicochemical);
                    else if (category==="PROTEIN-PROTEIN INTERACTION") data[category] = data[Object.keys(data)[i]].filter(this._filter.bind(this)).sort(this._sortBinaryInteractions);
                    else if (category==="DISEASE") data[category] = data[Object.keys(data)[i]].filter(this._filter.bind(this)).sort(this._sortDisease.bind(this));
                    else data[category] = data[Object.keys(data)[i]].filter(this._filter.bind(this)).sort(this._sortAlphabetically);
                    count+=data[Object.keys(data)[i]].length;
                }
                this.data = data;
                this.count = count;
                if(this.$$("#evidenceButton") && this.goldOnly && !Object.keys(this.containsGoldEv).length) {
                    this.$$("#evidenceButton").style.display = "none";
                    this.$$("#notice").innerHTML = "<i>The entry does not contain gold annotations.</i>";
                }
                else if(this.$$("#evidenceButton")) {
                    this.$$("#evidenceButton").style.display = "block";
                    this.$$("#notice").innerHTML = "<i>Annotations in this section apply to all the isoforms if not specified otherwise.</i>";
                }
            },
            _sortAlphabetically: function(a,b) {
                if(a.isoformSpecific && !b.isoformSpecific) return 1;
                else if(!a.isoformSpecific && b.isoformSpecific) return -1;
                if(a.description.startsWith("<b>") || b.description.startsWith("<b>") || a.description.startsWith("<i>") || b.description.startsWith("<i>"))
                    return a.description.replace("<i>Contributes to</i> ","").replace("<b>Not</b> ","").replace("<i>Colocalizes with</i>&nbsp;","").toLowerCase()
                    > b.description.replace("<i>Contributes to</i> ","").replace("<b>Not</b> ","").replace("<i>Colocalizes with</i>&nbsp;","").toLowerCase() ? 1 : -1;
                return a.description.toLowerCase() > b.description.toLowerCase() ? 1 : -1;
            },
            _sortByRank: function(a,b) {
                return parseInt(a.rank) > parseInt(b.rank) ? 1 : -1;
            },
            _sortOverview: function(a,b){
                return (a.isoformSpecific && !b.isoformSpecific)?1:-1;
            },
            _sortSubcellular: function(a,b){
                if(a.category==="SUBCELLULAR_LOCATION_NOTE" && b.category==="SUBCELLULAR_LOCATION_NOTE") return parseInt(a.rank) > parseInt(b.rank) ? 1 : -1;
                else if(a.category==="SUBCELLULAR_LOCATION" && b.category==="SUBCELLULAR_LOCATION") {
                    if(a.isoformSpecific && !b.isoformSpecific) return 1;
                    else if(!a.isoformSpecific && b.isoformSpecific) return -1;
                    else if(a.isoformSpecific && b.isoformSpecific) {
                        if (a.isoformSpecific!==b.isoformSpecific) return parseInt(a.rank) > parseInt(b.rank) ? 1 : -1;
                        else return a.description.toLowerCase() > b.description.toLowerCase() ? 1 : -1;
                    }
                    else if(a.evidenceSources.indexOf("HPA subcell")!==-1 && b.evidenceSources.indexOf("HPA subcell")===-1) return -1;
                    else if(a.evidenceSources.indexOf("HPA subcell")===-1 && b.evidenceSources.indexOf("HPA subcell")!==-1) return 1;
                    else if(a.evidenceSources.indexOf("HPA subcell")!==-1 && b.evidenceSources.indexOf("HPA subcell")!==-1) {
                        if (a.description.indexOf("Main location.")!==-1) return -1;
                        else if (b.description.indexOf("Main location.")!==-1) return 1;
                        else if (a.description.indexOf("Main location.")!==-1 && b.description.indexOf("Main location.")===-1) return -1;
                        else if (a.description.indexOf("Main location.")===-1 && b.description.indexOf("Main location.")!==-1) return 1;
                        else a.cvTermName.toLowerCase() > b.cvTermName.toLowerCase() ? 1 : -1;
                    }
                    return a.cvTermName.toLowerCase() > b.cvTermName.toLowerCase() ? 1 : -1;
                }
                else if(a.category==="SUBCELLULAR_LOCATION_NOTE" && b.category==="SUBCELLULAR_LOCATION") return 1;
                else if(b.category==="SUBCELLULAR_LOCATION_NOTE" && a.category==="SUBCELLULAR_LOCATION") return -1;
            },
            _sortBiophysicochemical: function(a,b) {
                if(a.subcategory=="ABSORPTION" && b.subcategory!="ABSORPTION") return -1;
                if(a.subcategory=="ABSORPTION" && b.subcategory=="ABSORPTION") {
                    if(a.label){
                        return -1;
                    }
                    return 1;
                }
                if(a.subcategory=="KINETIC PARAMETERS" && b.subcategory=="KINETIC PARAMETERS") {
                    if(a.label == "K<sub>M</sub>" && b.label == "K<sub>M</sub>") {
                        return (a.description.toLowerCase().split("for ")[1] > b.description.toLowerCase().split("for ")[1]) ? 1: -1;
                    }
                    if(a.label == "V<sub>max</sub>" && b.label == "V<sub>max</sub>") {
                        return (a.description.toLowerCase().split("enzyme ")[1] > b.description.toLowerCase().split("enzyme ")[1]) ? 1: -1;
                    }
                    if(a.label == "K<sub>M</sub>" && b.label == "V<sub>max</sub>") return -1;
                    if(a.label == "V<sub>max</sub>" && b.label == "K<sub>M</sub>") return 1;
                    if(a.id > b.id) {
                        return 1;
                    }
                    return -1;
                }
                if(a.subcategory==="KINETIC PARAMETERS" && b.subcategory==="ABSORPTION") return 1;
                if(a.subcategory==="KINETIC PARAMETERS" && b.subcategory==="DEPENDENCE") return -1;
                if(a.subcategory=="DEPENDENCE" && b.subcategory!="DEPENDENCE") return 1;
                if(a.subcategory==="DEPENDENCE" && b.subcategory==="DEPENDENCE" && b.label==="pH") return 1;
            },
            _sortBinaryInteractions: function(a,b){
                if (a.isoformSpecific && !b.isoformSpecific) return 1
                if (!a.isoformSpecific && b.isoformSpecific) return -1
                if (a.isoformSpecific && b.isoformSpecific && a.isoformSpecific!==b.isoformSpecific) return a.isoformSpecific.toLowerCase() > b.isoformSpecific.toLowerCase() ? 1 : -1;
                if (a.selfInteraction) return -1;
                if (b.selfInteraction) return 1;
                if (a.geneName=="-") return 1;
                if (b.geneName=="-") return -1;
                if (a.geneName)
                    return a.geneName.toLowerCase() > b.geneName.toLowerCase() ? 1 : -1;
            },
            _sortDisease: function(a,b){
                if (a.evidenceSources.indexOf("UniProt")===-1 && b.evidenceSources.indexOf("UniProt")!==-1) return 1;
                if (a.evidenceSources.indexOf("UniProt")!==-1 && b.evidenceSources.indexOf("UniProt")===-1) return -1;
                if (a.evidenceSources.indexOf("UniProt")!==-1 && b.evidenceSources.indexOf("UniProt")!==-1) return this._sortByRank(a,b);
                else return this._sortAlphabetically(a,b);
            },
            _sortAdditionalInfo: function(a,b){
                console.log(a);
                return (a.name!=="TOPOLOGY" && b.name==="TOPOLOGY")? 1 : -1;
            },
            _filter: function(item){
                return (this._filterGold(item) && this._filterIsoform(item));
            },
            _filterGold: function(item){
                if (this.goldOnly) return item.qualityQualifier==="GOLD";
                return true;
            },
            _filterIsoform: function(item){
                if (this.isoform && this.isoform!=="all") return (item.isoformAccession===this.isoform || !item.isoformSpecific);
                return true;
            },
            _toggleAllEvidences: function(){
                this.async(function() {
                    this.evidencesShown=true;
                    var evidenceContainers = Polymer.dom(this.root).querySelectorAll(".evidences-container");
                    for (var e in evidenceContainers) {
                        if (this.showEvidences == true) {
                            evidenceContainers[e].parentNode.opened = true;
                        } else {
                            evidenceContainers[e].parentNode.opened = false;
                        }
                    }
                    this.evidencesShown = this.showEvidences;
                    this.showEvidences = !this.showEvidences;
                }, 1);
            },
            _getEvidence: function(ev, xrefs, publi){
                function getUrl(id){
                    if (xrefs.hasOwnProperty(id)) {
                        return xrefs[id].resolvedUrl;
                    }
                    return "";
                }
                var self = this;
                return ev.map(function(e){
                    if (e.goAssignedBy) e.assignedBy = e.goAssignedBy;
                    if (e.assignedBy==="NextProt") e.assignedBy="neXtProt";
                    if (e.assignedBy==="Uniprot") e.assignedBy="UniProt";
                    if (e.assignedBy==="Human protein atlas subcellular localization") e.assignedBy="HPA subcell";
                    if (e.assignedBy==="Alzheimers_University_of_Toronto") e.assignedBy="Alzheimers UoT";
                    if (e.assignedBy.endsWith("_PTW")) e.assignedBy = e.assignedBy.replace("_PTW","");
                    e.numberOfExperiments = e.properties ? e.properties.numberOfExperiments : undefined;
                    return {
                        "evidenceCodeName": e.evidenceCodeName,
                        "resourceAccession": e.resourceAccession,
                        "assignedBy": e.assignedBy,
                        "resourceDb": e.resourceDb,
                        "negative": e.negativeEvidence,
                        "qualityQualifier": e.qualityQualifier,
                        "numberOfExperiments": e.numberOfExperiments,
                        "url": getUrl(e.resourceId),
                        "publication": self._getPublication(publi[e.resourceId])
                    }
                })
            },
            _getPublication: function(pub){
                if(pub){
                    return {
                        publicationId: pub.publicationId,
                        localUrl: "/publications/"+pub.publicationId,
                        title: pub.title,
                        authors: pub.authors,
                        journalResourceLocator: pub.journalResourceLocator,
                        volume: pub.volume,
                        firstPage: pub.firstPage,
                        lastPage: pub.lastPage,
                        publicationYear: pub.publicationYear,
                        dbXrefs: pub.dbXrefs,
                        abstractText: pub.abstractText
                    }
                }
            },
            _getUniqueListOfEvidenceSources: function(evidenceList){
                var evidenceSourceList = [];
                for (var i in evidenceList){
                    if(evidenceSourceList.indexOf(evidenceList[i].assignedBy) < 0) {
                        evidenceSourceList.push(evidenceList[i].assignedBy);
                    }
                }
                return evidenceSourceList;
            },
            _parseDiseaseDescription: function(annotation){
                uniprotDiseaseRegExMatch = /.*[MIM:[0-9]*]/g.exec(annotation.description);
                if(uniprotDiseaseRegExMatch) {
                    uniprotDiseaseString = uniprotDiseaseRegExMatch[0];
                    cvTermShortRegExMatch = /\([A-Za-z0-9 -+/()]*\)/g.exec(uniprotDiseaseString);
                    if (cvTermShortRegExMatch) {
                        cvTermShort = cvTermShortRegExMatch[0].slice(1,cvTermShortRegExMatch[0].length-1);
                        cvTermLink = "<a href=\"/term/"+annotation.cvTermAccessionCode+"\">"+cvTermShort+"</a>";
                    }
                    mimAccessionRegExMatch = / [MIM:[0-9]*]/g.exec(uniprotDiseaseString);
                    if (mimAccessionRegExMatch) {
                        mimAccession = mimAccessionRegExMatch[0].slice(6,mimAccessionRegExMatch[0].length-1);
                        mimLink = "<a href=\"http://www.omim.org/entry/"+mimAccession+"\" class=\"ext-link style-scope generic-annotation-section\" target=\"_blank\">MIM:"+mimAccession+"</a>";
                    }
                    if(cvTermLink && mimLink) annotation.description = annotation.description.replace(new RegExp(cvTermShort, 'g'), cvTermLink).replace("MIM:"+mimAccession, mimLink);
                }
                return annotation.description;
            },
            _checkCategoryLabel: function(category){
                return this.containsGoldEv[category] || this.goldOnly!==true;
            },
            _checkIfContainsAccessionOrXref: function(annotation){
                return Boolean(annotation.cvTermAccessionCode || annotation.parentXref);
            },
            _toArray: function(obj) {
                if (typeof obj === 'object') {
                    return Object.keys(obj).map(function(key) {
                        return {
                            name: key,
                            value: obj[key]
                        };
                    });
                }
                return null;
            },
            _objectValues: function(obj) {
                var vals = [];
                for( var key in obj ) {
                    if ( obj.hasOwnProperty(key) ) {
                        vals.push(obj[key]);
                    }
                }
                return vals;
            },
            _getIndex: function(index){
                return index+1;
            },
            _countItems: function(obj){
                return obj.length;
            },
            _toggle: function(mouseEvent){
                var srcElementId = mouseEvent.target.id || mouseEvent.target.parentNode.id;
                this.$$("#"+srcElementId.replace('button','container')).toggle();
            },
            _isNewPathwayCategory: function(category, name){
                if (category==="PATHWAY" && this.pathwayCategory!=new String(name).split('_')[0]) {
                    this.pathwayCategory = new String(name).split('_')[0];
                    return true;
                }
                return false;
            },
            _checkIfNextAnnotHasTheSameSource: function(categoryObj, index){
                var firstAnnotCat = categoryObj[index]['evidenceSources'][0];
                var secondAnnotCat = categoryObj[index+1] ?
                        categoryObj[index+1]['evidenceSources'][0] : undefined;
                return firstAnnotCat===secondAnnotCat;
            },
            _checkIfNextprot: function(databaseName){
                return databaseName.toLowerCase()==="nextprot";
            },
            _checkIfChebi: function(databaseName){
                return databaseName.toLowerCase()==="chebi";
            },
            _checkIfSubcellularLocation: function(annotation){
                return (annotation.category==="SUBCELLULAR_LOCATION" && annotation.cvTermName!==annotation.description);
            },
            _checkIfDisease: function(annotation){
                return annotation.category==="DISEASE";
            },
            _isBinaryInteractionOrBiophysical: function (category){
                return (["BINARY_INTERACTION", "BIOPHYSICOCHEMICAL PROPERTIES"].indexOf(category)!==-1);
            },
            _isBiophysicochemicalProperty: function(category){
                return category==="BIOPHYSICOCHEMICAL PROPERTIES";
            },
            _isPathwayOrTcdb: function(category){
                return ["UNIPATHWAYS", "KEGG PATHWAYS", "REACTOME PATHWAYS", "TCDB TRANSPORT CLASSIFICATION"].indexOf(category)!==-1;
            },
            _isProteinProteinInteraction: function(category){
                return category.name==="PROTEIN-PROTEIN INTERACTION";
            },
            _isNewSubcategory: function(annotations,index){
                return index===0 || annotations[index].subcategory!==annotations[index-1].subcategory;
            },
            _isNewIsoformSection: function(annotations, index){
                if (index===0 || !annotations[index] || annotations[index].category!=="BINARY_INTERACTION") return false;
                else return annotations[index].isoformSpecific!==annotations[index-1].isoformSpecific;
            },
            _stringToId: function(str){
                return str.toLowerCase().replace(" ", "-");
            },
            _addPubmedLink: function(text){
                var pmidRegexp = /PubMed:\d{7,9}\.{0,1}\d{0,1}/g
                var matches = text.match(pmidRegexp);
                if (matches) {
                    for (var i in matches){
                        var pmid = matches[i].split(":")[1];
                        text = text.replace(
                                matches[i],
                                'PubMed: <a href="https://www.ncbi.nlm.nih.gov/pubmed/'+pmid+'" class="ext-link style-scope generic-annotation-section" target="_blank">'+pmid+'</a>'
                        );
                    }
                }
                return text;

            }
        });
    </script>
</dom-module>