<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="../iron-icon/iron-icon.html">
<link rel="import" href="../iron-icons/iron-icons.html">
<link rel="import" href="../iron-collapse/iron-collapse.html">
<link rel="import" href="../paper-spinner/paper-spinner-lite.html">
<link rel="import" href="evidence-item.html">
<link rel="import" href="quality-label.html">
<link rel="import" href="nextprot-elements-shared-styles.html">
<script>
    //Load JQuery if necessary
    if(typeof jQuery === "undefined"){
        (function(){
            var newscript = document.createElement('script');
            newscript.type = 'text/javascript';
            newscript.src = '../../jquery/dist/jquery.min.js';
            (document.getElementsByTagName('head')[0]||document.getElementsByTagName('body')[0]).appendChild(newscript);
        })();
    }
    //Load Nextprot if necessary
    if(typeof Nextprot === "undefined"){
        (function(){
            var nextprotScript = document.createElement('script');
            nextprotScript.type = 'text/javascript';
            nextprotScript.src = '../../nextprot/src/nextprot-core.js';
            (document.getElementsByTagName('head')[0]||document.getElementsByTagName('body')[0]).appendChild(nextprotScript);
        })();
    }
</script>
<!--
`generic-annotation-section`
Annotation section used in function, medical, and expression views.

#### Example
    <generic-annotation-section section="function" categories='[ "GENERAL-ANNOTATION" ]'></generic-annotation-section>


@demo demo/generic-annotation-demo.html
-->
<dom-module id="generic-annotation-section">
    <template>
        <style include="nextprot-elements-shared-styles">
            :host {
                display: block;
                min-height: 35px;
            }
            .xeno-label, .isoform-label {
                color: #999;
                border: 1px solid;
                border-radius: 2px;
                padding: 0px 2px;
            }
            .front-label {
                margin-right: 5px;
            }
            .end-label {
                margin-left: 5px;
            }
            .annotation-container {
                float: left;
                display: inline;
                width: calc(100% - 175px);
            }
            .annotation-row {
                margin-right: 0px;
                margin-bottom: 0px;
            }
            .annotation-title-container > .isoform-label {
                margin-top: 3px;
            }
            .evidences-button-container {
                display: inline;
                width: 175px;
            }
            .evidences-container {
                margin: 0px 200px 15px 0px;
            }
            .blue-well {
                margin: 5px 190px 10px 10px;
            }
            @media (max-width: 1080px) {
                .evidences-container {
                    margin: 0px 25px 20px 0px;
                }
                .blue-well {
                    margin: 5px 15px 10px 10px;
                }
            }
            #evidenceButton {
                float: right;
                padding: 0px 5px 0px 0px;
            }
            #notice {
                margin: 0 0 0 5px;
            }
            #biophysicochemical-properties-section {
                border: 1px solid #E7EAEC;
                margin-top: 2em;
            }
        </style>
        <div class="category-main">
            <template is="dom-if" if="[[data]]">
                <button id="evidenceButton" class="btn btn-default" on-tap="_toggleAllEvidences">
                    <template is="dom-if" if="[[evidencesShown]]">
                        <iron-icon icon="arrow-drop-up"></iron-icon>
                        Hide evidences
                    </template>
                    <template is="dom-if" if="[[!evidencesShown]]">
                        <iron-icon icon="arrow-drop-down"></iron-icon>
                        Show evidences
                    </template>
                </button>
            </template>
            <div id="notice" class="grey-x"><i>Annotations in this section apply to all the isoforms if not specified otherwise.</i><paper-spinner-lite id="spinner" active></paper-spinner-lite></div>
            <template is="dom-repeat" items="[[_toArray(data)]]" as="category">
                <div class="row category-row">
                    <div>
                        <h4 class="annotation-category-title"> [[category.name]]</h4>
                    </div>
                    <div id="[[_stringToId(category.name)]]-section">
                        <template is="dom-repeat" items="[[_toArray(category.value)]]" as="annotation" filter="_filter" initial-count="1" target-framerate="1">
                            <template is="dom-if" if="[[annotation.value.newSection]]">
                                <div class="grey-x">Interactions for Isoform [[annotation.value.isoformSpecific]]</div>
                            </template>
                            <div class="row annotation-row">
                                <template is="dom-if" if="[[annotation.value.prefix]]">
                                    <div class="grey-x">[[annotation.value.prefix]]</div>
                                </template>
                                <div class="annotation-container">
                                    <div class="annotation-title-container">
                                        <template is="dom-if" if="[[annotation.value.chemicalName]]">
                                            <template is="dom-if" if="[[_checkIfChebi(annotation.value.database)]]">
                                                <p class="annotation-title" style="text-transform: capitalize">
                                                    [[annotation.value.chemicalName]]
                                                    <a href="https://www.ebi.ac.uk/chebi/searchId.do?chebiId=[[annotation.value.accession]]" class="ext-link" target="_blank">[[annotation.value.accession]]</a>
                                                </p>
                                            </template>
                                        </template>
                                        <template is="dom-if" if="[[annotation.value.cvTermAccessionCode]]">
                                            <template is="dom-if" if="[[annotation.value.isoformSpecific]]">
                                                <span class="annotation-title isoform-label front-label">[[annotation.value.isoformSpecific]]</span>
                                            </template>
                                            <p class="annotation-title" inner-h-t-m-l="[[annotation.value.description]]"></p>
                                            <div class="annotation-labels">
                                                <a class="accession-code-link" href="/term/[[annotation.value.cvTermAccessionCode]]">[[annotation.value.cvTermAccessionCodeLabel]]</a>
                                                <span id="description-button-[[annotation.value.id]]" class="colored-label definition-button" on-tap="_toggle">Definition</span>
                                                <quality-label quality="[[annotation.value.qualityQualifier]]"></quality-label>
                                            </div>
                                        </template>
                                        <template is="dom-if" if="[[annotation.value.parentXref]]">
                                            <p class="annotation-title">[[annotation.value.description]]</p>
                                            <div class="annotation-labels">
                                                <a class="accession-code-link ext-link selectable" href="[[annotation.value.parentXref.resolvedUrl]]" target="_blank">[[annotation.value.parentXref.accession]]</a>
                                                <quality-label quality="[[annotation.value.qualityQualifier]]"></quality-label>
                                            </div>
                                        </template>
                                        <template is="dom-if" if="[[!_checkIfContainsAccessionOrXref(annotation.value)]]">
                                            <template is="dom-if" if="[[_isBiophysicochemicalProperty(annotation.value.category)]]">
                                                <template is="dom-if" if="[[_isNewSubcategory(category.value, index)]]">
                                                    <div class="grey-x">[[annotation.value.subcategory]]</div>
                                                </template>
                                                <div class="col-lg-2 col-md-2 col-sm-3 col-xs-4" inner-h-t-m-l="[[annotation.value.label]]"></div>
                                                <div class="col-lg-10 col-md-10 col-sm-9 col-xs-8" inner-h-t-m-l="[[annotation.value.description]]"></div>
                                            </template>
                                            <p class="annotation-title">
                                                <template is="dom-if" if="[[!_isBinaryInteractionOrCofactorOrBiophysical(annotation.value.category)]]">
                                                    <template is="dom-if" if="[[annotation.value.isoformSpecific]]">
                                                        <span class="isoform-label front-label">[[annotation.value.isoformSpecific]]</span>
                                                    </template>
                                                    <span inner-h-t-m-l="[[annotation.value.description]]"></span>
                                                    <template is="dom-if" if="[[!_isBinaryInteractionOrCofactorOrBiophysical(annotation.value.category)]]">
                                                        <quality-label quality="[[annotation.value.qualityQualifier]]"></quality-label>
                                                    </template>
                                                </template>
                                            </p>
                                            <template is="dom-if" if="[[annotation.value.selfInteraction]]">
                                                <p class="annotation-title col-lg-12 col-md-12 col-sm-12 col-xs-12">Itself</p>
                                            </template>
                                            <template is="dom-if" if="[[annotation.value.geneName]]">
                                                <p class="annotation-title col-lg-12 col-md-12 col-sm-12 col-xs-12">
                                                    <template is="dom-if" if="[[_checkIfNextprot(annotation.value.database)]]">
                                                        <a href="[[annotation.value.url]]">[[annotation.value.geneName]]</a>
                                                        <template is="dom-if" if="[[annotation.value.proteinName]]">
                                                            >> [[annotation.value.proteinName]]
                                                        </template>
                                                    </template>
                                                    <template is="dom-if" if="[[!_checkIfNextprot(annotation.value.database)]]">
                                                        [[annotation.value.geneName]] >> [[annotation.value.database]]: <a href="[[annotation.value.url]]" class="ext-link">[[annotation.value.accession]]</a>
                                                    </template>
                                                    <template is="dom-if" if="[[annotation.value.interactantIsoform]]">
                                                        <span class="isoform-label end-label">Isoform [[annotation.value.interactantIsoform]]</span>
                                                    </template>
                                                    <template is="dom-if" if="[[annotation.value.xeno]]">
                                                        <span class="xeno-label end-label">Xeno</span>
                                                    </template>
                                                    <quality-label quality="[[annotation.value.qualityQualifier]]"></quality-label>
                                                </p>
                                            </template>
                                        </template>
                                    </div>
                                </div>
                                <template is="dom-if" if="[[!_isPathwayOrTcdb(annotation.value.category)]]">
                                    <template is="dom-if" if="[[_countItems(annotation.value.evidences)]]">
                                        <div class="evidences-button-container">
                                            <div class="show-references-button">
                                                <a id="evidences-button-[[annotation.value.id]]" class="btn" on-tap="_toggle">
                                                    <p class="show-references-button-counter">[[_countItems(annotation.value.evidences)]]</p>
                                                    <p class="show-references-button-label">ev</p>
                                                </a>
                                                <div class="reference-label-container">
                                                    <template is="dom-repeat" items="[[annotation.value.evidenceSources]]" as="source">
                                                        <div class="reference-label">[[source]]</div>
                                                    </template>
                                                </div>
                                            </div>
                                        </div>
                                    </template>
                                </template>
                            </div>
                            <iron-collapse id="description-container-[[annotation.value.id]]">
                                <div class="well blue-well">
                                    [[annotation.value.cvTermDescription]]
                                </div>
                            </iron-collapse>
                            <template is="dom-if" if="[[!_isPathwayOrTcdb(annotation.value.category)]]">
                                <template is="dom-if" if="[[_countItems(annotation.value.evidences)]]">
                                    <iron-collapse id="evidences-container-[[annotation.value.id]]">
                                        <div class="evidences-container">
                                            <template is="dom-repeat" items="[[annotation.value.evidences]]" as="evidence">
                                                <evidence-item data="[[evidence]]" index="[[_getIndex(index)]]"></evidence-item>
                                            </template>
                                        </div>
                                    </iron-collapse>
                                </template>
                            </template>
                        </template>
                    </div>
                </div>
            </template>
        </div>
    </template>

    <script>
        Polymer({
            is: 'generic-annotation-section',
            properties: {
                nxConfig: {
                    type: Object,
                    value: {}
                },
                categories: {
                    type: Array,
                    value: []
                },
                categoryTitles: {
                    type: Object,
                    value: {}
                },
                annotationsByCategory: {
                    type: Array,
                    value: []
                },
                section: {
                    type: String
                },
                goldOnly: {
                    type: Boolean,
                    observer: "_getAnnotationsByView"
                },
                showEvidences: {
                    type: Boolean,
                    value: false
                },
                count: {
                    type: Number,
                    notify: true
                },
                isoform: {
                    type: String,
                    observer: "_reloadIsoform"
                }
            },
            ready: function(){
                if(this.evidencesShown===undefined) this._toggleAllEvidences();
                Polymer.RenderStatus.afterNextRender(this, () => {
                    var nx = new Nextprot.Client("neXtprot annotation loader", "Calipho Group");
                if (this.nxConfig.env) nx.updateEnvironment(this.nxConfig.env);
                var apiCall = [];
                for (var i in this.categories) apiCall.push(nx.getAnnotationsByCategory(this.nxConfig.entry, this.categories[i]))
                var self = this;
                Promise.all(apiCall)
                        .then(function (categories) {
                            self.annotationsByCategory = categories;
                            self._getAnnotationsByView();
                            self.$.spinner.removeAttribute('active');
                        }).catch(function (err) {
                            // catch any error that happened so far
                            console.log("Argh, broken: " + err.message);
                            console.log("Error at line : " + err.stack);
                            self.$.spinner.removeAttribute('active');
                            self.count = 0;
                        });
                });
            },
            _reloadIsoform: function(){
                if(this.count) this._getAnnotationsByView();
            },
            _getAnnotationsByView: function() {
                var data_xrefs = [];
                var data_publi = [];
                var data_isoforms = [];
                var data_annot = [];
                var count = 0;
                for(var i in this.annotationsByCategory) {
                    Object.assign(data_xrefs, this.annotationsByCategory[i].xrefs);
                    Object.assign(data_publi, this.annotationsByCategory[i].publi);
                    Object.assign(data_isoforms, this.annotationsByCategory[i].isoforms);
                    $.merge(data_annot, this.annotationsByCategory[i].annot);
                };
                data = {};
                var self = this;
                var annotCategoryList = [];
                for (var v in this._objectValues(data_annot)) annotCategoryList.push(data_annot[v].category);
                annotCategoryCount = annotCategoryList.reduce( function (prev, item) {
                    if ( item in prev ) prev[item] ++;
                    else prev[item] = 1;
                    return prev;
                }, {} );
                for (var i in data_annot) {
                    var a = data_annot[i];
                    if (this.section==="function"){
                        if (a.category==="go molecular function" && a.cvTermAccessionCode=="GO:0003674") continue;
                        if (a.category==="go biological process" && a.cvTermAccessionCode=="GO:0008150") continue;
                        if (a.category==="caution" && a.description=="Product of a dubious CDS prediction.") continue;
                        if (a.category==="caution" && a.description=="Product of a dubious gene prediction.") continue;
                        if (a.category==="caution" && a.description=="Could be the product of a pseudogene.") continue;
                        if (a.category==="caution" && a.description.startsWith("It is uncertain whether Met")) continue;
                        if (a.category==="miscellaneous" && a.description.toLowerCase().match(/.*antibod.*/)) continue;
                        if (a.category==="miscellaneous" && a.description.toLowerCase().match(/.*antigen.*/)) continue;
                        if (a.category==="miscellaneous" && a.description.toLowerCase().match(/.*\sbind.*/)) continue;
                        if (a.category==="miscellaneous" && a.description.toLowerCase().match(/^bind.*/)) continue;
                    }
                    if (a.cvTermAccessionCode && a.apicategory==="CATALYTIC_ACTIVITY") a.cvTermAccessionCodeLabel="EC "+a.cvTermAccessionCode;
                    else if (a.cvTermAccessionCode) a.cvTermAccessionCodeLabel=a.cvTermAccessionCode;
                    if (a.properties) {
                        for (var j in a.properties) if(a.properties[j].name==="rank") a.rank=a.properties[j].value;
                    }
                    if (a.category==="cofactor") {
                        a.chemicalName = a.bioObject.properties["chemical name"] ?
                                a.bioObject.properties["chemical name"] : undefined;
                        if (a.rank==1 &&  annotCategoryCount["cofactor"]>1) a.prefix = "It requires the following cofactors "
                        else if (a.rank==1) a.prefix = "It requires the following cofactor "
                        a.rank = 100+ a.rank;
                    }
                    if (a.category=="catalytic activity" && a.rank==1 && annotCategoryCount["catalytic activity"]>1) a.prefix = "This protein acts as an enzyme. It is known to catalyze the following reactions";
                    else if (a.category=="catalytic activity" && a.rank==1) a.prefix = "This protein acts as an enzyme. It is known to catalyze the following reaction";
                    if (a.category=="enzyme regulation") {
                        if (a.rank==1 &&  annotCategoryCount["enzyme regulation"]>1) a.prefix = "It is regulated in the following manners "
                        if (a.rank==1) a.prefix = "It is regulated in the following manner";
                        a.rank = 200+ a.rank;
                    }
                    if(a.category=="pathway") a.category=self._getUniqueListOfEvidenceSources(a.evidences)+" pathways";
                    if(a.category.toLowerCase()=="uniprot pathways") a.category="UNIPATHWAYS";
                    if(a.category=="subcellular location info") {
                        a.category="";
                        a.description = "<b>Note:</b> "+ a.description;}
                    if (["kinetic KM", "kinetic Vmax", "kinetic note"].indexOf(a.category)!==-1) {
                        if(a.category=="kinetic KM") a.label="K<sub>M</sub>";
                        if(a.category=="kinetic Vmax") a.label="V<sub>max</sub>";
                        a.category= "BIOPHYSICOCHEMICAL PROPERTIES"; a.subcategory="KINETIC PARAMETERS";
                    }
                    if (a.category=="pH dependence" || a.category=="temperature dependence") {
                        if(a.category=="temperature dependence") a.label="Temperature";
                        if(a.category=="pH dependence") a.label="pH";
                        a.category= "BIOPHYSICOCHEMICAL PROPERTIES"; a.subcategory="DEPENDENCE";
                    }
                    if (["absorption max", "absorption note"].indexOf(a.category)!==-1) {
                        if (a.category=="absorption max") a.label="&lambda;<sub>max</sub>";
                        a.category= "BIOPHYSICOCHEMICAL PROPERTIES"; a.subcategory="ABSORPTION";
                    }
                    if (a.category=="redox potential") {
                        a.category= "BIOPHYSICOCHEMICAL PROPERTIES"; a.subcategory="REDOX POTENTIAL";
                    }
                    if(Object.keys(self.categoryTitles).indexOf(a.category)!=-1) a.category = self.categoryTitles[a.category];
                    dontCapitalize = ["mRNA", "tRNA", "rRNA", "dsDNA", "ssDNA", "siRNA", "snRNA", "ssRNA", "tmRNA",
                    "dAMP", "dADP", "dATP", "dCMP", "dCDP", "dCTP", "dGMP", "dGDP", "dGTP",
                    "dTMP", "dTDP", "dTTP", "cAMP", "cGMP", "hnRNP", "snRNP", "bZIP", "cTAGE", "eIF", "mTERF"]
                    if (a.description && dontCapitalize.indexOf(a.description.split(" ")[0])===-1) a.description= a.description.charAt(0).toUpperCase()+ self._addPubmedLink(a.description).slice(1);
                    if (a.cvTermName && dontCapitalize.indexOf(a.cvTermName.split(" ")[0])===-1) a.cvTermName=a.cvTermName.charAt(0).toUpperCase()+a.cvTermName.slice(1);
                    if (a.category.toLowerCase()==="transport activity") a.category = "TCDB TRANSPORT CLASSIFICATION";
                    if (a.bioObject) {
                        a.geneName=a.bioObject.properties.geneName;
                        a.proteinName=a.bioObject.properties.proteinName;
                        a.url=a.bioObject.properties.url;
                        a.database=a.bioObject.database;
                        a.accession=a.bioObject.accession;
                        if(a.bioObject.bioType=="PROTEIN_ISOFORM") {a.interactantIsoform=a.bioObject.properties.isoformName;};
                    }
                    a.selfInteraction = a.propertiesMap.selfInteraction ? a.propertiesMap.selfInteraction[0].value : false;
                    a.xeno = a.database!="neXtProt" ? true : false;
                    if (!data.hasOwnProperty(a.category)) data[a.category]=[];
                    for(var j in a.evidences){
                        if(a.evidences[j].goQualifier==="contributes_to" && !a.description.startsWith("<i>Contributes to</i>&nbsp;")) a.description = a.description.replace("Contributes to ", "<i>Contributes to</i>&nbsp;");
                        if(a.evidences[j].goQualifier==="colocalizes_with" && !a.description.startsWith("<i>Colocalizes with</i>&nbsp;")) a.description = a.description.replace("Colocalizes with ", "<i>Colocalizes with</i>&nbsp;");
                        if(a.evidences[j].negativeEvidence==true && !a.description.startsWith("<b>Not</b>")) a.description = "<b>Not</b>&nbsp;"+a.description.charAt(0).toLowerCase()+a.description.slice(1);
                    };
                    if(a.annotationId===0) a.annotationId=data_annot.indexOf(a);
                    for (j in a.targetingIsoformsMap){
                        var isoform = a.targetingIsoformsMap[j];
                        if (this._objectValues(a.targetingIsoformsMap).length < this._objectValues(data_isoforms).length){
                            a.isoformAccession = isoform.isoformAccession;
                            if (a.isoformSpecific!==undefined) a.isoformSpecific = a.isoformSpecific.replace(/^Isoform(?!s)/, "Isoforms")+" and " + data_isoforms[isoform.isoformAccession].mainEntityName.name;
                            else a.isoformSpecific = "Isoform "+ data_isoforms[isoform.isoformAccession].mainEntityName.name;
                        }
                    }
                    data[a.category].push({
                        id: a.annotationId,
                        description: a.description || a.cvTermName,
                        category: a.category.toUpperCase(),
                        subcategory: a.subcategory,
                        label: a.label || null,
                        prefix: a.prefix,
                        cvTermAccessionCode: a.cvTermAccessionCode,
                        cvTermAccessionCodeLabel: a.cvTermAccessionCodeLabel,
                        cvTermDescription: a.cvTermDescription,
                        selfInteraction: a.selfInteraction=="true",
                        rank: a.rank,
                        xeno: a.xeno,
                        geneName: a.geneName,
                        proteinName: a.proteinName,
                        accession: a.accession,
                        chemicalName: a.chemicalName,
                        url: a.url,
                        database: a.database,
                        parentXref: a.parentXref,
                        evidences: a.evidences ? self._getEvidence(a.evidences, data_xrefs, data_publi) : [],
                        evidenceSources: self._getUniqueListOfEvidenceSources(a.evidences),
                        qualityQualifier: a.qualityQualifier,
                        isoformSpecific: a.isoformSpecific,
                        isoformAccession: a.isoformAccession,
                        interactantIsoform: a.interactantIsoform
                    });
                }
                for (var i in Object.keys(data)) {
                    var category = Object.keys(data)[i];
                    if (["ENZYMATIC ACTIVITY", "COFACTOR", "NOTE", "CAUTION"].indexOf(category.toUpperCase())!==-1) data[category] = data[Object.keys(data)[i]].sort(this._sortByRank);
                    else if (category.toUpperCase()==="OVERVIEW") data[category] = data[Object.keys(data)[i]].sort(this._sortOverview);
                    else if (category==="BIOPHYSICOCHEMICAL PROPERTIES") data[category] = data[Object.keys(data)[i]].sort(this._sortBiophysicochemical);
                    else if (category.toUpperCase()==="BINARY INTERACTIONS") data[category] = data[Object.keys(data)[i]].sort(this._sortBinaryInteractions);
                    else data[category] = data[Object.keys(data)[i]].sort(this._sortAlphabetically);
                    count+=data[Object.keys(data)[i]].length;
                }
                this.data = data;
                this.count = count;
            },
            _sortAlphabetically: function(a,b) {
                if(a.description.startsWith("<b>") || b.description.startsWith("<b>"))
                    return a.description.replace("<b>Contributes to</b> ","").replace("<b>Not</b> ","").toLowerCase()
                    > b.description.replace("<b>Contributes to</b> ","").replace("<b>Not</b> ","").toLowerCase() ? 1 : -1;
                return a.description.toLowerCase() > b.description.toLowerCase() ? 1 : -1;
            },
            _sortByRank: function(a,b) {
                return parseInt(a.rank) > parseInt(b.rank) ? 1 : -1;
            },
            _sortOverview: function(a,b){
                return (a.isoformSpecific && !b.isoformSpecific)?1:-1;
            },
            _sortBiophysicochemical: function(a,b) {
                if(a.subcategory=="ABSORPTION" && b.subcategory!="ABSORPTION") return -1;
                if(a.subcategory=="ABSORPTION" && b.subcategory=="ABSORPTION") {
                    if(a.label){
                        return -1;
                    }
                    return 1;
                }
                if(a.subcategory=="KINETIC PARAMETERS" && b.subcategory=="KINETIC PARAMETERS") {
                    if(a.label == "K<sub>M</sub>" && b.label == "K<sub>M</sub>") {
                        return (a.description.toLowerCase().split("for ")[1] > b.description.toLowerCase().split("for ")[1]) ? 1: -1;
                    }
                    if(a.label == "V<sub>max</sub>" && b.label == "V<sub>max</sub>") {
                        return (a.description.toLowerCase().split("enzyme ")[1] > b.description.toLowerCase().split("enzyme ")[1]) ? 1: -1;
                    }
                    if(a.label == "K<sub>M</sub>" && b.label == "V<sub>max</sub>") return -1;
                    if(a.label == "V<sub>max</sub>" && b.label == "K<sub>M</sub>") return 1;
                    if(a.id > b.id) {
                        return 1;
                    }
                    return -1;
                }
                if(a.subcategory==="KINETIC PARAMETERS" && b.subcategory==="ABSORPTION") return 1;
                if(a.subcategory==="KINETIC PARAMETERS" && b.subcategory==="DEPENDENCE") return -1;
                if(a.subcategory=="DEPENDENCE" && b.subcategory!="DEPENDENCE") return 1;
                if(a.subcategory==="DEPENDENCE" && b.subcategory==="DEPENDENCE" && b.label==="pH") return 1;
            },
            _sortBinaryInteractions: function(a,b){
                if (a.isoformSpecific && !b.isoformSpecific) return 1
                if (!a.isoformSpecific && b.isoformSpecific) return -1
                if (a.isoformSpecific && b.isoformSpecific && b.isoformSpecific===a.isoformSpecific){
                    if(a.geneName.toLowerCase() > b.geneName.toLowerCase()) {
                        a.newSection=false;
                        b.newSection=true;
                    } else {
                        a.newSection=true;
                        b.newSection=false;
                    }
                }
                if (a.isoformSpecific && b.isoformSpecific && a.isoformSpecific!==b.isoformSpecific){
                    a.newSection=true;
                    b.newSection=true;
                    return a.isoformSpecific.toLowerCase() > b.isoformSpecific.toLowerCase() ? 1 : -1;
                }
                if (a.selfInteraction) return -1;
                if (b.selfInteraction) return 1;
                if (a.geneName=="-") return 1;
                if (b.geneName=="-") return -1;
                if (a.geneName)
                    return a.geneName.toLowerCase() > b.geneName.toLowerCase() ? 1 : -1;
            },
            _filter: function(item){
                return (this._filterGold(item) && this._filterIsoform(item));
            },
            _filterGold: function(item){
                if (this.goldOnly) return item.value.qualityQualifier==="GOLD";
                return true;
            },
            _filterIsoform: function(item){
                if (this.isoform && this.isoform!=="all") return (item.value.isoformAccession===this.isoform || !item.value.isoformSpecific);
                return true;
            },
            _toggleAllEvidences: function(){
                this.async(function() {
                    this.evidencesShown=true;
                    var evidenceContainers = Polymer.dom(this.root).querySelectorAll(".evidences-container");
                    for (var e in evidenceContainers) {
                        if (this.showEvidences == true) {
                            evidenceContainers[e].parentNode.opened = true;
                        } else {
                            evidenceContainers[e].parentNode.opened = false;
                        }
                    }
                    this.evidencesShown = this.showEvidences;
                    this.showEvidences = !this.showEvidences;
                }, 1);
            },
            _getEvidence: function(ev, xrefs, publi){
                function getUrl(id){
                    if (xrefs.hasOwnProperty(id)) {
                        return xrefs[id].resolvedUrl;
                    }
                    return "";
                }
                var self = this;
                return ev.map(function(e){
                    if (e.goAssignedBy) e.assignedBy = e.goAssignedBy;
                    e.assignedBy=e.assignedBy.replace('NextProt', 'neXtProt');
                    e.assignedBy=e.assignedBy.replace('Uniprot', 'UniProt');
                    e.assignedBy=e.assignedBy.replace('KEGG_PTW', 'KEGG');
                    e.numberOfExperiments = e.properties ? e.properties.numberOfExperiments : undefined;
                    return {
                        "evidenceCodeName": e.evidenceCodeName,
                        "resourceAccession": e.resourceAccession,
                        "assignedBy": e.assignedBy,
                        "resourceDb": e.resourceDb,
                        "negative": e.negativeEvidence,
                        "qualityQualifier": e.qualityQualifier,
                        "numberOfExperiments": e.numberOfExperiments,
                        "url": getUrl(e.resourceId),
                        "publication": self._getPublication(publi[e.resourceId])
                    }
                })
            },
            _getPublication: function(pub){
                if(pub){
                    return {
                        publicationId: pub.publicationId,
                        localUrl: "/publications/"+pub.publicationId,
                        title: pub.title,
                        authors: pub.authors,
                        journalResourceLocator: pub.journalResourceLocator,
                        volume: pub.volume,
                        firstPage: pub.firstPage,
                        lastPage: pub.lastPage,
                        publicationYear: pub.publicationYear,
                        dbXrefs: pub.dbXrefs,
                        abstractText: pub.abstractText
                    }
                }
            },
            _getUniqueListOfEvidenceSources: function(evidenceList){
                var evidenceSourceList = [];
                for (var i in evidenceList){
                    if (evidenceList[i].assignedBy.endsWith("_PTW")) evidenceList[i].assignedBy = evidenceList[i].assignedBy.replace("_PTW","");
                    if (evidenceList[i].assignedBy==="Human protein atlas subcellular localization") evidenceList[i].assignedBy="HPA subcell";
                    if (evidenceList[i].assignedBy==="Alzheimers_University_of_Toronto") evidenceList[i].assignedBy="Alzheimers UoT";
                    if(evidenceSourceList.indexOf(evidenceList[i].assignedBy) < 0) {
                        evidenceSourceList.push(evidenceList[i].assignedBy);
                    }
                }
                return evidenceSourceList;
            },
            _checkIfContainsAccessionOrXref: function(annotation){
                return Boolean(annotation.cvTermAccessionCode || annotation.parentXref);
            },
            _toArray: function(obj) {
                if (typeof obj === 'object') {
                    return Object.keys(obj).map(function(key) {
                        return {
                            name: key,
                            value: obj[key]
                        };
                    });
                }
                return null;
            },
            _objectValues: function(obj) {
                var vals = [];
                for( var key in obj ) {
                    if ( obj.hasOwnProperty(key) ) {
                        vals.push(obj[key]);
                    }
                }
                return vals;
            },
            _getIndex: function(index){
                return index+1;
            },
            _countItems: function(obj){
                return obj.length;
            },
            _toggle: function(mouseEvent){
                var srcElementId = mouseEvent.target.id || mouseEvent.target.parentNode.id;
                this.$$("#"+srcElementId.replace('button','container')).toggle();
            },
            _isNewPathwayCategory: function(category, name){
                if (category=="pathway" && this.pathwayCategory!=new String(name).split('_')[0]) {
                    this.pathwayCategory = new String(name).split('_')[0];
                    return true;
                }
                return false;
            },
            _checkIfNextAnnotHasTheSameSource: function(categoryObj, index){
                var firstAnnotCat = categoryObj[index]['evidenceSources'][0];
                var secondAnnotCat = categoryObj[index+1] ?
                        categoryObj[index+1]['evidenceSources'][0] : undefined;
                return firstAnnotCat===secondAnnotCat;
            },
            _checkIfNextprot: function(databaseName){
                return databaseName.toLowerCase()==="nextprot";
            },
            _checkIfChebi: function(databaseName){
                return databaseName.toLowerCase()==="chebi";
            },
            _isBinaryInteractionOrCofactorOrBiophysical: function (category){
                return (["BINARY INTERACTIONS", "COFACTOR", "BIOPHYSICOCHEMICAL PROPERTIES"].indexOf(category)!==-1);
            },
            _isBiophysicochemicalProperty: function(category){
                return category==="BIOPHYSICOCHEMICAL PROPERTIES";
            },
            _isPathwayOrTcdb: function(category){
                return ["UNIPATHWAYS", "KEGG PATHWAYS", "REACTOME PATHWAYS", "TCDB TRANSPORT CLASSIFICATION"].indexOf(category)!==-1;
            },
            _isNewSubcategory: function(annotations,index){
                return index===0 || annotations[index].subcategory!==annotations[index-1].subcategory;
            },
            _stringToId: function(str){
                return str.toLowerCase().replace(" ", "-");
            },
            _addPubmedLink: function(text){
                var pmidRegexp = /PubMed:\d{7,9}\.{0,1}\d{0,1}/g
                var matches = text.match(pmidRegexp);
                if (matches) {
                    for (var i in matches){
                        var pmid = matches[i].split(":")[1];
                        text = text.replace(
                                matches[i],
                                'PubMed: <a href="https://www.ncbi.nlm.nih.gov/pubmed/'+pmid+'" class="ext-link style-scope generic-annotation-section" target="_blank">'+pmid+'</a>'
                        );
                    }
                }
                return text;

            }
        });
    </script>
</dom-module>