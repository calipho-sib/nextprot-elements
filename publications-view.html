<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="../paper-spinner/paper-spinner-lite.html">
<link rel="import" href="../paper-toggle-button/paper-toggle-button.html">
<link rel="import" href="../iron-ajax/iron-ajax.html">
<link rel="import" href="protein-overview.html">
<link rel="import" href="publication-item.html">
<link rel="import" href="nextprot-elements-shared-styles.html">
<link rel="import" href="paginator-element.html">

<!--
`publications-view`
Publications listing used in curated and additional publications pages.

@demo demo/publications-view-demo.html
-->

<dom-module id="publications-view">
    <template>
        <style is="custom-style" include="nextprot-elements-shared-styles">
            :host {
                display: block;
                --paper-toggle-button-checked-button-color: #428bca;
                --paper-toggle-button-checked-bar-color: #428bca;
            }
            .control-header {
                margin: 10px 0;
                padding-bottom: 25px;
                display: flex;
                border-bottom: 1px solid #E7EAEC;
            }
            .mode-toggle {
                display: inline-flex;
                margin-top: -3px;
            }
            .toggle-label {
                padding: 5px 10px 5px 3px;
            }
        </style>

                 <!-- url="http://build-api.nextprot.org/entry-publications/[[acc]]/pubview/CURATED.json" -->
        <iron-ajax
                id ="pubAPIcall"
                url= "http://build-api.nextprot.org/entry-publications/[[nxConfig.entry]]/category/[[nxConfig.pubType]].json"
                handle-as="json"
                on-response="_pubResponse"
                on-error="_onPubError" >
        </iron-ajax>

        <div class="row">
            <div id="nxOverview" class="col-md-12">
                <protein-overview nx-config="[[nxConfig]]"></protein-overview>
            </div>
        </div>
        <div class="row">
            <div class="nxSection col-md-12">
                <div id="publications-header" class="category-header">
                    <h4 id="publications-title" class="category-title">
                        [[header]]
                    </h4>
                    <paper-spinner-lite id="spinner" active></paper-spinner-lite>
                </div>
                <template is="dom-if" if="[[items.length]]">
                    <div class="control-header">
                        <div class="no-padding col-lg-5"><template is="dom-if" if="[[items]]">Publications [[from]] to [[to]] of [[items.length]]</template></div>
                        <div class="col-lg-2">
                            show&nbsp;
                            <select on-change="_changePageSize">
                                <option value="10">10</option>
                                <option value="20">20</option>
                                <option value="50">50</option>
                                <option value="100">100</option>
                            </select>
                        </div>
                        <div class="col-lg-5">
                            <div class="mode-toggle"><span class="toggle-label">summary</span><paper-toggle-button checked="{{!summary}}"></paper-toggle-button><span class="toggle-label">details</span></div>
                        </div>
                    </div>
                    <paginator-element items="[[items]]" layout="publication-item" page-size="[[pageSize]]" bind-attribute="summary" bind-value="[[summary]]" from="{{from}}" to="{{to}}"></paginator-element>
                </template>
                <template is="dom-if" if="[[!items.length]]"><span class="grey-x">Nothing to show</span></template>
            </div>
        </div>
    </template>
    <script>
        Polymer({
            is: 'publications-view',
            properties: {
                nxConfig: {
                    type: Object,
                    value: {}
                },
                items: {
                    type: Array,
                    notify: true
                },
                types: {
                    type: Array,
                    value: ["curated", "additional", "submissions", "patents", "online-resources"]
                },
                count: {
                    type: Number,
                    notify: true
                },
                pageSize: {
                    type: Number,
                    value: 10
                },
                summary: {
                    type: Boolean,
                    value: true
                },
                _userPreferedPageSize: {
                    type: Number,
                    value: 10,
                    readOnly: true
                }

            },
            attached: function (){
                this.nx = new Nextprot.Client("neXtprot publications view", "Calipho Group");               
                this.pageSize = 100;
                this._userPreferedPageSize = localStorage.getItem(this._userPreferedPageSize);
                if(this._userPreferedPageSize != null) this.pageSize = this._userPreferedPageSize;
                console.log("PreferedPageSize: " + this._userPreferedPageSize);
                this.$.pubAPIcall.generateRequest();
           },
            _checkType: function(newValue, oldValue){
                this.async(function(){
                    if (this.types.indexOf(newValue) === -1) {
                        console.warn(this.nxConfig.pubType+" is not recognized as a valid publication type. "+oldValue+" publications will be displayed instead.");
                        //this.type = oldValue;
                   }
                });
            },
            _getHeader: function(){
                if (this.nxConfig.pubType==="curated") return "Curated publications";
                else if (this.nxConfig.pubType==="additional") return "Additional publications";
                else if (this.nxConfig.pubType==="submissions") return "Submissions";
                else if (this.nxConfig.pubType==="patents") return "Patents";
                else if (this.nxConfig.pubType==="online-resources") return "Online resources";
            },
            _changePageSize: function(evt){
                this.pageSize = new Number(evt.srcElement[evt.srcElement.selectedIndex].value);
                console.log(this.pageSize);
                localStorage.setItem(this._userPreferedpageSize, this.pageSize);
            },
            _pubResponse: function (data) {
                //console.log(data.detail.response.0);
                var publications = [];
                data.detail.response.forEach(function(publidata){
                //console.log(publidata.directLinks);
                publications.push(publidata);
                });
                this.header = this._getHeader();
                this.items = publications;
                this.count = publications.length;
                this.$.spinner.active = false;
            },
            _onPubError: function(error) {
                // catch any error that happened so far
                console.log("Argh, broken: " + err.message);
                console.log("Error at line : " + err.stack);
                this.$.spinner.active = false;
                this.count = 0;
            },
            _readJsonFile: function(file, callback) { // provided for testing from json files instead of API calls: this._readJsonFile("../NX_PO1308-CURATED.json", function(text){ var filedata = JSON.parse(text); ... filedata.forEach(function(publidata){...
                var rawFile = new XMLHttpRequest();
                rawFile.overrideMimeType("application/json");
                rawFile.open("GET", file, true);
                rawFile.onreadystatechange = function() {
                  if (rawFile.readyState === 4 && rawFile.status == "200") {
                       callback(rawFile.responseText);
                    }
                }
                rawFile.send(null);
            }

        });
    </script>
</dom-module>