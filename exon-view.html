<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="../iron-collapse/iron-collapse.html">

<link rel="import" href="exon-item.html">
<link rel="import" href="exons-mapping-table.html">
<link rel="import" href="gene-information-section.html">

<link rel="import" href="external-scripts.html">

<link rel="import" href="protein-overview.html">

<!--
`exon-view`
Exon view demo

@demo demo/exon-view-demo.html
-->
<dom-module id="exon-view">
    <template>
        <style include="nextprot-elements-shared-styles">
            :host {
                display: block;
                background:#f8f8f8;
            }
        </style>
        <div class="row">
            <div id="nxOverview" class="col-md-12">
                <protein-overview nx-config="[[nxConfig]]"></protein-overview>
            </div>
        </div>
        <div class="row">
            <div class="nxSection" class="col-md-12">
                <gene-information-section nx-config="[[nxConfig]]" non-aligned-isoforms="[[_nonAlignedIsoforms]]"
                                          start-exon-position="[[_startCodingPosition]]" stop-exon-position="[[_stopCodingPosition]]"></gene-information-section>
            </div>
        </div>
        <div class="row">
            <div class="nxSection" class="col-md-12">
                <exons-mapping-table data="[[data]]"></exons-mapping-table>
            </div>
        </div>
    </template>
    <script>
        Polymer({
            is: 'exon-view',
            properties: {
                nxConfig: {
                    type: Object,
                    value: {}
                },
                data: {
                    type: Object,
                    observer: "_calcFirstCodingPositions"
                },
                _nonAlignedIsoforms: {
                    type: Array,
                    value: []
                },
                _startCodingPosition: {
                    type: Number,
                    value: 0
                },
                _stopCodingPosition: {
                    type: Number,
                    value: 0
                }
            },
            attached: function () {

                this._initApiClient();

                var self = this;

                this._npClient.getJSON("/entry/" + this.nxConfig.entry + "/exon-mapping.json")
                    .then(function (response) {
                        self._handleResponseData(response);

                        self._npClient.getJSON("/entry/" + self.nxConfig.entry + "/isoform.json")
                            .then(function (response) {
                                self._handleNonAlignedIsoforms(response);
                            })
                            .catch(function (error) {
                                self._handleError(error);
                            });
                    })
                    .catch(function (error) {
                        self._handleError(error);
                    });
            },
            _initApiClient: function () {
                this._npClient = new Nextprot.Client("neXtProt publications", "Calipho Group");

                if (this.nxConfig.env) {
                    this._npClient.updateEnvironment(this.nxConfig.env);
                }
            },
            _handleResponseData: function (data) {
                this.data = data;
            },
            _handleNonAlignedIsoforms: function (data) {
                var self = this;

                var isoforms = data.entry.isoforms.filter(function(iso) {

                    return self.data.nonAlignedIsoforms.indexOf(iso.isoformAccession) !== -1;
                });

                this._nonAlignedIsoforms = isoforms.map(function (iso) {
                    return {
                        "name": iso.mainEntityName.name,
                        "accession": iso.isoformAccession
                    }
                });
            },
            _calcFirstCodingPositions: function (data) {

                this._startCodingPosition = (data.startExonPositions && data.startExonPositions.length > 0) ? data.startExonPositions[0] : 0;
                this._stopCodingPosition = (data.stopExonPositions && data.stopExonPositions.length > 0) ? data.stopExonPositions[0] : 0;
            },
            _handleError: function (error) {
                console.error("Error: ", error);
            }
        });
    </script>
</dom-module>