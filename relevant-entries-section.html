<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="../paper-spinner/paper-spinner-lite.html">
<link rel="import" href="../paper-toggle-button/paper-toggle-button.html">
<link rel="import" href="../paper-toast/paper-toast.html">
<link rel="import" href="../paper-button/paper-button.html">
<link rel="import" href="nextprot-elements-shared-styles.html">
<link rel="import" href="external-scripts.html">
<link rel="import" href="relevant-entries-section.html">

<link rel="import" href="paginator-element.html">
<link rel="import" href="entry-item.html">

<!--
`relevant-entries-section`

@demo demo/relevant-entries-section-demo.html
-->
<dom-module id="relevant-entries-section">
    <template>
        <style is="custom-style" include="nextprot-elements-shared-styles">
            :host {
                display: block;
                --paper-toggle-button-checked-button-color: #428bca;
                --paper-toggle-button-checked-bar-color: #428bca;
                background: #f8f8f8;
                overflow-y: auto;
            }

            .control-header {
                margin: 10px 0;
                padding-bottom: 10px;
                display: flex;
                border-bottom: 1px solid #E7EAEC;
            }

            .mode-toggle {
                display: inline-flex;
                margin-top: -3px;
            }

            .toggle-label {
                padding: 5px 10px 5px 3px;
            }

            .title-header {
                border-bottom: 1px solid rgb(170, 170, 170);
                font-weight: 500;
                font-size: 1.8em;
            }

            .padded-bottom {
                padding-bottom: 10px;
            }

            .padded-top {
                padding-top: 5px;
            }

            .more-bottom-margin {
                margin-bottom: 5px;
            }

            a.disabled {
                pointer-events: none;
                color: black;
                font-weight: bolder;
            }

            .bg-grey {
                background: #F3F3F3;
                border-radius: 5px;
                margin-right: 5px;
                padding: 2px;
            }

            .over-threshold-warning {
                color: #906013;
                font-size: 12px;
                font-weight: 900;
                margin-left: 5px;
            }

        </style>
        <div class="row">
            <div class="col-md-12">
                <div class="title-header">
                    Relevant for
                </div>
                <template is="dom-if" if="[[entries.length]]">
                    <div class="control-header">
                        <div class="no-padding col-lg-5">
                            <template is="dom-if" if="[[entries]]">
                                Proteins [[from]] to [[to]] of [[entries.length]]
                            </template>
                            <template is="dom-if" if="[[_beyondMaximumEntries(data.relatedEntryCount)]]">
                                <span class="over-threshold-warning" title="The first 500 most relevant entries were displayed below."><span class="fa fa-exclamation-circle"></span> over [[data.relatedEntryCount]]</span>
                            </template>
                        </div>
                        <div class="col-lg-10 ">
                            <span class="col-lg-2">
                                show&nbsp;
                                <select on-change="_changePageSize">
                                    <template is="dom-repeat" items="{{pageSizeOptions}}" as="pageSizeOption">
                                        <option value="{{pageSizeOption}}"
                                                selected$="{{_isPageSizeOptionSelected(pageSizeOption)}}">{{pageSizeOption}}
                                        </option>
                                    </template>
                                </select>
                            </span>
                            <span class="bg-grey">
                                <a id="summary-link" class$="[[_summaryLinkClass]]" role="button" on-click="_updateLinks">summary</a> |
                                <a id="details-link" class$="[[_detailsLinkClass]]" role="button" on-click="_updateLinks">details</a>
                            </span>
                        </div>
                    </div>

                    <paginator-element items="[[entries]]" layout="entry-item"
                                       page-size="[[pageSize]]" bind-attribute="summary" bind-value="[[summary]]"
                                       from="{{from}}" to="{{to}}"></paginator-element>
                </template>
                <template is="dom-if" if="[[!entries.length]]"><span class="grey-x">Nothing to show</span></template>
            </div>
        </div>
    </template>
    <script>
        Polymer({
            is: 'relevant-entries-section',
            properties: {
                entries: {
                    type: Array,
                    notify: true
                },
                summary: {
                    type: Boolean,
                    value: false
                },
                count: {
                    type: Number,
                    notify: true
                },
                pageSize: {
                    type: Number
                },
                pageSizeOptions: {
                    type: Array,
                    value: [10, 20, 50, 100]
                },
                _preferedPageSizeName: {
                    type: String,
                    value: "publications-with-linked-entries-view.prefered-size",
                    readOnly: true
                },
                _summaryLinkClass: {
                    type: String,
                    value: ""
                },
                _detailsLinkClass: {
                    type: String,
                    value: "disabled"
                }
            },
            attached : function (){

                console.log("Paf, " + this.entries)

                /*this.entries = [ {

                        "accession": "NX_Q96PF1",
                        "citedInViews": {
                            "Medical": "/entry/NX_Q96PF1/medical",
                            "Sequence": "/entry/NX_Q96PF1/sequence",
                            "Structures": "/entry/NX_Q96PF1/structures"
                        },
                        "protein_existence": "Evidence_at_transcript_level",
                        "recommended_ac": "Q96PF1",
                        "isoform_num": 1,
                        "filters": "filterexpressionprofile filterproteomics",
                        "uniprot_name": [
                            "TGM7_HUMAN"
                        ],
                        "gene_band": [
                            "q15.2 15q15.2"
                        ],
                        "recommended_gene_names": "TGM7",
                        "score": 0.027259713,
                        "recommended_name": "Protein-glutamine gamma-glutamyltransferase Z",
                        "var_num": 469,
                        "function_desc": [
                            "Catalyzes the cross-linking of proteins and the conjugation of polyamines to proteins."
                        ],
                        "chr_loc": "15q15.2",
                        "id": "NX_Q96PF1",
                        "aa_length": 710,
                        "ec_name": "EC 2.3.2.13"
                    },
                    {
                        "accession": "NX_Q53GT1",
                        "citedInViews": {
                            "Medical": "/entry/NX_Q53GT1/medical",
                            "Sequence": "/entry/NX_Q53GT1/sequence",
                            "Structures": "/entry/NX_Q53GT1/structures"
                        },
                        "protein_existence": "Evidence_at_protein_level",
                        "recommended_ac": "Q53GT1",
                        "isoform_num": 2,
                        "ptm_num": 10,
                        "filters": "filterexpressionprofile filterproteomics",
                        "uniprot_name": [
                            "KLH22_HUMAN"
                        ],
                        "gene_band": [
                            "q11.21 22q11.21"
                        ],
                        "recommended_gene_names": "KLHL22",
                        "score": 0.027259713,
                        "recommended_name": "Kelch-like protein 22",
                        "var_num": 269,
                        "function_desc": [
                            "Substrate-specific adapter of a BCR (BTB-CUL3-RBX1) E3 ubiquitin ligase complex required for chromosome alignment and localization of PLK1 at kinetochores. The BCR(KLHL22) ubiquitin ligase complex mediates monoubiquitination of PLK1, leading to PLK1 dissociation from phosphoreceptor proteins and subsequent removal from kinetochores, allowing silencing of the spindle assembly checkpoint (SAC) and chromosome segregation. Monoubiquitination of PLK1 does not lead to PLK1 degradation."
                        ],
                        "chr_loc": "22q11.21",
                        "id": "NX_Q53GT1",
                        "aa_length": 634,
                        "ec_name": ""
                    }
                ]*/

            },
            attached: function () {
                this.pageSize = this._getPreferedPageSizeFromLocalStorage();
            },
            _isPageSizeOptionSelected: function (pageSizeValue) {

                return this._getPreferedPageSizeFromLocalStorage() == pageSizeValue;
            },
            _getPreferedPageSizeFromLocalStorage: function () {

                var localStorageSizeValue = localStorage.getItem(this._preferedPageSizeName);

                // does not exist
                if (localStorageSizeValue === null) {
                    localStorageSizeValue = 10;
                    localStorage.setItem(this._preferedPageSizeName, localStorageSizeValue);
                }

                return parseInt(localStorageSizeValue);
            },
            _changePageSize: function (evt) {
                this.pageSize = parseInt(evt.target[evt.target.selectedIndex].value);
                localStorage.setItem(this._preferedPageSizeName, this.pageSize);
            },
            _handleError: function (error) {
                console.error("Error: ", error);
                this.$.spinner.active = false;
                this.$.spinner.hidden = true;

                this.count = 0;
            },
            _toView: function (summary) {
                return (summary) ? "summary" : "detailed";
            },
            _beyondMaximumEntries: function (count) {
                return count > 500;
            },
            _updateLinks: function (evt) {
                this.summary = (evt.target.id === "summary-link");

                if (this.summary) {
                    this._detailsLinkClass = "";
                    this._summaryLinkClass = "disabled";
                }
                else {
                    this._detailsLinkClass = "disabled";
                    this._summaryLinkClass = "";
                }
            }
        });
    </script>
</dom-module>
