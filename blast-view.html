<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="blast-item.html">
<link rel="import" href="../iron-selector/iron-selector.html">
<link rel="import" href="../paper-toggle-button/paper-toggle-button.html">
<link rel="import" href="../paper-spinner/paper-spinner-lite.html">
<link rel="import" href="paginator-element.html">
<link rel="import" href="blast-styles.html">
<link rel="import" href="d3-styles.html">
<script>
    //Load JQuery if necessary
    if(typeof jQuery === "undefined"){
        (function(){
            var newscript = document.createElement('script');
            newscript.src = '../../jquery/dist/jquery.min.js';
            document.getElementsByTagName('head')[0].appendChild(newscript);
        })();
    }
</script>
<script src="../nextprot/src/nextprot-core.js"></script>
<script src="../nextprot/src/nextprot-utils.js"></script>
<script src="../d3/d3.min.js"></script>
<script src="http://benschmidt.org/colorbar/colorbar.js"></script>
<!--
`blast-view`
View presenting blast search results annotations.

#### Example

          <blast-view nx-config='{"entry": "P52701"}'></blast-view>

@demo demo/blast-view-demo.html
-->
<dom-module id="blast-view">
    <template>
        <style include="blast-styles">
            :host {
                display: block;
                overflow-y: auto;
                background: #ffffff;
                padding: 10px;
            }
            p {
                margin: 0 0 5px;
            }
            .mode-toggle {
                display: inline-flex;
                margin-top: -3px;
            }
            .toggle-label {
                padding: 5px 10px 5px 3px;
            }
            #blastParametersContainer {
                background-color: white;
                border-bottom: solid grey 1px;
                padding-left: 15px;
            }
            .control-header {
                margin: 10px 0 50px;
            }
        </style>
            <div id="blastParametersContainer">
                <paper-spinner-lite id="spinner" active></paper-spinner-lite>
                <template is="dom-if" if="[[params]]">
                    <p><b>Blast</b></p>
                    <p><span class="quiet bold">
                        <template is="dom-if" if="[[entry]]">from protein [[entry]]</template>
                        <template is="dom-if" if="[[isoform]]">, isoform [[isoform]]</template>
                    </span></p>
                    <p>
                        <span class="quiet bold">Blast sequence</span>
                        <span class="black pre">[[_shortenedSequence()]]</span>
                        <span class="quiet bold">([[params.sequence.length]] AA)</span>
                    </p>
                    <div class="quiet">
                        <p>Query in all human sequences in neXtProt ([[params.db_num]] sequences, [[params.db_len]] amino acids)</p>
                        <p>Similarity matrix: [[params.matrix]]</p>
                        <p>Expect: [[params.expect]]; filter: [[_getFilterState()]]; gap-open: [[params.gap_open]]; gap-extend: [[params.gap_extend]]</p>
                        <p>Program version: [[params.version]]</p>
                    </div>
                </template>
                <div id="chart"></div>
                <span class="quiet bold">[[params.message]]</span>
            </div>
            <template is="dom-if" if="[[results.length]]">
                <div class="column control-header">
                    <div class="col-lg-6">Sequences [[from]] to [[to]] of [[results.length]]</div>
                    <div class="col-lg-1">
                        show&nbsp;
                        <select on-change="_changePageSize">
                            <option value="10">10</option>
                            <option value="20">20</option>
                            <option value="50">50</option>
                            <option value="100">100</option>
                        </select>
                    </div>
                    <div class="col-lg-2">
                        <div class="mode-toggle"><span class="toggle-label">summary</span><paper-toggle-button checked="{{showAlignment}}"></paper-toggle-button><span class="toggle-label">alignments</span></div>
                    </div>
                </div>
                <div class="beanlist-beans-header column span-24">
                    <div class="column nomargin">
                        <div class="col-lg-6 bold">Query hit (click to show/hide alignment)</div>
                        <div class="col-lg-2 bold">Target hit</div>
                        <div class="col-lg-1 nomargin hright bold">Target len</div>
                        <div class="col-lg-1 nomargin hright bold">Identity</div>
                        <div class="col-lg-1 nomargin hright bold">Tot. score</div>
                        <div class="col-lg-1 hright bold">E-value</div>
                    </div>
                </div>
            </template>
            <div class="col-lg-12">
                <paginator-element items="{{results}}" layout="blast-item" bind-attribute="showAlignment" bind-value="[[showAlignment]]" page-size="[[pageSize]]" from="{{from}}" to="{{to}}"></paginator-element>
            </div>
    </template>
    <script>
        Polymer({
            is: 'blast-view',
            properties: {
                nxConfig: {
                    type: Object,
                    value: {}
                },
                sequence: {
                    type: String
                },
                title: {
                    type: String,
                    value: "blast"
                },
                isoform: {
                    type: String
                },
                begin: {
                    type: Number
                },
                end: {
                    type: Number
                },
                matrix: {
                    type: String,
                    value: "BLOSUM62",
                    observer: "_checkMatrix"
                },
                evalue: {
                    type: Number,
                    value: 0.05
                },
                gapopen: {
                    type: Number,
                    value: 11
                },
                gapextend: {
                    type: Number,
                    value: 1
                },
                showAlignment: {
                    type: Boolean,
                    value: false
                },
                pageSize: {
                    type: Number,
                    value: 10
                },
                results: {
                    type: Array,
                    notify: true
                }
            },
            attached: function(){
                var nx = new Nextprot.Client("neXtProt blast view", "Calipho Group");
                if (this.nxConfig.isoform) this.isoform = this.nxConfig.isoform;
                if (this.nxConfig.sequence) this.sequence = this.nxConfig.sequence;
                if (this.nxConfig.begin) this.begin = this.nxConfig.begin;
                if (this.nxConfig.end) this.end = this.nxConfig.end;
                var self=this;
                if (this.isoform) {
                    nx.getBlastByIsoform(this.isoform, this.matrix, this.evalue, this.gapopen, this.gapextend, this.begin, this.end)
                        .then(function(response){self._processResponse(response)});
                    this.entry = this.isoform.split("-")[0];
                } else if(this.sequence){
                    nx.getBlastBySequence(this.sequence, this.title, this.matrix, this.evalue, this.gapopen, this.gapextend)
                        .then(function(response){self._processResponse(response)});
                    this.entry = this.nxConfig.entry;
                    this.isoform = "";
                }
            },
            _processResponse: function(response){
                this.$.spinner.active = false;
                this.$.spinner.style = "display:none;";
                if (response.error) {
                    this.$.blastParametersContainer.innerHTML = '<span class="quiet bold">'+Object.values(response.error.causes)+'</span>';
                    return false;
                }
                this._colorScale();
                for (var i in response.data.results.search.hits) {
                    response.data.results.search.hits[i].queryLength =  response.data.params.sequence.length;
                    for (var j in response.data.results.search.hits[i].hsps){
                        response.data.results.search.hits[i].hsps[j].color = this.scale(response.data.results.search.hits[i].hsps[j].identity_percent);
                    }
                }
                response.data.params.version = response.data.version;
                response.data.params.db_num = response.data.results.search.stat.db_num;
                response.data.params.db_len = response.data.results.search.stat.db_len;
                response.data.params.message = response.data.results.search.message;
                this.params=response.data.params;
                var self=this;
                this.async(function(){self.results = response.data.results.search.hits;});

            },
            _checkMatrix: function(newValue, oldValue){
                var matrices = ["BLOSUM45", "BLOSUM50", "BLOSUM62", "BLOSUM80", "BLOSUM90", "PAM250", "PAM30", "PAM70"];
                if (matrices.indexOf(newValue) === -1) {
                    console.warn(this.matrix+" is not recognized as a valid BLAST substitution matrix. "+oldValue+" matrix will be used instead.");
                    this.matrix = oldValue;
                }
            },
            _colorScale: function(){
                var svg = d3.select(this).select("#chart").append("svg")
                        .attr("width",600).attr("height",50)
                        .append("text").text("Color code for identity (%)").attr("x", 0).attr("y", 20);

                this.scale = d3.scale.linear().range(["red","orange","yellow","green"]).domain([0,35,70,100]);

                colorbar = Colorbar()
                        .origin([190,5])
                        .scale(this.scale).barlength(400).thickness(10)
                        .orient("horizontal");

                bar = d3.select(this).select("#chart").select("svg").append("g").attr("id", "colorbar");

                this.colorbarObject = d3.select(this).select("#colorbar").call(colorbar);

            },
            _shortenedSequence: function(){
                var sequenceLength = this.params.sequence.length;
                if (sequenceLength>55) return this.params.sequence.substring(0,27)+"..."+this.params.sequence.substring(sequenceLength-27, sequenceLength)
                return this.params.sequence;
            },
            _getFilterState: function(){
                return this.params.filter === "F" ? "false" : "true";
            },
            _changePageSize: function(evt){
                this.pageSize = new Number(evt.srcElement[evt.srcElement.selectedIndex].value);
            },
            pointIdentity: function(identity){
                this.colorbarObject.pointTo(identity)
            }
        });
    </script>
</dom-module>