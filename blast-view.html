<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="blast-item.html">
<link rel="import" href="../iron-selector/iron-selector.html">
<link rel="import" href="../paper-toggle-button/paper-toggle-button.html">
<link rel="import" href="../pagination-table/pagination-table.html">
<link rel="import" href="blast-styles.html">
<link rel="import" href="d3-styles.html">
<script>
    //Load JQuery if necessary
    if(typeof jQuery === "undefined"){
        (function(){
            var newscript = document.createElement('script');
            newscript.src = '../../jquery/dist/jquery.min.js';
            document.getElementsByTagName('head')[0].appendChild(newscript);
        })();
    }
</script>
<script src="../nextprot-js/src/nextprot-core.js"></script>
<script src="../nextprot-js/src/nextprot-utils.js"></script>
<script src="../d3/d3.min.js"></script>
<script src="http://benschmidt.org/colorbar/colorbar.js"></script>
<!--
`blast-view`
View presenting blast search results annotations.

#### Example

          <blast-view nx-config='{"entry": "P52701"}'></blast-view>

@demo demo/blast-view-demo.html
-->
<dom-module id="blast-view">
    <template>
        <style include="blast-styles">
            :host {
                display: block;
                overflow-y: auto;
            }
            p {
                margin: 0 0 5px;
            }
            .mode-toggle {
                display: inline-flex;
                margin-top: -3px;
            }
            .toggle-label {
                padding: 5px 10px 5px 3px;
            }
            .blast-parameters {
                background-color: white;
                border-bottom: solid grey 1px;
            }
            .control-header {
                margin: 10px 0 50px;
            }
        </style>
            <div class="blast-parameters">
                <template is="dom-if" if="[[data]]">
                    <p><b>Blast</b></p>
                    <p><span class="quiet bold">from protein [[entry]]</span><template is="dom-if" if="[[isoform]]">, isoform [[isoform]]</template></p>
                    <p><span class="quiet bold">Blast sequence</span>  <span class="black pre">[[_shortenedSequence()]]</span> <span class="quiet bold">([[data.params.sequence.length]] AA)</span></p>
                    <div class="quiet">
                        <p>Query in all human sequences in neXtProt ([[data.results.search.stat.db_num]] sequences, [[data.results.search.stat.db_len]] amino acids)</p>
                        <p>Similarity matrix: [[data.params.matrix]]</p>
                        <p>Expect: [[data.params.expect]]; filter: [[_getFilterState()]]; gap-open: [[data.params.gap_open]]; gap-extend: [[data.params.gap_extend]]</p>
                        <p>Program version: [[data.version]]</p>
                    </div>
                </template>
                <div id="chart"></div>
            </div>
            <div class="column control-header">
                <div class="col-lg-6">Sequences [[from]] to [[to]] of [[results.length]]</div>
                <div class="col-lg-1">
                    show&nbsp;
                    <select on-change="_changePageSize">
                        <option value="10">10</option>
                        <option value="20">20</option>
                        <option value="50">50</option>
                        <option value="100">100</option>
                    </select>
                </div>
                <div class="col-lg-2">
                    <div class="mode-toggle"><span class="toggle-label">summary</span><paper-toggle-button checked="{{showAlignment}}"></paper-toggle-button><span class="toggle-label">alignments</span></div>
                </div>
            </div>
            <div class="beanlist-beans-header column span-24">
                <div class="column nomargin">
                    <div class="col-lg-6 bold">Query hit (click to show/hide alignment)</div>
                    <div class="col-lg-2 bold">Target hit</div>
                    <div class="col-lg-1 nomargin hright bold">Target len</div>
                    <div class="col-lg-1 nomargin hright bold">Identity</div>
                    <div class="col-lg-1 nomargin hright bold">Tot. score</div>
                    <div class="col-lg-1 hright bold">E-value</div>
                </div>
            </div>
            <div class="col-lg-12">
                <pagination-table items="{{results}}" layout="blast-item" bind-attribute="showAlignment" bind-value="[[showAlignment]]" page-size="[[pageSize]]" from="{{from}}" to="{{to}}"></pagination-table>
            </div>
    </template>
    <script>
        Polymer({
            is: 'blast-view',
            properties: {
                nxConfig: {
                    type: Object,
                    value: {}
                },
                sequence: {
                    type: String,
                    //value: "MSHHWGYGKHNGPEHWHKDFPIAKGERQSPVDIDTHTAKYDPSLKPLSVSYDQATSLRILNNGHAFNVEFDDSQDKAVLKGGPLDGTYRLIQFHFHWGSLDGQGSEHTVDKKKYAAELHLVHWNTKYGDFGKAVQQPDGLAVLGIFLKVGSAKPGLQKVVDVLDSIKTKGKSADFTNFDPRGLLPESLDYWTYPGSLTTPPLLECVTWIVLKEPISVSSEQVLKFRKLNFNGEGEPEELMVDNWRPAQPLKNRQIKASFK"
                    value: "MDLSALRVEEVQNVINAMQKILECPICLELIKEPVSTKCDHIFCKFCMLKLLNQKKGPSQCPLCKNDITKRSLQESTRFSQLVEELLKIICAFQLDTGLEYANSYNFAKKENNSPEHLKDEVSIIQSMGYRNRAKRLLQSEPENPSLQETSLSVQLSNLGTVRTLRTKQRIQPQKTSVYIELGSDSSEDTVNKATYCSVGDQELLQITPQGTRDEISLDSAKKAACEFSETDVTNTEHHQPSNNDLNTTEKRAAERHPEKYQGSSVSNLHVEPCGTNTHASSLQHENSSLLLTKDRMNVEKAEFCNKSKQPGLARSQHNRWAGSKETCNDRRTPSTEKKVDLNADPLCERKEWNKQKLPCSENPRDTEDVPWITLNSSIQKVNEWFSRSDELLGSDDSHDGESESNAKVADVLDVLNEVDEYSGSSEKIDLLASDPHEALICKSERVHSKSVESNIEDKIFGKTYRKKASLPNLSHVTENLIIGAFVTEPQIIQERPLTNKLKRKRRPTSGLHPEDFIKKADLAVQKTPEMINQGTNQTEQNGQVMNITNSGHENKTKGDSIQNEKNPNPIESLEKESAFKTKAEPISSSISNMELELNIHNSKAPKKNRLRRKSSTRHIHALELVVSRNLSPPNCTELQIDSCSSSEEIKKKKYNQMPVRHSRNLQLMEGKEPATGAKKSNKPNEQTSKRHDSDTFPELKLTNAPGSFTKCSNTSELKEFVNPSLPREEKEEKLETVKVSNNAEDPKDLMLSGERVLQTERSVESSSISLVPGTDYGTQESISLLEVSTLGKAKTEPNKCVSQCAAFENPKGLIHGCSKDNRNDTEGFKYPLGHEVNHSRETSIEMEESELDAQYLQNTFKVSKRQSFAPFSNPGNAEEECATFSAHSGSLKKQSPKVTFECEQKEENQGKNESNIKPVQTVNITAGFPVVGQKDKPVDNAKCSIKGGSRFCLSSQFRGNETGLITPNKHGLLQNPYRIPPLFPIKSFVKTKCKKNLLEENFEEHSMSPEREMGNENIPSTVSTISRNNIRENVFKEASSSNINEVGSSTNEVGSSINEIGSSDENIQAELGRNRGPKLNAMLRLGVLQPEVYKQSLPGSNCKHPEIKKQEYEEVVQTVNTDFSPYLISDNLEQPMGSSHASQVCSETPDDLLDDGEIKEDTSFAENDIKESSAVFSKSVQKGELSRSPSPFTHTHLAQGYRRGAKKLESSEENLSSEDEELPCFQHLLFGKVNNIPSQSTRHSTVATECLSKNTEENLLSLKNSLNDCSNQVILAKASQEHHLSEETKCSASLFSSQCSELEDLTANTNTQDPFLIGSSKQMRHQSESQGVGLSDKELVSDDEERGTGLEENNQEEQSMDSNLGEAASGCESETSVSEDCSGLSSQSDILTTQQRDTMQHNLIKLQQEMAELEAVLEQHGSQPSNSYPSIISDSSALEDLRNPEQSTSEKAVLTSQKSSEYPISQNPEGLSADKFEVSADSSTSKNKEPGVERSSPSKCPSLDDRWYMHSCSGSLQNRNYPSQEELIKVVDVEEQQLEESGPHDLTETSYLPRQDLEGTPYLESGISLFSDDPESDPSEDRAPESARVGNIPSSTSALKVPQLKVAESAQSPAAAHTTDTAGYNAMEESVSREKPELTASTERVNKRMSMVVSGLTPEEFMLVYKFARKHHITLTNLITEETTHVVMKTDAEFVCERTLKYFLGIAGGKWVVSYFWVTQSIKERKMLNEHDFEVRGDVVNGRNHQGPKRARESQDRKIFRGLEICCYGPFTNMPTDQLEWMVQLCGASVVKELSSFTLGTGVHPIVVVQPDAWTEDNGFHAIGQMCEAPVVTREWVLDSVALYQCQELDTYLIPQIPHSHY"
                },
                title: {
                    type: String,
                    value: "blast"
                },
                isoform: {
                    type: String
                },
                matrix: {
                    type: String,
                    value: "BLOSUM62"
                },
                evalue: {
                    type: Number,
                    value: 0.05
                },
                gapopen: {
                    type: Number,
                    value: 11
                },
                gapextend: {
                    type: Number,
                    value: 1
                },
                showAlignment: {
                    type: Boolean,
                    value: false
                },
                pageSize: {
                    type: Number,
                    value: 10
                },
                results: {
                    type: Array,
                    notify: true
                }
            },
            attached: function(){
                var nx = new Nextprot.Client("neXtProt blast view", "Calipho Group");
                this.entry = nx.getEntryName(this.nxConfig.entry);
                var self=this;
                nx.getBlastBySequence(this.sequence, this.title, this.matrix, this.evalue, this.gapopen, this.gapextend)
                    .then(function (response) {
                        self.data=response.data;
                        for (var i in self.data.results.search.hits) {
                            for (var j in self.data.results.search.hits[i].hsps){
                                self.data.results.search.hits[i].hsps[j].color = self.scale(self.data.results.search.hits[i].hsps[j].identity_percent);
                            }
                        }
                        self.async(function(){self.results = self.data.results.search.hits;});
                    });
                this._colorScale();
            },
            _colorScale: function(){
                var svg = d3.select(this).select("#chart").append("svg")
                        .attr("width",600).attr("height",50)
                        .append("text").text("Color code for identity (%)").attr("x", 0).attr("y", 20);

                this.scale = d3.scale.linear().range(["red","orange","yellow","green"]).domain([0,35,70,100]);

                colorbar = Colorbar()
                        .origin([190,5])
                        .scale(this.scale).barlength(400).thickness(10)
                        .orient("horizontal");

                bar = d3.select(this).select("#chart").select("svg").append("g").attr("id", "colorbar");

                this.colorbarObject = d3.select(this).select("#colorbar").call(colorbar);

            },
            _shortenedSequence: function(){
                var sequenceLength = this.data.params.sequence.length;
                if (sequenceLength>55) return this.data.params.sequence.substring(0,27)+"..."+this.data.params.sequence.substring(sequenceLength-27, sequenceLength)
                return this.data.params.sequence;
            },
            _getFilterState: function(){
                return this.data.params.filter === "F" ? "false" : "true";
            },
            _changePageSize: function(evt){
                this.pageSize = new Number(evt.srcElement[evt.srcElement.selectedIndex].value);
            },
            pointIdentity: function(identity){
                this.colorbarObject.pointTo(identity)
            }
        });
    </script>
</dom-module>