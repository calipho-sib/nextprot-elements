<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="../iron-collapse/iron-collapse.html">
<link rel="import" href="external-scripts.html">

<link rel="import" href="nextprot-elements-shared-styles.html">

<!--
`gene-information-section`
gene information section demo

@demo demo/gene-information-section-demo.html
-->
<dom-module id="gene-information-section">
    <template>
        <style include="nextprot-elements-shared-styles">

            :host{
                white-space: nowrap;
            }

            #infoTable {
                border: solid lightgray 1px;
                width:auto;
                font-size: 95%;
            }
            #infoTable thead {
                background-color: #f8f8f8;
                border-bottom:0;
                border-top:1px solid lightgray;
                border-left:1px solid #ddd;
                border-right:1px solid #ddd;
            }

            #infoTable th {
                text-align: center;
                vertical-align: top;
                border-right:1px solid #ddd;
                border-left:1px solid #ddd;
                border-bottom:0;
            }

            .bg-blue-light-xx {
                background-color: #F3F5FC;
                color: #444;
                border: #ebeffa 1px solid;
                -webkit-border-radius: 5px;
                margin: 10px 5px;
                padding: 5px;
                width: auto;
                display: inline-block;
            }

            #infoTable td {
                text-align: left;
                border-left:1px solid #ddd;
                border-right:1px solid #ddd;
                border-bottom:0;
                border-top:0;
            }

            h3 {
                text-align: left;
            }

            .gray-x {
                color: #999;
                padding-right: 20px;
                text-transform: uppercase;
            }

            .tableDiv {
                overflow: auto;
            }

            #mappingTable {
                margin-bottom: 10px;
                font-size: 95%;
            }
        </style>
        <template is="dom-if" if="[[_locations]]">
            <div class="category-header">
                <h4 class="category-title">Gene information</h4>
            </div>

            <div class="tableDiv">
            <div>
                <table id="infoTable" class="table">
                    <thead>
                    <tr>
                        <th style="text-align:left;">Gene</th>
                        <th style="text-align:left;">Chromosomal location</th>
                        <th style="text-align:left;">Orientation</th>
                        <th>Position on chromosome</th>
                        <th style="text-align:right;">Length</th>
                        <th style="text-align:left;">Ensembl</th>
                    </tr>
                    </thead>
                    <tbody>
                    <template is="dom-repeat" items="[[_getSortedLocations(_locations)]]" as="location">
                        <tr>
                            <td style="text-align:left;">[[_formatGeneName(location)]]</td>
                            <td style="text-align:left;">[[location.prettyLocation]]</td>
                            <td style="text-align:left;">[[_formatOrientation(location)]]</td>
                            <td style="text-align:center">[[_formatLocation(location)]]</td>
                            <td style="text-align:right">[[_formatLength(location.firstPosition, location.lastPosition)]]</td>
                            <td style="text-align:left"><span inner-h-t-m-l=[[_createEnsemblHtmlLink(location)]]></span></td>
                        </tr>
                    </template>
                    </tbody>
                </table>
            </div>

            <template is="dom-if" if="[[_chosenLocation]]">
                <table id="mappingTable">
                    <tbody>
                        <template is="dom-if" if="[[_multipleLocations(_locations)]]">
                            <tr>
                                <td class="gray-x">Mapping</td>
                                <td>This protein has [[_locations.length]] Ensembl mappings.</td>
                            </tr>
                            <tr>
                                <td class="gray-x">Alignment</td>
                                <td>The isoform is aligned on <a class="ext-link" href="http://www.ensembl.org/Homo_sapiens/Gene/Summary?db=core;g=[[_chosenLocation.accession]]" rel="nofollow">&nbsp;[[_chosenLocation.accession]]</a>.</td>
                            </tr>
                        </template>
                        <tr>
                            <template is="dom-if" if="[[!_isPositionDefined(_chosenLocation)]]">
                                <div class="bg-blue-light-xx">
                                Gene not mapped on the current assembly of the human genome.
                                </div>
                            </template>
                            <template is="dom-if" if="[[_isPositionDefined(_chosenLocation)]]">
                                <td class="gray-x">Coding positions</td>
                                <td>From [[_numberWithCommas(_startCodingPosition)]] to [[_numberWithCommas(_stopCodingPosition)]]
                                [length: [[_formatLength(_startCodingPosition, _stopCodingPosition)]] bp]</td>
                            </template>
                        </tr>
                    </tbody>
                </table>
            </template>

            <!-- non aligned isoforms -->
            <template is="dom-if" if="[[_hasNonAlignedIso(nonAlignedIsoforms)]]">
                <div class="bg-blue-light-xx">
                    <template is="dom-if" if="[[_hasSingleNonAlignedIso(nonAlignedIsoforms)]]">
                        <template is="dom-repeat" items="[[nonAlignedIsoforms]]" as="nonAlignedIso">
                            <div>
                            <span>Isoform
                            <a href="https://www.nextprot.org/entry/[[nonAlignedIso.accession]]/sequence">[[nonAlignedIso.name]]</a>
                            is not aligned on gene.</span>
                            </div>
                        </template>
                    </template>

                    <template is="dom-if" if="[[_hasMultipleNonAlignedIso(nonAlignedIsoforms)]]">
                        <span>Isoforms
                        <template is="dom-repeat" items="[[nonAlignedIsoforms]]" as="nonAlignedIso">
                            <span>
                                <a href="https://www.nextprot.org/entry/[[nonAlignedIso.accession]]/sequence">[[nonAlignedIso.name]]</a><template style="white-space: nowrap;" is="dom-if" if="[[!_isLastIndex(nonAlignedIsoforms, index)]]">,</template>
                            </span>
                        </template>
                            are not aligned on gene.</span>
                    </template>
                </div>
            </template>
            </div>
        </template>
        </div>
    </template>
    <script>
        Polymer({
            is: 'gene-information-section',
            properties: {
                nxConfig: {
                    type: Object,
                    value: {}
                },
                nonAlignedIsoforms: {
                    type: Array,
                    value: []
                },
                startExonPosition: {
                    type: Number,
                    value: 0,
                    observer: "_calcCodingPositions"
                },
                stopExonPosition: {
                    type: Number,
                    value: 0,
                    observer: "_calcCodingPositions"
                },
                _locations: {
                    type: Array
                },
                _chosenLocation: {
                    type: Object,
                    observer: "_calcCodingPositions"
                },
                _startCodingPosition: {
                    type: Number,
                    value: 0
                },
                _stopCodingPosition: {
                    type: Number,
                    value: 0
                }
            },
            attached: function () {
                this._initApiClient();

                var self = this;

                this._npClient.getJSON("/entry/" + this.nxConfig.entry + "/chromosomal-location.json")
                    .then(function (response) {
                        self._handleResponseData(response);
                    })
                    .catch(function (error) {
                        self._handleError(error);
                    });
            },
            _initApiClient: function () {
                this._npClient = new Nextprot.Client("neXtProt protein overview", "Calipho Group");

                if (this.nxConfig.env) {
                    this._npClient.updateEnvironment(this.nxConfig.env);
                }
            },
            _handleResponseData: function (data) {

                this._locations = data.entry.chromosomalLocations;
                this._chosenLocation = this._locations
                    .filter(function(location) {
                        return location.bestGeneLocation;
                    })
                    .reduce(function(locations) {
                        return (locations.length > 0) ? locations[0] : null;
                    });
            },
            _handleError: function (error) {
                console.error("Error: ", error);
            },
            _formatOrientation: function (location) {

                if (location.firstPosition === 0 && location.lastPosition === 0) {
                    return "";
                }

                if (location.strand === 1) {
                    return "plus strand"
                }
                else if (location.strand === -1) {
                    return "minus strand";
                }
                return "";
            },
            _formatLocation: function (location) {

                if (location.firstPosition === 0 && location.lastPosition === 0) {
                    return "";
                }

                return this._numberWithCommas(location.firstPosition)+ " - " + this._numberWithCommas(location.lastPosition);
            },
            _formatGeneName: function (location) {

                if (location.firstPosition === 0 && location.lastPosition === 0) {
                    return "";
                }

                return (location.recommendedName) ? location.recommendedName : "-";
            },
            _formatLength: function (firstPos, lastPos) {

                if (firstPos === 0 && lastPos === 0) {
                    return "";
                }

                return this._numberWithCommas(lastPos - firstPos + 1);
            },
            _numberWithCommas: function (x) {
                return x.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",");
            },
            _multipleLocations: function (locations) {
                return locations.length > 1;
            },
            _createEnsemblHtmlLink: function (location) {

                if (location.firstPosition === 0 && location.lastPosition === 0) {
                    return "";
                }

                return '<a class="ext-link" target="_blank" href="http://www.ensembl.org/Homo_sapiens/Gene/Summary?db=core;g='+location.accession+'">'+location.accession+'</a>';
            },
            _isPositionDefined: function (location) {

                return location.firstPosition > 0 && location.lastPosition > 0;
            },
            _hasNonAlignedIso: function (nonAlignedIsoforms) {

                return nonAlignedIsoforms && nonAlignedIsoforms.length > 0;
            },
            _hasSingleNonAlignedIso: function (nonAlignedIsoforms) {

                return nonAlignedIsoforms && nonAlignedIsoforms.length === 1;
            },
            _hasMultipleNonAlignedIso: function (nonAlignedIsoforms) {

                return nonAlignedIsoforms && nonAlignedIsoforms.length > 1;
            },
            _isLastIndex: function (nonAlignedIsoforms, index) {

                return index === nonAlignedIsoforms.length-1;
            },
            _getSortedLocations: function(locations) {
                return locations.sort(function(loc1, loc2) {

                    if (!loc1) {
                        return 1;
                    }
                    else if (!loc2) {
                        return -1;
                    }
                    if (loc1.recommendedName < loc2.recommendedName) {
                        return -1;
                    }
                    else if (loc1.recommendedName > loc2.recommendedName) {
                        return 1;
                    }
                    return 0;
                });
            },
            _calcCodingPositions: function (location) {

                this._startCodingPosition = location.firstPosition + this.startExonPosition - 1;
                this._stopCodingPosition = location.firstPosition + this.stopExonPosition - 1;

                console.log("_calcCodingPositions", location, this.startExonPosition, this.stopExonPosition);
            }
        });
    </script>
</dom-module>