<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="../iron-ajax/iron-ajax.html">

<link rel="import" href="nextprot-elements-shared-styles.html">

<link rel="import" href="entry-view-reference.html">

<!--
`entry-item`
Protein entry item demo

@demo demo/entry-item-demo.html
-->
<dom-module id="entry-item">
    <template>
        <style include="nextprot-elements-shared-styles">
            :host {
                display: block;
                border-bottom: var(--publication-item-border-bottom);
                margin-bottom: var(--publication-item-padding-bottom);
                padding-bottom: var(--publication-item-margin-bottom);
            }
            .gray {
                color: #888;
            }
            .grayLink {
                color: grey;
            }
        </style>
        <iron-ajax
                id="APIcall"
                url="https://api.nextprot.org/search/entry.json"
                handle-as="json"
                content-type="application/json"
                method="POST"
                body="{{_getAjaxBody(data)}}"
                on-response="_handleResponseData"
                debounce-duration="300">
        </iron-ajax>
        <template is="dom-if" if="[[data]]">

            <!-- Entry view -->
            <a href="/entry/[[ac]]">[[protName]] <em>([[gene]])</em> [[[ac]]]</a>

            <template is="dom-if" if="[[!summary]]">
                <div class="small">
                    <template is="dom-if" if="[[desc]]">
                        <template is="dom-if" if="[[!_isSame(desc, shortDesc)]]">
                            <span>[[displayedDesc]]</span>
                            <span><a class="grayLink" on-click="_toggleDescription">[[[linkMessage]]]</a></span>
                        </template>
                        <template is="dom-if" if="[[_isSame(desc, shortDesc)]]">
                            <span>[[desc]]</span>
                        </template>
                    </template>
                    <template is="dom-if" if="[[!desc]]">
                        <span> No functional information for this protein. </span>&nbsp;
                    </template>
                </div>
                <div class="gray small">
                    Chromosomal location: <a href="entry/[[ac]]/exons">[[chrLoc]]</a>
                    Isoforms: <a href="entry/[[ac]]/sequence">[[isoformNum]]</a>
                    PTMs: <a href="entry/[[ac]]/sequence">[[ptmNum]]</a>
                    Sequence length: <a href="entry/[[ac]]/sequence">[[aaLength]]</a>
                    Variants: <a href="entry/[[ac]]/sequence">[[varNum]]</a>
                    <br>
                    Disease: <a class$="[[_computeATagClass(isDisease)]]" href="entry/[[ac]]/medical">[[_convertBooleanToYesOrNo(isDisease)]]</a>
                    Expression: <a class$="[[_computeATagClass(isExpression)]]" href="entry/[[ac]]/medical">[[_convertBooleanToYesOrNo(isExpression)]]</a>
                    Mutagenesis: <a class$="[[_computeATagClass(isMutagenesis)]]" href="entry/[[ac]]/medical">[[_convertBooleanToYesOrNo(isMutagenesis)]]</a>
                    Proteomics: <a class$="[[_computeATagClass(isProteomics)]]" href="entry/[[ac]]/medical">[[_convertBooleanToYesOrNo(isProteomics)]]</a>
                    Structure: <a class$="[[_computeATagClass(isStructure)]]" href="entry/[[ac]]/medical">[[_convertBooleanToYesOrNo(isStructure)]]</a>
                    Proteins existence: <a href="entry/[[ac]]/function">[[protExistence]]</a>
                </div>
            </template>

            <!-- Cited For -->
            <template is="dom-if" if="[[data.citedInViews]]">
                <entry-view-reference refs="[[data.citedInViews]]"></entry-view-reference>
            </template>
        </template>
    </template>
    <script>
        Polymer({
            is: 'entry-item',
            properties: {
                data: {
                    type: Object,
                    observer: "APIcaller"
                },
                linkMessage: {
                    type: String,
                    value: "more"
                },
                desc: {
                    type: String
                },
                shortDesc: {
                    type: String
                },
                displayedDesc: {
                    type: String
                },
                ac: {
                    type: String
                },
                gene: {
                    type: String
                },
                protName: {
                    type: String
                },
                chrLoc: {
                    type: String
                },
                isoformNum: {
                    type: Number,
                    value: 0
                },
                ptmNum: {
                    type: Number,
                    value: 0
                },
                aaLength: {
                    type: Number,
                    value: 0
                },
                varNum: {
                    type: Number,
                    value: 0
                },
                isDisease: {
                    type: Boolean
                },
                isExpression: {
                    type: Boolean
                },
                isMutagenesis: {
                    type: Boolean
                },
                isProteomics: {
                    type: Boolean
                },
                isStructure: {
                    type: Boolean
                },
                protExistence: {
                    type: String
                },
                summary: {
                    type: Boolean,
                    value: false
                }
            },
            APIcaller: function () {

                this.$.APIcall.generateRequest();
            },
            _getAjaxBody: function(data) {

                return {
                    quality:"gold",
                    query:"id:"+data.accession
                };
            },
            _handleResponseData: function (data) {

                var response = data.detail.response.results[0];

                this.desc = response.function_desc[0];
                this.shortDesc = this._shorten(this.desc);
                this.displayedDesc = this.shortDesc;
                this.ac = response.recommended_ac;
                this.gene = response.recommended_gene_names;
                this.protName = response.recommended_name;
                this.chrLoc = response.chr_loc;
                this.isoformNum = response.isoform_num;
                this.ptmNum = response.ptm_num;
                this.aaLength = response.aa_length;
                this.varNum = response.var_num;
                this.isDisease = response.filters.indexOf("filterdisease") !== -1;
                this.isExpression = response.filters.indexOf("filterexpressionprofile") !== -1;
                this.isMutagenesis = response.filters.indexOf("filtermutagenesis") !== -1;
                this.isProteomics = response.filters.indexOf("filterproteomics") !== -1;
                this.isStructure = response.filters.indexOf("filterstructure") !== -1;
                this.protExistence = response.protein_existence.split("_").join(" ");

                /*
                    TODO: FIXING PERFORMANCE ISSUE
                    instead of requesting n API calls from this element:
                      ex:
                      {
                        quality:"gold",
                        query:"id:NX_P02675"
                      }
                      {
                        quality:"gold",
                        query:"id:NX_P02679"
                      }
                      {
                        quality:"gold",
                        query:"id:NX_P02671"
                      }
                    a single API call should be done at the level of publication-with-linked-entries:
                      ex: {
                        quality:"gold",
                        query:"id%:(NX_P02675 OR NX_P02679 OR NX_P02671)
                          &fl=filters, protein_existence, chr_loc, var_num, aa_length, ptm_num, isoform_num, function_desc, recommended_ac, recommended_gene_names, recommended_name
                          &wt=json"
                      }

                 */
            },
            _computeATagClass: function (boolean) {
                return (boolean) ? '' : 'inactive';
            },
            _convertBooleanToYesOrNo: function (boolean) {
                return (boolean) ? 'yes' : 'no';
            },
            _shorten: function (str) {
                return (str.length > 300) ? str.substr(0, 300) : str;
            },
            _isSame: function (str1, str2) {
                return str1 === str2;
            },
            _toggleDescription: function () {
                if (this.linkMessage === "more") {
                    this.linkMessage = "less";
                    this.displayedDesc = this.desc;
                }
                else {
                    this.linkMessage = "more";
                    this.displayedDesc = this.shortDesc;
                }
            }
        });
    </script>
</dom-module>
