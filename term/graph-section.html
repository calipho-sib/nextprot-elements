<link rel="import" href="../../polymer/polymer.html">
<link rel="import" href="../../iron-icon/iron-icon.html">
<link rel="import" href="../../iron-icons/iron-icons.html">
<link rel="import" href="../../iron-collapse/iron-collapse.html">
<link rel="import" href="../../neon-animation/animations/scale-up-animation.html">
<link rel="import" href="../../neon-animation/animations/scale-down-animation.html">
<link rel="import" href="../../neon-animation/animations/fade-in-animation.html">
<link rel="import" href="../../neon-animation/animations/fade-out-animation.html">
<link rel="import" href="../../neon-animation/animations/slide-from-left-animation.html">
<link rel="import" href="../../neon-animation/animations/slide-left-animation.html">
<link rel="import" href="../../neon-animation/neon-animation-runner-behavior.html">
<link rel="import" href="../../paper-spinner/paper-spinner-lite.html">

<link rel="import" href="../external-scripts.html">
<link rel="import" href="../nextprot-elements-shared-styles.html">

<!--Iron ajax-->
<link rel="import" href="../../iron-ajax/iron-ajax.html">
<!--
`graph-item`
Graph view section

##### Example
    <graph-section data='{}'></graph-section>
@demo term/demo/graph-section-demo.html
-->

<dom-module id="graph-section">
    <template>
        <style>
            :host {
                display: block;
            }
            text {
                font-weight: 300;
                font-family: "Helvetica Neue", Helvetica, Arial, sans-serf;
                font-size: 14px;
            }
        </style>
        <div id="ancestorDiv"></div>
        <!--Ajax call: it will be replaced with the API call-->
        <iron-ajax
                id ="APIcallBig"
                url="bigdata.json"
                params='{"type":"all"}'
                handle-as="json"
                on-response="ancestorBuild" ></iron-ajax>
        <iron-ajax
                id ="APIcallSmall"
                url="data.json"
                params='{"type":"all"}'
                handle-as="json"
                on-response="ancestorBuild" ></iron-ajax>
    </template>
    <script src="viz.js"></script>

    <script>
        Polymer({
            is: 'graph-section',
            properties: {
                //Accession Input will be given by the ancestor graph element in the future
                accessionInput: {
                    type: String,
                    observer: "ready"
                },
                dataInput: {
                    type: String,
                    observer: "ready"
                },
                arrowInput: {
                    value: 0.5,
                    type: Number,
                    observer: "ready"
                },
                fontInput: {
                    value: 14,
                    type: Number,
                    observer: "ready"
                },
                splineInput: {
                    value: "spline",
                    type: String,
                    observer: "ready"
                },
                zoomInput: {
                    value: 11,
                    type: Number,
                    observer: "ready"
                },
                dataAncestor: {
                    type: Array
                }
                // TODO: The data should be provided via the data attribute injected by the ancestor-graph-view   (ancestor graph view will ask neXtProt API)
            },

            //API call when the DOM is initialized:
            ready: function () {
//                Could refactor using boolean
                if (this.dataInput === "big") {
                    this.$.APIcallBig.generateRequest();
                }
                else {
                    this.$.APIcallSmall.generateRequest();
                }
            },

            getNodeColor: function (nodeAccession) {
                return (nodeAccession === this.accessionInput) ? "#BDE5B9" : "#FFFFFF";
            },

            nodesDotBuild: function (APInodes) {
                //Contains the names of the nodes and style in dot format
                var dotNodesBuilt = "";

//              Node loop: to add the nodes to the graph
                for (var i = 0; i < APInodes.length; i++) {
                    // Translates nodes into Dot Nodes
                    dotNodesBuilt += APInodes[i]["id"] + ' [' + 'label=' + '"' + APInodes[i]["name"].split(' ').join('\n') + '"' + 'style=filled; fillcolor="'+ this.getNodeColor(APInodes[i]["accession"]) + '"' + 'tooltip=' + '"' + APInodes[i]["name"].split(' ').join('\n') + '"' + 'href="https://www.nextprot.org/term/' + APInodes[i]["accession"] + '"' + ';] '
                }
                return dotNodesBuilt
            },

            edgesDotBuild: function (APIedges) {
//                Where the edges data will be stored
                var dotEdgesBuilt = "";

//              Edge loop: to add each edge into the graph
                for (var i = 0; i < APIedges.length; i++) {
                    //variables which call object dictionary:
                    var head = APIedges[i]["head"];
                    var tail = APIedges[i]["tail"];

                    dotEdgesBuilt += '"' + head + '"' + " -> " + '"' + tail + '"' + " [arrowsize="+ this.arrowInput+ ", weight=2];";
                }
                return dotEdgesBuilt
            },

//        Retrieves the data from the Ajax call and places them in APIdata:
            ancestorBuild: function (APIdata) {
                this.dataAncestor = APIdata.detail.response; //Put the data into dataAncestor array (in Properties) TODO: this might need to be changed

                //keeping the accession of the call in a variable TODO: remove split and use parameter given
                this.accessionInput = this.dataAncestor["ancestor-graph"]["label"].split(" ")[0];

                //Defining nodes as the array of objects containing the nodes
                var nodes = this.dataAncestor["ancestor-graph"]["nodes"];
                var dotFormatNodes = this.nodesDotBuild(nodes);

//              Defining edges as the array of objects containing the edge
                var edges = this.dataAncestor["ancestor-graph"]["edges"];
                var dotFormatEdges = this.edgesDotBuild(edges);

//              Showcase: variables kept only for showcase to allow multiple selection:
                var graph = 'digraph "" {	node [shape=' +
                    'square' +
                    ', fontsize='+ this.fontInput +'];' + 'graph [autosize=false, size="90.2,' + this.zoomInput + '", splines=' + this.splineInput + '];' + 'labelfontname=' +
                    '"Helvetica";' + dotFormatNodes + dotFormatEdges +
                    '}';

                this.$.ancestorDiv.innerHTML = Viz(graph);

            }

        }); //Polymer end
    </script>
</dom-module>