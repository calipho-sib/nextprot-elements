<link rel="import" href="../../polymer/polymer.html">
<link rel="import" href="../../iron-icon/iron-icon.html">
<link rel="import" href="../../iron-icons/iron-icons.html">
<link rel="import" href="../../iron-collapse/iron-collapse.html">
<link rel="import" href="../../neon-animation/animations/scale-up-animation.html">
<link rel="import" href="../../neon-animation/animations/scale-down-animation.html">
<link rel="import" href="../../neon-animation/animations/fade-in-animation.html">
<link rel="import" href="../../neon-animation/animations/fade-out-animation.html">
<link rel="import" href="../../neon-animation/animations/slide-from-left-animation.html">
<link rel="import" href="../../neon-animation/animations/slide-left-animation.html">
<link rel="import" href="../../neon-animation/neon-animation-runner-behavior.html">
<link rel="import" href="../../paper-spinner/paper-spinner-lite.html">
<link rel="import" href="../external-scripts.html">
<link rel="import" href="../nextprot-elements-shared-styles.html">
<!--Dagre-D3: more info https://github.com/cpettitt/dagre-d3/wiki -->
<script src="http://d3js.org/d3.v3.min.js" charset="utf-8"></script>
<script src="../../lodash/lodash.js"></script>
<script src="../../graphlib/dist/graphlib.core.js"></script>
<script src="../../dagre/dist/dagre.core.js"></script>
<script src="../../dagre-d3/dist/dagre-d3.core.js"></script>
<!--Iron ajax-->
<link rel="import" href="../../iron-ajax/iron-ajax.html">
<!--JQuery-->
<script src="http://code.jquery.com/jquery-1.9.1.min.js"></script>
<!--
`graph-item`
Graph view section

##### Example
    <graph-section data='{}'></graph-section>
@demo term/demo/graph-section-demo.html
-->

<dom-module id="graph-section">
    <template>
        <style>
            :host {
                display: block;
            }
            text {
                font-weight: 300;
                font-family: "Helvetica Neue", Helvetica, Arial, sans-serf;
                font-size: 14px;
            }

            .node rect {
                stroke: #333;
                fill: #fff;
            }

            .edgePath path {
                stroke: #333;
                fill: #333;
                stroke-width: 1.5px;
            }

            .node text {
                pointer-events: none;
            }
            img.center {
                display: block;
                margin-left: auto;
                margin-right: auto;
            }
            /* This styles the title of the tooltip */
            .tipsy .name {
                font-size: 1.5em;
                font-weight: bold;
                color: #60b1fc;
                margin: 0;
            }

            /* This styles the body of the tooltip */
            .tipsy .description {
                font-size: 1.2em;
            }
        </style>
        <!--Ajax call: it will be replaced with the API call-->
        <iron-ajax
                id ="APIcall"
                url="bigdata.json"
                params='{"type":"all"}'
                handle-as="json"
                on-response="ancestorBuild" ></iron-ajax>

        <svg id="chart" width=100% height=100%></svg>
    </template>

    <script src="tipsy.js"></script>
    <link rel="stylesheet" href="tipsy.css">
    <script>
        Polymer({
            is: 'graph-section',
            properties: {
                dataAncestor: {
                    type: Array
                }
                // TODO: The data should be provided via the data attribute injected by the ancestor-graph-view   (ancestor graph view will ask neXtProt API)
            },

            //API call when the DOM is initialized:
            ready: function () {
                this.$.APIcall.generateRequest();
            },

//        Retrieves the data from the Ajax call and places them in APIdata:
            ancestorBuild: function (APIdata) {
                this.dataAncestor = APIdata.detail.response; //Put the data into dataAncestor array (in Properties) TODO: this might need to be changed

                var g = new dagreD3.graphlib.Graph().setGraph({});

                //keeping the accession of the call in a variable TODO: remove split and use parameter given
                var accessionCall = this.dataAncestor["ancestor-graph"]["label"].split(" ")[0];

                //Defining nodes as the array of objects containing the nodes
                nodes = this.dataAncestor["ancestor-graph"]["nodes"];

//          For loop to add the nodes and highlighting the current one.
                for (var i = 0; i < nodes.length; i++) {
                    var keyNode = nodes[i]["id"];
                    var gNode = { label: nodes[i].name,  rx: 5, ry: 5};

                    //Highlighting the box of the root item
                    if (nodes[i]["accession"] === accessionCall) {
                        gNode["style"] = "fill: #FFF9C4";
                    }

                    //Adds the node objects into the graph:
                    g.setNode(keyNode, gNode);
                }

                //Defining edges as the array of objects containing the edge
                var edges = this.dataAncestor["ancestor-graph"]["edges"];

//              For loop to add each edge into g.
                for (var i = 0; i < edges.length; i++) {
                    //variables which call object dictionary:
                    var head = edges[i]["head"];
                    var tail = edges[i]["tail"];

                    g.setEdge(head, tail, { label: "" }); //empty label could be used to add text besides arrows
                }

                // Create the renderer
                var render = new dagreD3.render();

                // Set up an SVG group so that we can translate the final graph.
                var svg = d3.select(this.$.chart);
                var inner = svg.append("g").attr("transform", "translate(20,20)scale(0.20)");

                // Simple function to style the tooltip for the given node.
                var styleTooltip = function(name, description) {
                    return "<div style='text-align: center;'><img src='http://www.nextprot.org/img/np2.png' height='60%' width='60%'/></div> " + "<p class='description'>" + description + "</p>";
                };

                // Run the renderer. This is what draws the final graph.
                render(inner, g);

                inner.selectAll("g.node")
                    .attr("title", function(dataName) { return styleTooltip(dataName, g.node(dataName).description) })
                    .each(function(dataName) { $(this).tipsy({ gravity: "w", opacity: 0.75, html: true }); });

                svg.attr('height', g.graph().height + 40);

                //CSS issue: This is fixed in Polymer 2.0
                this.scopeSubtree(this.$.chart, true);
                
            }

        }); //Polymer end
    </script>
</dom-module>