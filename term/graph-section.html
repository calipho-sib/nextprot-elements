<link rel="import" href="../../polymer/polymer.html">
<link rel="import" href="../../iron-icon/iron-icon.html">
<link rel="import" href="../../iron-icons/iron-icons.html">
<link rel="import" href="../../iron-collapse/iron-collapse.html">
<link rel="import" href="../../neon-animation/animations/scale-up-animation.html">
<link rel="import" href="../../neon-animation/animations/scale-down-animation.html">
<link rel="import" href="../../neon-animation/animations/fade-in-animation.html">
<link rel="import" href="../../neon-animation/animations/fade-out-animation.html">
<link rel="import" href="../../neon-animation/animations/slide-from-left-animation.html">
<link rel="import" href="../../neon-animation/animations/slide-left-animation.html">
<link rel="import" href="../../neon-animation/neon-animation-runner-behavior.html">
<link rel="import" href="../../paper-spinner/paper-spinner-lite.html">
<link rel="import" href="../external-scripts.html">
<!-- <link rel="import" href="../nextprot-elements-shared-styles.html"> -->
<!--Dagre -->
<script src="http://d3js.org/d3.v3.min.js" charset="utf-8"></script>
<script src="../../lodash/lodash.js"></script>
<script src="../../graphlib/dist/graphlib.core.js"></script>
<script src="../../dagre/dist/dagre.core.js"></script>
<script src="../../dagre-d3/dist/dagre-d3.core.js"></script>
<!--Iron ajax-->
<link rel="import" href="../../iron-ajax/iron-ajax.html">
<!--JQuery-->
<script src="http://code.jquery.com/jquery-1.9.1.min.js"></script>
<!--
`graph-item`
Graph view section

##### Example
    <graph-section data='{}'></graph-section>
@demo term/demo/graph-section-demo.html
-->

<dom-module id="graph-section">
  <template>
    <style>
      :host {
        display: block;
      }
      text {
          font-weight: 300;
          font-family: "Helvetica Neue", Helvetica, Arial, sans-serf;
          font-size: 14px;
      }

      .node rect {
          stroke: #333;
          fill: #fff;
      }

      .edgePath path {
          stroke: #333;
          fill: #333;
          stroke-width: 1.5px;
      }

      .node text {
          pointer-events: none;
      }
      img.center {
          display: block;
          margin-left: auto;
          margin-right: auto;
      }
      /* This styles the title of the tooltip */
      .tipsy .name {
          font-size: 1.5em;
          font-weight: bold;
          color: #60b1fc;
          margin: 0;
      }

      /* This styles the body of the tooltip */
      .tipsy .description {
          font-size: 1.2em;
      }
    </style>
    <!--Ajax call: it will be replaced with the API call-->
    <iron-ajax
            id ="APIcall"
            url="data.json"
            params='{"type":"all"}'
            handle-as="json"
            on-response="ancestorBuild" ></iron-ajax>
      <svg id="chart" width=100% height=100%></svg>
  </template>

    <script src="tipsy.js"></script>
    <link rel="stylesheet" href="tipsy.css">
    <script>
    Polymer({
      is: 'graph-section',
      properties: {
          customData:{
              dataAncestor: {
                  type: Array
              }
          }
            // The data should be provided via the data attribute injected by the ancestor-graph-view   (ancestor graph view will ask neXtProt API)
    },

//        //does the API call when the page is ready:
//        ready: function () {
//            this.$.APIcall.generateRequest();
//        },
//        //Retrieves the data
//        ancestorBuild: function(data) {
//            this.dataAncestor = data.detail.response;
//            console.log(this.dataAncestor);
//            }
//Useful http://frontendinsights.com/polymer-rest-api-using-iron-ajax/

        attached: function () {
            var g = new dagreD3.graphlib.Graph().setGraph({});
            var states = {
                "Blood": {
                    description: "Blood",
                    style: "fill: #FFF9C4"
                },

                "Hematopoietic and immune systems": {
                    description: "Hematopoietic and immune systems"
                },
                "Cardiovascular system": {
                    description: "Cardiovascular system"
                },
                "Hemolymphoid and immune system": {
                    description: "Hemolymphoid and immune system"
                },
                "Anatomical system": {
                    description: "Anatomical system"
                },
                "Fluid and secretion": {
                    description: "Fluid and secretion"
                },
                "Human anatomical entity": {
                    description: "Human anatomical entity"
                }
            }; //Api Data (titles) should be added here

            Object.keys(states).forEach(function(state) {
                var value = states[state];
                value.label = state;
                value.rx = value.ry = 5;
                g.setNode(state, value);
                console.log(g)
            });

            //Api Data (connections) should be appended to g:
            g.setEdge("Blood",     "Cardiovascular system",     { label: "We could write some text" });
            g.setEdge("Blood",     "Hematopoietic and immune systems",     { label: "" });
            g.setEdge("Hematopoietic and immune systems", "Hemolymphoid and immune system",   { label: "" });
            g.setEdge("Hemolymphoid and immune system", "Anatomical system",   { label: "" });
            g.setEdge("Cardiovascular system", "Anatomical system",   { label: "" });
            g.setEdge("Anatomical system", "Human anatomical entity",  { label: "" });
            g.setEdge("Blood",     "Fluid and secretion",     { label: "" });
            g.setEdge("Fluid and secretion", "Human anatomical entity",  { label: "" });

            // Create the renderer
            var render = new dagreD3.render();

            // Set up an SVG group so that we can translate the final graph.
            var svg = d3.select(this.$.chart),
                inner = svg.append("g")
                    .attr("transform", "translate(20,20)scale(1)");

            // Set up zoom support, currently disabled.
//            var zoom = d3.behavior.zoom().on("zoom", function() {
//                inner.attr("transform", "translate(" + d3.event.translate + ")" +
//                                            "scale(" + d3.event.scale + ")");
//                console.log(d3.event.scale);
//              });
//            svg.call(zoom);

            // Simple function to style the tooltip for the given node.
            var styleTooltip = function(name, description) {
                return "<div style='text-align: center;'><img src='https://www.nextprot.org/img/np2.png' height='60%' width='60%'/></div> " + "<p class='description'>" + description + "</p>";
            };

            // Run the renderer. This is what draws the final graph.
            render(inner, g);

            inner.selectAll("g.node")
                .attr("title", function(v) { return styleTooltip(v, g.node(v).description) })
                .each(function(v) { $(this).tipsy({ gravity: "w", opacity: 0.75, html: true }); });

            var initialScale = 1;
//            zoom //if we want to enable it
//              .translate([(svg.attr("width") - g.graph().width * initialScale) / 2, 20])
//              .scale(initialScale)
//              .event(svg);
            svg.attr('height', g.graph().height * initialScale + 40);

            //CSS issue: This is fixed in Polymer 2.0
            this.scopeSubtree(this.$.chart, true);

        }

    }); //Polymer end
  </script>
</dom-module>