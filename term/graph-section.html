<link rel="import" href="../../polymer/polymer.html">
<link rel="import" href="../../iron-icon/iron-icon.html">
<link rel="import" href="../../iron-icons/iron-icons.html">
<link rel="import" href="../../iron-collapse/iron-collapse.html">
<link rel="import" href="../../neon-animation/animations/scale-up-animation.html">
<link rel="import" href="../../neon-animation/animations/scale-down-animation.html">
<link rel="import" href="../../neon-animation/animations/fade-in-animation.html">
<link rel="import" href="../../neon-animation/animations/fade-out-animation.html">
<link rel="import" href="../../neon-animation/animations/slide-from-left-animation.html">
<link rel="import" href="../../neon-animation/animations/slide-left-animation.html">
<link rel="import" href="../../neon-animation/neon-animation-runner-behavior.html">
<link rel="import" href="../../paper-spinner/paper-spinner-lite.html">
<script src="../../webcomponentsjs/webcomponents-lite.js"></script>
<!-- Ensure Web Animations polyfill is loaded since neon-animation 2.0 doesn't import it -->
<link rel="import" href="../../neon-animation/web-animations.html">

<link rel="import" href="../../iron-demo-helpers/demo-snippet.html">
<link rel="import" href="../../iron-demo-helpers/demo-pages-shared-styles.html">
<link rel="import" href="../../paper-item/paper-item.html">
<link rel="import" href="../../paper-listbox/paper-listbox.html">
<link rel="import" href="../../paper-tabs/paper-tabs.html">
<link rel="import" href="../../paper-dropdown-menu/paper-dropdown-menu.html">
<link rel="import" href="../../paper-dropdown-menu/paper-dropdown-menu-light.html">

<link rel="import" href="../external-scripts.html">
<link rel="import" href="../nextprot-elements-shared-styles.html">
<!--Iron ajax-->
<link rel="import" href="../../iron-ajax/iron-ajax.html">
<!--
`graph-item`
Graph view section

##### Example
    <graph-section data='{}'></graph-section>
@demo term/demo/graph-section-demo.html
-->

<dom-module id="graph-section">
    <template>
        <style>
            :host {
                display: block;
            }
            text {
                font-weight: 300;
                font-family: "Helvetica Neue", Helvetica, Arial, sans-serf;
                font-size: 14px;
            }

            .node rect {
                stroke: #333;
                fill: #fff;
            }

            .edgePath path {
                stroke: #333;
                fill: #333;
                stroke-width: 1.5px;
            }

            .node text {
                pointer-events: none;
            }
            img.center {
                display: block;
                margin-left: auto;
                margin-right: auto;
            }
            /* This styles the title of the tooltip */
            .tipsy .name {
                font-size: 1.5em;
                font-weight: bold;
                color: #60b1fc;
                margin: 0;
            }

            /* This styles the body of the tooltip */
            .tipsy .description {
                font-size: 1.2em;
            }
            paper-tabs {
                width: 400px;
            }

            .vertical-section-container {
                max-width: 500px;
            }

            paper-dropdown-menu {
                width: 200px;
                margin-right: 20px;
            }
        </style>
        <!--Ajax call: it will be replaced with the API call-->
        <iron-ajax
                id ="APIcall"
                url="data.json"
                params='{"type":"all"}'
                handle-as="json"
                on-response="ancestorBuild" ></iron-ajax>

        <paper-dropdown-menu-light label="Dinosaurs">
            <paper-listbox slot="dropdown-content" class="dropdown-content">
                <paper-item>allosaurus</paper-item>
                <paper-item>brontosaurus</paper-item>
                <paper-item>carcharodontosaurus</paper-item>
                <paper-item>diplodocus</paper-item>
            </paper-listbox>
        </paper-dropdown-menu-light>
        <br/>
    </template>
    <script src="viz.js"></script>
    <script>
        Polymer({
            is: 'graph-section',
            properties: {
                prova: String,
                dataAncestor: {
                    type: Array
                }
                // TODO: The data should be provided via the data attribute injected by the ancestor-graph-view   (ancestor graph view will ask neXtProt API)
            },

            //API call when the DOM is initialized:
            ready: function () {
                this.$.APIcall.generateRequest();
            },

//        Retrieves the data from the Ajax call and places them in APIdata:
            ancestorBuild: function (APIdata) {

                this.dataAncestor = APIdata.detail.response; //Put the data into dataAncestor array (in Properties) TODO: this might need to be changed

                //keeping the accession of the call in a variable TODO: remove split and use parameter given
                var accessionCall = this.dataAncestor["ancestor-graph"]["label"].split(" ")[0];

                //Defining nodes as the array of objects containing the nodes
                nodes = this.dataAncestor["ancestor-graph"]["nodes"];

                //Contains the names of the nodes and style
                var graphNames = "";

//              For loop to add the nodes to the dictionary and highlighting the current one.
                for (var i = 0; i < nodes.length; i++) {
                    var idNode = nodes[i]["id"];
                    var nameNode = nodes[i]["name"].split(' ').join('\n');

                    //Highlighting the box of the root item
                    if (nodes[i]["accession"] === accessionCall) {
                        graphNames += idNode + ' [' + 'label=' + '"' + nameNode + '"' +'style=filled; fillcolor="#BDE5B9"' + 'tooltip=' + '"' + nameNode + '"' + 'href="https://www.nextprot.org/term/' + nodes[i]["accession"] + '"' +';]'
                    }
                    else { //Nodes are currently filled with white, to make the whole label clickable with URL
                        graphNames += idNode + ' [' + 'label=' + '"' + nameNode + '"' +'style=filled; fillcolor="#ffffff"' + 'tooltip=' + '"' + nameNode + '"' + 'href="https://www.nextprot.org/term/' + nodes[i]["accession"] + '"' +';]'
                    }
                }

//              Defining edges as the array of objects containing the edge
                var edges = this.dataAncestor["ancestor-graph"]["edges"];

//              Where the edges data will be stored
                var graphData = "";

//              For loop to add each edge into the graph
                for (var i = 0; i < edges.length; i++) {
                    //variables which call object dictionary:
                    var head = edges[i]["head"];
                    var tail = edges[i]["tail"];

                    graphData += '"' + head + '"' + " -> " + '"' + tail + '"' + " [arrowsize=.5, weight=2]; ";
                }


//                Tipsy: TODO: integrate this?
//                inner.selectAll("g.node")
//                    .attr("title", function(dataName) { return styleTooltip(dataName, g.node(dataName).description) })
//                    .each(function(dataName) { $(this).tipsy({ gravity: "w", opacity: 0.75, html: true }); });
//
//                svg.attr('height', g.graph().height + 40);
//                svg.attr('width', g.graph().width + 40);

//              Showcase: variables kept only for showcase to allow multiple selection
                var upperGraph = 'digraph G { 	node [shape=';
                var nodeShape = 'square';
                var middleGraph = '];  labelfontname=';
                var graphFont = '"Helvetica";';
//                var graphData = '20113 -> 1216 [arrowsize=.5, weight=2.]; 85870 -> 5511; 14820 -> 14822; 96036 -> 96045; 6621 -> 96045; 8082 -> 14822; 25518 -> 30621; 17035 -> 30621; 24391 -> 30620; 5928 -> 30620; 25518 -> 14820; 20928 -> 14820; 21849 -> 69585; 24326 -> 8082; 12239 -> 8082; 6621 -> 8082; 12538 -> 25960; 20951 -> 20958; 5808 -> 12237; 96036 -> 96037; 13651 -> 96037; 6620 -> 96036; 13651 -> 13655; 14895 -> 14897; 21850 -> 15636; 20113 -> 16359; 20928 -> 20951; 19901 -> 20951; 21917 -> 19103; 69585 -> 20108; 26049 -> 20249; 12538 -> 20958; 21849 -> 21850; 25959 -> 25960; 24330 -> 14822; 20929 -> 12538; 19901 -> 12538; 12239 -> 30576; 12239 -> 14820; 1198 -> 26111; 26419 -> 17035; 5928 -> 17035; 8762 -> 25960; 27520 -> 25959; 30576 -> 25959; 12538 -> 25959; 20928 -> 14822; 6621 -> 20929; 8167 -> 20928; 6621 -> 20928; 12538 -> 85870; 19901 -> 20115; 2105 -> 20113; 114431 -> 20113; 20111 -> 20113; 1198 -> 20113; 24391 -> 8150; 2103 -> 20111; 114429 -> 20111; 1198 -> 20111; 19101 -> 19103; 20111 -> 20108; 10467 -> 19103; 19901 -> 27520; 12239 -> 27520; 25514 -> 25518; 8167 -> 25518; 28307 -> 25515; 28305 -> 25514; 6620 -> 25514; 20929 -> 30576; 5511 -> 14895; 15756 -> 14895; 15758 -> 14897; 30620 -> 30621; 6172 -> 6173; 114431 -> 28609; 28607 -> 28609; 14622 -> 28609; 114429 -> 28607; 30621 -> 28607; 14622 -> 28607; 22270 -> 22272; 16359 -> 22272; 6172 -> 22272; 28307 -> 20784; 16357 -> 22270; 6172 -> 22270; 25514 -> 13650; 13651 -> 13650; 14820 -> 25892; 5805 -> 25892; 6105 -> 8150; 19103 -> 2105; 14897 -> 2105; 5514 -> 2105; 2103 -> 2105; 5514 -> 2103; 19101 -> 2103; 14895 -> 2103; 62994 -> 14622; 17035 -> 14622; 25615 -> 5928; 15636 -> 1216; 20108 -> 1216; 24330 -> 8805; 6094 -> 8805; 8804 -> 8805; 25518 -> 8804; 6094 -> 8804; 6621 -> 59795; 16357 -> 16359; 28609 -> 16359; 26111 -> 16359; 12237 -> 21917; 8721 -> 21917; 5808 -> 21917; 5511 -> 5514; 10467 -> 5514; 20111 -> 16357; 20115 -> 85870; 20958 -> 5511; 19101 -> 20249; 96036 -> 102788; 8167 -> 102788; 19901 -> 8762; 27520 -> 8762; 8082 -> 8762; 59795 -> 19901; 5808 -> 10467; 62994 -> 114431; 6105 -> 62994; 5805 -> 5808; 20928 -> 5805; 28607 -> 16357; 26111 -> 16357; 25892 -> 8721; 14822 -> 8721; 5805 -> 8721; 25515 -> 19820; 20784 -> 19820; 24326 -> 24392; 24391 -> 24392; 25615 -> 24392; 25615 -> 24391; 25514 -> 24391; 17149 -> 21850; 2105 -> 21850; 20249 -> 21849; 2103 -> 21849; 14622 -> 26111; 28305 -> 28307; 6620 -> 28305; 20206 -> 6173; 22272 -> 6173; 1216 -> 6173; 114429 -> 114431; 26111 -> 6172; 8151 -> 114431; 62994 -> 114429; 8150 -> 114429; 15756 -> 15758; 25960 -> 15758; 20958 -> 15758; 14822 -> 15758; 13650 -> 13655; 96037 -> 13655; 24326 -> 13655; 6620 -> 13651; 20958 -> 15756; 25959 -> 15756; 14820 -> 15756; 6620 -> 6621; 102788 -> 13613; 96045 -> 13613; 5514 -> 13613; 6105 -> 13613; 62994 -> 1198; 13613 -> 1198; 26049 -> 26058; 19820 -> 26058; 6620 -> 8167; 25515 -> 26049; 24392 -> 8151; 13655 -> 8151; 8805 -> 8151; 6105 -> 8151; 8150 -> 8151; 5511 -> 14897; 8804 -> 8150; 13650 -> 8150; 24326 -> 24330; 25518 -> 24330; 8167 -> 24330; 25514 -> 24326; 6620 -> 24326; 19103 -> 17149; 26058 -> 17149; 20249 -> 17149; 8167 -> 6105; 6094 -> 6105; 25518 -> 6105; 96037 -> 6105; 26419 -> 6105; 25514 -> 12239; 6621 -> 12239; 25892 -> 12237; 10467 -> 19101; 12237 -> 19101; 8167 -> 6094; 22270 -> 20206; 20108 -> 20206; 6620 -> 25615; 8167 -> 26419; 25615 -> 26419; 6620 [style=filled; fillcolor="#BDE5B9";';
                var lowerGraph = '}';

                this.innerHTML += Viz(upperGraph+nodeShape+middleGraph+graphFont+graphNames+graphData+lowerGraph);


//                //CSS issue: This is fixed in Polymer 2.0
//                this.scopeSubtree(this.$.chart, true);

//
            }

        }); //Polymer end
    </script>
</dom-module>