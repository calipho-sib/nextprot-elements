<link rel="import" href="../../polymer/polymer.html">
<link rel="import" href="term-overview-section.html">
<link rel="import" href="graph-section.html">
<link rel="import" href="../nextprot-elements-shared-styles.html">

<!--
`ancestor-graph-view`
View for ancestor graph view:

Specs:
https://calipho.isb-sib.ch/wiki/display/cal/Ancestor+Graph+Specification

Related issues:
https://issues.isb-sib.ch/browse/NEXTPROT-1493

@demo term/demo/ancestor-graph-view-demo.html
-->
<dom-module id="ancestor-graph-view">
    <template>
        <style include="nextprot-elements-shared-styles">
            :host {
                display: block;
                background:#f8f8f8;
                overflow-y: auto;
            }
        </style>
        <iron-ajax
                id ="APIcall"
                url="https://api.nextprot.org/term/[[accessionInput]]/ancestor-graph.json"
                params='{"type":"all"}'
                handle-as="json"
                on-response="ancestorBuild" ></iron-ajax>
        <div class="row">
            <div id="term-overview-section" class="col-md-12">
                <term-overview-section nx-config="[[nxConfig]]"></term-overview-section>
            </div>
        </div>
        <div class="row">
            <div id="graph-item" class="col-md-12">
                <!--<graph-section dotData='digraph "" { node [shape=square, fontsize=14];graph [autosize=false, size="90.2,11", splines=spline];labelfontname="Helvetica";38278 [label="Basophil"style=filled; fillcolor="#BDE5B9"tooltip="Basophil"href="https://www.nextprot.org/term/TS-0073";] 38922 [label="Myeloid cell"style=filled; fillcolor="#FFFFFF"tooltip="Myeloid cell"href="https://www.nextprot.org/term/TS-0647";] 38700 [label="Hematopoietic and immune systems"style=filled; fillcolor="#FFFFFF"tooltip="Hematopoietic and immune systems"href="https://www.nextprot.org/term/TS-0449";] 38813 [label="Leukocyte"style=filled; fillcolor="#FFFFFF"tooltip="Leukocyte"href="https://www.nextprot.org/term/TS-0549";] 94539 [label="Myeloid leukocyte"style=filled; fillcolor="#FFFFFF"tooltip="Myeloid leukocyte"href="https://www.nextprot.org/term/TS-2367";] 38670 [label="Granulocyte"style=filled; fillcolor="#FFFFFF"tooltip="Granulocyte"href="https://www.nextprot.org/term/TS-0422";] 63279 [label="Cell type"style=filled; fillcolor="#FFFFFF"tooltip="Cell type"href="https://www.nextprot.org/term/TS-2035";] 72643 [label="Human anatomical entity"style=filled; fillcolor="#FFFFFF"tooltip="Human anatomical entity"href="https://www.nextprot.org/term/TS-2178";] 63345 [label="Hemolymphoid and immune system"style=filled; fillcolor="#FFFFFF"tooltip="Hemolymphoid and immune system"href="https://www.nextprot.org/term/TS-2018";] 63344 [label="Hematopoietic cell"style=filled; fillcolor="#FFFFFF"tooltip="Hematopoietic cell"href="https://www.nextprot.org/term/TS-2017";] 63254 [label="Anatomical system"style=filled; fillcolor="#FFFFFF"tooltip="Anatomical system"href="https://www.nextprot.org/term/TS-2088";] "94539" -> "38922" [arrowsize=0.5, weight=2];"94539" -> "38813" [arrowsize=0.5, weight=2];"38278" -> "38670" [arrowsize=0.5, weight=2];"38813" -> "63344" [arrowsize=0.5, weight=2];"63254" -> "72643" [arrowsize=0.5, weight=2];"38700" -> "63345" [arrowsize=0.5, weight=2];"63345" -> "63254" [arrowsize=0.5, weight=2];"63344" -> "38700" [arrowsize=0.5, weight=2];"63344" -> "63279" [arrowsize=0.5, weight=2];"63279" -> "72643" [arrowsize=0.5, weight=2];"38670" -> "94539" [arrowsize=0.5, weight=2];"38922" -> "63344" [arrowsize=0.5, weight=2];}'></graph-section>-->
                <graph-section dotData="[[dotTranslatedGraph]]"></graph-section>
            </div>
        </div>
    </template>

    <script>
        Polymer({
            is: 'ancestor-graph-view',
            properties: {
                nxConfig: {
                    type: Object,
                    value: {}
                },
                accessionInput: {
                    type: String,
                    value: "TS-0073"
                },
                arrowInput: {
                    value: 0.5,
                    type: Number
                },
                fontInput: {
                    value: 14,
                    type: Number
                },
                splineInput: {
                    value: "spline",
                    type: String
                },
                zoomInput: {
                    value: 11,
                    type: Number
                },
                dataAncestor: {
                    type: Array
                },
                dotTranslatedGraph: {
                    type: String
                }
            },
            //API call when the DOM is initialized:
            ready: function () {
                this.$.APIcall.generateRequest();
            },
            
            getNodeColor: function (nodeAccession) {
                return (nodeAccession === this.accessionInput) ? "#BDE5B9" : "#FFFFFF";
            },

            nodesDotBuild: function (APInodes) {
                //Contains the names of the nodes and style in dot format
                var dotNodesBuilt = "";

//              Node loop: to add the nodes to the graph
                for (var i = 0; i < APInodes.length; i++) {
                    // Translates nodes into Dot Nodes
                    dotNodesBuilt += APInodes[i]["id"] + ' [' + 'label=' + '"' + APInodes[i]["name"].split(' ').join('\n') + '"' + 'style=filled; fillcolor="'+ this.getNodeColor(APInodes[i]["accession"]) + '"' + 'tooltip=' + '"' + APInodes[i]["name"].split(' ').join('\n') + '"' + 'href="https://www.nextprot.org/term/' + APInodes[i]["accession"] + '"' + ';] '
                }
                return dotNodesBuilt
            },

            edgesDotBuild: function (APIedges) {
//                Where the edges data will be stored
                var dotEdgesBuilt = "";

//              Edge loop: to add each edge into the graph
                for (var i = 0; i < APIedges.length; i++) {
                    //variables which call object dictionary:
                    var head = APIedges[i]["head"];
                    var tail = APIedges[i]["tail"];

                    dotEdgesBuilt += '"' + head + '"' + " -> " + '"' + tail + '"' + " [arrowsize="+ this.arrowInput+ ", weight=2];";
                }
                return dotEdgesBuilt
            },

//        Retrieves the data from the Ajax call and places them in APIdata:
            ancestorBuild: function (APIdata) {
                this.dataAncestor = APIdata.detail.response; //Put the data into dataAncestor array (in Properties) TODO: this might need to be changed

                //Defining nodes as the array of objects containing the nodes
                var nodes = this.dataAncestor["ancestor-graph"]["nodes"];
                var dotFormatNodes = this.nodesDotBuild(nodes);

//              Defining edges as the array of objects containing the edge
                var edges = this.dataAncestor["ancestor-graph"]["edges"];
                var dotFormatEdges = this.edgesDotBuild(edges);

//              Showcase: variables kept only for showcase to allow multiple selection:
                this.dotTranslatedGraph = 'digraph "" {	node [shape=' +
                    'square' +
                    ', fontsize='+ this.fontInput +'];' + 'graph [autosize=false, size="90.2,' + this.zoomInput + '", splines=' + this.splineInput + '];' + 'labelfontname=' +
                    '"Helvetica";' + dotFormatNodes + dotFormatEdges +
                    '}';
//                console.log("H");
                console.log();

//                this.$.graph.innerHTML += '<graph-section dotData='+ this.dotTranslatedGraph + '></graph-section>' ;
//                this.$$(".ancestor-graph-view")("row").innerHTML += '<graph-section dotData="[[dotTranslatedGraph]]"></graph-section>' ;

                console.log(this.dotTranslatedGraph)
            }


        }); //Polymer end
    </script>
</dom-module>