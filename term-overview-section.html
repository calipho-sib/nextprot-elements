<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="../iron-icon/iron-icon.html">
<link rel="import" href="../iron-icons/iron-icons.html">
<link rel="import" href="../iron-collapse/iron-collapse.html">
<link rel="import" href="../neon-animation/animations/scale-up-animation.html">
<link rel="import" href="../neon-animation/animations/scale-down-animation.html">
<link rel="import" href="../neon-animation/animations/fade-in-animation.html">
<link rel="import" href="../neon-animation/animations/fade-out-animation.html">
<link rel="import" href="../neon-animation/animations/slide-from-left-animation.html">
<link rel="import" href="../neon-animation/animations/slide-left-animation.html">
<link rel="import" href="../neon-animation/neon-animation-runner-behavior.html">
<link rel="import" href="../paper-spinner/paper-spinner-lite.html">
<link rel="import" href="external-scripts.html">
<link rel="import" href="nextprot-elements-shared-styles.html">

<!--
`term-overview-section`
Term overview section

Specifications can be found in here:
https://swissprot.isb-sib.ch/wiki/display/cal/neXtProt+term+views+specs


##### Example
    <term-overview-section nx-config='{"term": "TS-0079"}'></term-overview-section>
@demo demo/term-overview-section-demo.html
-->

<dom-module id="term-overview-section" is="dom-if" if="[[accessionName]]">

    <template>
        <style include="nextprot-elements-shared-styles">
            :host {
                display: block;
            }

            iron-collapse {
                --iron-collapse-transition-duration: 500ms;
            }

            h3 {
                text-align: left;
            }

            dd {<
                margin-left: 15px;
            }

            dt {
                font-weight: inherit;
            }

            .term-link {
                display: inline;
            }

            .paragraph {
                margin: 10px;
            }

            .ec-link {
                display: inline;
            }

            .multiple-prop {
                padding: 0px;
            }

            #extender {
                float: right;
                padding: 1px 6px 1px 0px;
                margin-top: -5px;
            }
        </style>
        <div id="termOverview">
            <h3>
                <template is="dom-if" if="[[term.name]]">
                    [[term.accession]] → [[term.name]] <span style="font-size: 12px"><a target="_blank" href="http://old.nextprot.org/db/term/[[term.accession]]">(NP1 version)</a></span>
                </template>
                [[data.entryName]]
                <template is="dom-if" if="[[data.recommendedProteinName]]">
                    <template is="dom-if" if="[[data.recommendedProteinName.EC.0]]">
                        [
                        <template is="dom-repeat" items="[[data.recommendedProteinName.EC]]" as="ec">
                            <div class="ec-link"><a href="[[nxUrl]]/term/[[ec]]">EC [[ec]]</a></div>
                            <template is="dom-if" if="[[!_checkIfLast(data.recommendedProteinName.EC,index)]]">,
                            </template>
                        </template>
                        ]
                    </template>
                    <template is="dom-if" if="[[data.recommendedProteinName.mainShortName]]">
                        ([[data.recommendedProteinName.mainShortName]])
                    </template>
                </template>
                <paper-spinner-lite id="spinner" active></paper-spinner-lite>
            </h3>
        </div>
        <div id="collapseInfosLess">
            <div id="term-info">
                <template is="dom-if" if="[[term.ontologyDisplayName]]">
                    <div id="term-ontology" class="row">
                        <div class="col-md-3 col-xs-3 grey-x text-align-right">ONTOLOGY :</div>
                        <div class="col-md-9 col-xs-9"> [[term.ontologyDisplayName]] → [[term.accession]] </div>
                    </div>
                </template>
                <template is="dom-if" if="[[term.definition]]">
                    <div id="term-definition" class="row">
                        <div class="col-md-3 col-xs-3 grey-x text-align-right">DEFINITION :</div>
                        <div class="col-md-9 col-xs-9"> [[term.definition]]  </div>
                    </div>
                </template>
                <template is="dom-if" if="[[term.synonyms]]">
                    <template is="dom-if" if="[[term.synonyms.0]]">
                        <div id="term-synonyms" class="row">
                            <div class="col-md-3 col-xs-3 grey-x text-align-right">SYNONYMS :</div>
                            <div class="col-md-9 col-xs-9">
                                <dl>
                                    <template is="dom-repeat" items="[[term.synonyms]]" as="synonym">
                                        <dt>[[synonym]]</dt>
                                    </template>
                                </dl>
                            </div>
                        </div>
                    </template>
                </template>
                <template is="dom-repeat" items="[[termprops]]" as="prop">
                    <template is="dom-if" if="[[_getValueProperties(term, prop.key)]]">
                        <div id="term-[[pro.key]]" class="row">
                            <div class="col-md-3 col-xs-3 grey-x text-align-right">[[prop.label]] :</div>
                            <div class="col-md-9 col-xs-9">
                                <dl>
                                    <template is="dom-repeat" items="[[_getValueProperties(term, prop.key)]]" as="property">
                                        <dt class="col-md-9 col-xs-9 multiple-prop"> [[property.propertyValue]] </dt>
                                    </template>
                                </dl>
                            </div>
                            <template is="dom-if" if="[[prop.ERROR_COMMENT]]">
                                <div class="col-xs-offset-3 col-md-offset-3 col-md-9 col-xs-9">
                                    <p style="color:red">[[prop.ERROR_COMMENT]]</p>
                                </div>
                        </template>
                        </div>
                    </template>
                </template>
                <template is="dom-if" if="[[term.relatedTerms]]">
                    <template is="dom-if" if="[[term.relatedTerms.0]]">
                        <div id="related-terms" class="row">
                            <div class="col-md-3 col-xs-3 grey-x text-align-right">RELATED TERMS :</div>
                            <div class="col-md-9 col-xs-9">
                                <dl>
                                    <template is="dom-repeat" items="[[term.relatedTerms]]" as="rto">
                                        <dt>[[rto.name]] → [[rto.description]] <a target="_blank" href="[[rto.link]]">[[[rto.accession]]]</a></dt>
                                    </template>
                                </dl>
                            </div>
                        </div>
                    </template>
                </template>
                <template is="dom-if" if="[[term.externalReferences]]">
                    <template is="dom-if" if="[[term.externalReferences.0]]">
                        <div id="external-references" class="row">
                            <div class="col-md-3 col-xs-3 grey-x text-align-right">EXTERNAL REFERENCES :</div>
                            <div class="col-md-9 col-xs-9">
                                <dl>
                                    <template is="dom-repeat" items="[[term.externalReferences]]" as="xref">
                                        <dt>[[xref.databaseName]]: <a class="ext-link" target='_blank' href="[[xref.resolvedUrl]]">[[xref.accession]]</a></dt>
                                    </template>
                                </dl>
                            </div>
                        </div>
                    </template>
                </template>
            </div>
        </div>
    </template>
    <script>
        Polymer({
            is: 'term-overview-section',
            properties: {
                nxConfig: {
                    type: Object,
                    value: {}
                },
                term: {
                    type: Object,
                    value: {}
                },
                termprops: {
                    type: Array,
                    value: [
                            {key: "Category", label: "CATEGORY"},
                            {key: "Catalyst", label: "CATALYST"},
                            {key: "Reaction", label: "REACTION"},
                            {key: "Sex of cell", label: "SEX OF CELL"},
                            {key: "Comment", label: "COMMENT"},
                            {key: "Target", label: "TARGETED AMINO ACID"},
                            {key: "Position of the modification", label: "POSITION OF THE MODIFICATION"},
                            {key: "Cellular location", label: "CELLULAR LOCATION"},
                            {key: "Taxonomic range", label: "TAXONOMIC RANGE", "ERROR_COMMENT" : "Missing external links"},
                            {key: "Correction formula", label: "ATOMIC CORRECTION FORMULA"},
                            {key: "Average mass difference", label: "AVERAGE MASS DIFFERENCE"},
                            {key: "Monoisotopic mass difference", label: "MONOISOTONIC MASS DIFFERENCE"}

                    ]
                }
            },
            ready: function () {
                this._npClient = getNXClient(this.nxConfig);
                var self = this;
                // fetch data from overview
                this._npClient.getTermByAccession(self.nxConfig.termAccession).then(function (term) {

                    self.term = self._convertForTemplate(term["cvTerm"]);
                    // load data
                    //self._loadData(overview);
                    self.$.spinner.active = false;

                }, function (error) {
                    self._handleError(error);
                });
            },
            _getValueProperties : function (term, propertyKey){
                if(term[propertyKey]){
                    return term[propertyKey];
                }
            },
            _getProperty: function (propertyName, properties){
                var result = []
                if(properties && (properties.length > 0)) {
                    properties.forEach(function(prop){
                        var ploop = prop.propertyName.replace(/ /g,'').toLowerCase();
                        var parg = propertyName.replace(/ /g,'').toLowerCase();
                        if(ploop === parg){
                            result.push(prop);
                        }
                    })
                }
                return result;
            },
            _convertForTemplate: function (cvTerm) {
                var self = this;
                var term = JSON.parse(JSON.stringify(cvTerm));
                term.definition = term.description;
                if(term.synonyms && (term.synonyms.length > 0)){
                    term.synonyms = term.synonyms.sort(this._sort);
                }
                this.termprops.forEach(function (tp){
                    self._addPropertyToTermIfPresent(tp.key, term);
                })


                if(term.acsOfRelatedTerms && (term.acsOfRelatedTerms.length > 0)){
                    term.relatedTerms = []
                    term.acsOfRelatedTerms.forEach(function (rt){
                        term.xrefs.forEach(function (x){
                            if(x.accession === rt){
                                var rto = {}
                                x.properties.forEach(function (prop){
                                    if(prop.name === "term_ontology_display_name"){
                                        rto["name"] = prop.value
                                    }else if(prop.name === "term_name"){
                                        //Upper case first letter
                                        rto["description"] = prop.value[0].toUpperCase()+prop.value.substr(1);
                                    }
                                })
                                rto.accession = x.accession;
                                rto.link = "/term/" + x.accession;
                                term.relatedTerms.push(rto)
                            }}
                        )
                    })

                    term.relatedTerms = term.relatedTerms.sort(self._sort);
                }



                //Add external references which are not in related terms already
                if(term.xrefs && (term.xrefs.length > 0 )){
                    term.externalReferences = [];
                    term.xrefs.forEach(function (x){
                        if(term.acsOfRelatedTerms.indexOf(x.accession) == -1){
                            term.externalReferences.push(x);
                        }
                    })
                    term.externalReferences = term.externalReferences.sort(this._sort);
                }

                return term;

            },
            _addPropertyToTermIfPresent: function (propertyName, term){

                //DO NOT ADD Cellosaurus comments
                if(!(term.ontology === "NextprotCellosaurusCv" && propertyName === "Comment")){
                    var properties = this._getProperty(propertyName, term.properties);
                    if(properties && (properties.length > 0)){
                            term[propertyName] = properties.sort(this._sort);
                    }
                }


            },
            _sort: function (a, b) {
                if(a.databaseName) {
                    return a.databaseName.toLocaleLowerCase() < b.databaseName.toLocaleLowerCase() ? -1 : 1;
                }
                else if(a["propertyValue"]) {
                    return a["propertyValue"].toLocaleLowerCase() < b["propertyValue"].toLocaleLowerCase() ? -1 : 1;
                }
                else if(a["name"]) {
                    return a["name"].toLocaleLowerCase() < b["name"].toLocaleLowerCase() ? -1 : 1;
                }else {
                    return a.toLocaleLowerCase() < b.toLocaleLowerCase() ? -1 : 1;
                }
            }
        })
    </script>
</dom-module>

<!--
{
  "cvTerm": {
    "id": 38286,
    "accession": "TS-0079",
    "name": "Blood",
    "description": "The body fluid that circulates in the cardiovascular system (blood vessels and blood capillaries) including plasma and blood cells.",
    "ontology": "NextprotAnatomyCv",
    "ontologyAltname": "NextProt tissues",
    "childAccession": [
      "TS-0771",
      "TS-0800"
    ],
    "xrefs": [
      {
        "dbXrefId": 3145881,
        "accession": "BTO:0000553",
        "databaseName": "BRENDA",
        "databaseCategory": "Enzyme and pathway databases",
        "url": "http://www.brenda-enzymes.org",
        "linkUrl": "http://www.brenda-enzymes.org/enzyme.php?ecno=%s&UniProtAcc=%u",
        "resolvedUrl": "http://purl.obolibrary.org/obo/BTO_0000553",
        "properties": [

        ]
      },
      {
        "dbXrefId": 3145512,
        "accession": "BTO:0000089",
        "databaseName": "BRENDA",
        "databaseCategory": "Enzyme and pathway databases",
        "url": "http://www.brenda-enzymes.org",
        "linkUrl": "http://www.brenda-enzymes.org/enzyme.php?ecno=%s&UniProtAcc=%u",
        "resolvedUrl": "http://purl.obolibrary.org/obo/BTO_0000089",
        "properties": [

        ]
      },
      {
        "dbXrefId": 28088013,
        "accession": "UBERON:0000178",
        "databaseName": "Uberon",
        "databaseCategory": "Ontologies",
        "url": "http://uberon.org",
        "linkUrl": "http://purl.obolibrary.org/obo/%s",
        "resolvedUrl": "http://purl.obolibrary.org/obo/UBERON_0000178",
        "properties": [

        ]
      },
      {
        "dbXrefId": 7198024,
        "accession": "D001769",
        "databaseName": "MeSH",
        "databaseCategory": "Ontologies",
        "url": "http://www.nlm.nih.gov/mesh/MBrowser.html",
        "linkUrl": "http://www.nlm.nih.gov/cgi/mesh/2013/MB_cgi?field=uid&term=%s",
        "resolvedUrl": "http://www.nlm.nih.gov/cgi/mesh/2013/MB_cgi?field=uid&term=D001769",
        "properties": [

        ]
      }
    ],
    "synonyms": [
      "Circulating blood ",
      " Peripheral blood ",
      " Bloodstream"
    ],
    "properties": null,
    "ancestorAccession": [
      "TS-0449",
      "TS-1297",
      "TS-2101"
    ],
    "sameAs": [
      "UBERON:0000178",
      "D001769"
    ]
  }
}
-->
