<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="../paper-spinner/paper-spinner-lite.html">
<link rel="import" href="../iron-collapse/iron-collapse.html">
<link rel="import" href="exon-item.html">
<link rel="import" href="external-scripts.html">
<link rel="import" href="nextprot-elements-shared-styles.html">

<!--
`exons-mapping-table`
exons mapping table demo

@demo demo/exons-mapping-table-demo.html
-->
<dom-module id="exons-mapping-table">
    <template>
        <style include="nextprot-elements-shared-styles">

            :host{
                white-space: nowrap;
            }

            #exonTable{
                border: solid lightgray 1px;
                width:auto;
                font-size: 95%;
            }

            /*#exonTable thead, #exonTable tbody {
                float: left;
                width: 100%;
            }
            #exonTable tbody {
                overflow-y: scroll;
                height: 400px;
            }*/

            #exonTable thead {
                background-color: #f8f8f8;
                border-top:1px solid lightgray;
                border-left:1px solid #ddd;
                border-right:1px solid #ddd;
            }

            #exonTable th {
                text-align: center;
                vertical-align: top;
                border-right:1px solid #ddd;
                border-left:1px solid #ddd;
                border-bottom:1px solid #ddd;
                padding:5px;
            }

            #exonTable td {
                text-align: left;
                padding:1px 5px;
                border-bottom:0;
                border-top:0;
                border-left:1px solid #ddd;
                border-right:1px solid #ddd;
            }

            #exonTable .aligned-right{
                text-align: right;
            }

            #exonTable ul {
                padding-left:0;
            }
            ul {
                list-style-type: none;
            }
            iron-collapse{
                font-size: 90%;
            }
            #tableDiv {
                overflow: auto;
            }
        </style>

        <paper-spinner-lite id="spinner" active></paper-spinner-lite>

        <template is="dom-if" if="[[_hasData(data)]]">
            <div class="category-header">
                <h4 class="category-title">Exons</h4>
            </div>
            <div id="tableDiv">
            <table id="exonTable" class="table table-hover">
                <thead>
                <tr>
                    <th>Identifier</th>
                    <th>Position<br>on gene</th>
                    <th>Length</th>
                    <template is="dom-repeat" items="[[_getMappedIsoformInfos(data)]]" as="iso">
                        <th style="text-align:center;">Coding for <br>
                            [[iso.name]]
                            <div>
                        <a href="http://www.ensembl.org/Homo_sapiens/Transcript/Summary?db=core;t=[[iso.main-transcript]]" class="ext-link" target='_blank'>[[iso.main-transcript]]</a>
                            </div>
                            <template is="dom-if" if="[[iso.other-transcripts]]">
                                <span on-tap="_toggle">
                                    <span id="transcripts_[[index]]" class="fa fa-chevron-right" style="display: inline-block;width:14px;"></span>
                                    <span id="showHide_[[index]]" style="display: inline-block;width:36px;">&nbsp;show</span> <span>transcripts ([[iso.other-transcripts.length]])</span>
                                </span>
                                <iron-collapse id="collapse_[[index]]">
                                    <ul>
                                        <template is="dom-repeat" items="[[iso.other-transcripts]]" as="other">
                                            <li><a class="ext-link" href="http://www.ensembl.org/Homo_sapiens/Transcript/Summary?db=core;t=[[other]]" rel="nofollow">[[other]]</a></li>
                                        </template>
                                    </ul>
                                </iron-collapse>
                            </template>
                    </template>
                </tr>
                </thead>
                <tbody>
                    <template is="dom-repeat" items="[[_rows]]" as="row">
                        <tr>
                            <template is="dom-repeat" items="[[row]]" as="cell">
                                <template is="dom-if" if="[[!_exonCell(index)]]">
                                    <td class$="[[_getCellClass(index)]]">[[cell]]</td>
                                </template>
                                <template is="dom-if" if="[[_exonCell(index)]]">
                                    <td><exon-item data="[[cell]]"></exon-item></td>
                                </template>
                            </template>
                        </tr>
                    </template>
                </tbody>
            </table>
            </div>
        </template>
    </template>
    <script>
        Polymer({
            is: 'exons-mapping-table',
            properties: {
                data: {
                    type: Object,
                    observer: "_prepareData"
                },
                _rows: {
                    type: Array,
                    value: []
                },
                _dataLoaded: {
                    type: Boolean,
                    observer: '_updateSpinnerStatus'
                }
            },
            _prepareData: function() {

                var i;
                for (i = 0; i < this.data.sortedExonKeys.length; i++) {

                    this._rows.push(this._newRow(this.data.sortedExonKeys[i]));
                }

                var self = this;
                Polymer.RenderStatus.afterNextRender(self, function () {
                    self._dataLoaded = true;
                });
            },
            _newRow: function(pos) {

                var exonByIsoform = this.data.exons[pos];

                var row = [this._findENSE(exonByIsoform), this._formatPos(pos), this._calcLength(pos)];
                var i;
                for (i = 0; i < this.data.sortedMappedIsoformInfoKeys.length; i++) {

                    if (this.data.sortedMappedIsoformInfoKeys[i] in exonByIsoform) {
                        row.push(exonByIsoform[this.data.sortedMappedIsoformInfoKeys[i]]);
                    }
                    else {
                        row.push(null);
                    }
                }
                return row;
            },
            _formatPos: function(pos) {

                var fromAndTo = pos.split("-");
                return fromAndTo[0] + " - " + fromAndTo[1];
            },
            _calcLength: function(pos) {

                var fromAndTo = pos.split("-");
                return fromAndTo[1]-fromAndTo[0]+1;
            },
            _exonCell: function(index) {
                return index > 2;
            },
            _findENSE: function(exonByIsoform) {

                var i;
                var accessions = [];
                for (i = 0; i < this.data.sortedMappedIsoformInfoKeys.length; i++) {

                    if (this.data.sortedMappedIsoformInfoKeys[i] in exonByIsoform) {
                        if (exonByIsoform[this.data.sortedMappedIsoformInfoKeys[i]].accession) {
                            accessions.push(exonByIsoform[this.data.sortedMappedIsoformInfoKeys[i]].accession);
                        }
                    }
                }

                if (accessions.length> 0) {
                    return accessions[0];
                }
                return null;
            },
            _getMappedIsoformInfos: function(data) {

                var i;
                var infos = [];
                for (i=0 ; i<data.sortedMappedIsoformInfoKeys.length ; i++) {

                    infos.push(data.mappedIsoformInfos[data.sortedMappedIsoformInfoKeys[i]]);
                }

                return infos;
            },
            _getCellClass: function(index) {
                if (index === 1 || index === 2) {
                    return "aligned-right"
                }
                else return ""
            },
            _toggle: function(event) {
                var index = event.model.index;
                this.$$("#collapse_"+index).toggle();
                var opened = this.$$("#collapse_"+index).opened;

                this.$$("#transcripts_"+index).classList.toggle("fa-chevron-down");
                this.$$("#showHide_"+index).innerText = opened ? "Hide" : "Show";

            },
            _hasData: function(data) {

                return data && data.sortedExonKeys.length > 0;
            },
            _updateSpinnerStatus: function(dataLoaded) {

                if (dataLoaded) {

                    this.$.spinner.active = false;
                    this.$.spinner.hidden = true;
                }
            }
        });
    </script>
</dom-module>