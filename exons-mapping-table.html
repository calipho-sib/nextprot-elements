<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="../iron-collapse/iron-collapse.html">
<link rel="import" href="exon-item.html">
<link rel="import" href="external-scripts.html">
<link rel="import" href="nextprot-elements-shared-styles.html">

<!--
`exons-mapping-table`
exons mapping table demo

@demo demo/exons-mapping-table-demo.html
-->
<dom-module id="exons-mapping-table">
    <template>
        <style include="nextprot-elements-shared-styles">

            :host{
                white-space: nowrap;
            }

            table{
                border-collapse:unset;
                border: solid #eee 1px;
            }
            thead {
                background-color: #eee;
                border-bottom:0px;
                border-top:1px solid #ddd;
                border-left:1px solid #ddd;
                border-right:1px solid #ddd;
            }

            thead th {
                text-align: center;
                vertical-align: top;
                border-right:1px solid #ddd;
                border-left:1px solid #f4f4f4;
                border-bottom:0px;
            }

            thead th:first-child{
                border-left:none;
            }

            thead th:last-child{
                border-right:none;
            }

            td {
                text-align: left;
            }

            .table > tbody > tr > td{
                padding:5px;
                border:0;
            }

            .table > tbody > tr > td.lengthCell{
                text-align: right;
                padding-right:15px;
            }
            .posCell{
                text-align: center;
            }

            ul {
                list-style-type: none;
            }

        </style>
        <template is="dom-if" if="[[data]]">
            <div>
                <h3>Exons</h3>
            </div>
            <div>
            <table class="table table-hover">
                <thead>
                <tr>
                    <th style="text-align:left; width: 30px;">Identifier</th>
                    <th style="text-align:center; width: 30px;">Position <br>on gene</th>
                    <th style="text-align:right; width: 20px;">Length</th>
                    <template is="dom-repeat" items="[[_getIsoformInfos(data)]]" as="iso">
                        <th style="text-align:left">Coding for <br>
                            [[iso.name]]:
                            <div>
                        <a href="http://www.ensembl.org/Homo_sapiens/Transcript/Summary?db=core;t=[[iso.main-transcript]]" class="ext-link" target='_blank'>[[iso.main-transcript]]</a>
                            </div>
                            <template is="dom-if" if="[[iso.other-transcripts]]">
                                <span class="additional small fright padding-right margin-right-x link orange-bottom-arrow" show="&nbsp;hide transcripts&nbsp;" hide="&nbsp;show transcripts ([[iso.other-transcripts.length]])">
                                &nbsp;show transcripts ([[iso.other-transcripts.length]])</span>

                                <ul>
                                    <template is="dom-repeat" items="[[iso.other-transcripts]]" as="other">
                                        <li><a class="ext-link" href="http://www.ensembl.org/Homo_sapiens/Transcript/Summary?db=core;t=[[other]]" rel="nofollow">[[other]]</a></li>
                                    </template>
                                </ul>
                            </template>
                    </template>
                </tr>
                </thead>
                <tbody>
                    <template is="dom-repeat" items="[[_rows]]" as="row">
                        <tr>
                            <template is="dom-repeat" items="[[row]]" as="cell">
                                <template is="dom-if" if="[[!_exonCell(index)]]">
                                    <td class$="[[_getCellClass(index)]]">[[cell]]</td>
                                </template>
                                <template is="dom-if" if="[[_exonCell(index)]]">
                                    <td><exon-item data="[[cell]]" exon-width="[[exonWidth]]"></exon-item></td>
                                </template>
                            </template>
                        </tr>
                    </template>
                </tbody>
            </table>
            </div>
        </template>
    </template>
    <script>
        Polymer({
            is: 'exons-mapping-table',
            properties: {
                data: {
                    type: Object,
                    observer: "_prepareData"
                },
                exonWidth: {
                    type: Number,
                    value: 50
                },
                _rows: {
                    type: Array,
                    value: []
                }
            },
            _prepareData: function() {

                var i;
                for (i = 0; i < this.data.sortedExonKeys.length; i++) {

                    this._rows.push(this._newRow(this.data.sortedExonKeys[i]));
                }
            },
            _newRow: function(pos) {

                var exonByIsoform = this.data.exons[pos];

                var row = [this._findENSE(exonByIsoform), this._formatPos(pos), this._calcLength(pos)];
                var i;
                for (i = 0; i < this.data.sortedIsoformKeys.length; i++) {

                    if (this.data.sortedIsoformKeys[i] in exonByIsoform) {
                        row.push(exonByIsoform[this.data.sortedIsoformKeys[i]]);
                    }
                    else {
                        row.push(null);
                    }
                }
                return row;
            },
            _formatPos: function(pos) {

                var fromAndTo = pos.split("-");
                return fromAndTo[0] + " - " + fromAndTo[1];
            },
            _calcLength: function(pos) {

                var fromAndTo = pos.split("-");
                return fromAndTo[1]-fromAndTo[0]+1;
            },
            _exonCell: function(index) {
                return index > 2;
            },
            _findENSE: function(exonByIsoform) {

                var i;
                var accessions = [];
                for (i = 0; i < this.data.sortedIsoformKeys.length; i++) {

                    if (this.data.sortedIsoformKeys[i] in exonByIsoform) {
                        if (exonByIsoform[this.data.sortedIsoformKeys[i]].accession) {
                            accessions.push(exonByIsoform[this.data.sortedIsoformKeys[i]].accession);
                        }
                    }
                }

                if (accessions.length> 0) {
                    return accessions[0];
                }
                return null;
            },
            _getIsoformInfos: function(data) {

                var i;
                var infos = [];
                for (i=0 ; i<data.sortedIsoformKeys.length ; i++) {

                    infos.push(data.isoformInfos[data.sortedIsoformKeys[i]]);
                }

                return infos;
            },
            _getCellClass: function(index) {
                if (index === 1) {
                    return "posCell"
                }
                else if (index === 2){
                    return "lengthCell"
                }
                else return ""
            }
        });
    </script>
</dom-module>