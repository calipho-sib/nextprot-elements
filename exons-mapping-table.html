<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="../iron-collapse/iron-collapse.html">
<link rel="import" href="exon-item.html">
<link rel="import" href="external-scripts.html">

<!--
`exons-mapping-table`
exons mapping table demo

@demo demo/exons-mapping-table-demo.html
-->
<dom-module id="exons-mapping-table">
    <template>
        <style>
            table, th, td {
                border: 1px solid black;
                border-collapse: collapse;
                padding: 4px;
            }

            ul {
                list-style-type: none;
            }
        </style>
        <template is="dom-if" if="[[data]]">
            <div>
                <h1>Exons</h1>
            </div>
            <div>
            <table>
                <thead>
                <tr>
                    <th>Identifier</th>
                    <th>Position on gene</th>
                    <th>Length</th>
                    <template is="dom-repeat" items="[[data.isoformInfos]]" as="iso">
                        <th>Coding for <br>
                            [[iso.name]]:
                            <div>
                        <a href="http://www.ensembl.org/Homo_sapiens/Transcript/Summary?db=core;t=[[iso.main-transcript]]" class="ext-link" target='_blank'>[[iso.main-transcript]]</a>
                            </div>
                            <template is="dom-if" if="[[iso.other-transcripts]]">
                                <span class="additional small fright padding-right margin-right-x link orange-bottom-arrow" show="&nbsp;hide transcripts&nbsp;" hide="&nbsp;show transcripts ([[iso.other-transcripts.length]])">
                                &nbsp;show transcripts ([[iso.other-transcripts.length]])</span>

                                <ul>
                                    <template is="dom-repeat" items="[[iso.other-transcripts]]" as="other">
                                        <li><a href="http://www.ensembl.org/Homo_sapiens/Transcript/Summary?db=core;t=[[other]]" rel="nofollow">[[other]]</a></li>
                                    </template>
                                </ul>
                            </template>
                    </template>
                </tr>
                </thead>
                <tbody>
                    <template is="dom-repeat" items="[[_rows]]" as="row">
                        <tr>
                            <template is="dom-repeat" items="[[row]]" as="cell">
                                <template is="dom-if" if="[[!_exonCell(index)]]">
                                    <td>[[cell]]</td>
                                </template>
                                <template is="dom-if" if="[[_exonCell(index)]]">
                                    <td><exon-item data="[[cell]]" exon-width="[[exonWidth]]"></exon-item></td>
                                </template>
                            </template>
                        </tr>
                    </template>
                </tbody>
            </table>
            </div>
        </template>
    </template>
    <script>
        Polymer({
            is: 'exons-mapping-table',
            properties: {
                data: {
                    type: Object,
                    observer: "_prepareData"
                },
                exonWidth: {
                    type: Number,
                    value: 50
                },
                _rows: {
                    type: Array,
                    value: []
                }
            },
            _prepareData: function() {

                var isoAccessions = this.data.isoformInfos.map(function(info) {
                    return info.accession;
                });

                var i;
                for (i = 0; i < this.data.sortedKeys.length; i++) {

                    this._rows.push(this._newRow(this.data.sortedKeys[i], isoAccessions));
                }
            },
            _newRow: function(pos, isoAccessions) {

                var exonByIsoform = this.data.exons[pos];

                var row = [this._findENSE(isoAccessions, exonByIsoform), pos, this._calcLength(pos)];
                var i;
                for (i = 0; i < isoAccessions.length; i++) {

                    if (isoAccessions[i] in exonByIsoform) {
                        row.push(exonByIsoform[isoAccessions[i]]);
                    }
                    else {
                        row.push(null);
                    }
                }
                return row;
            },
            _calcLength: function(pos) {

                var fromAndTo = pos.split("-");
                return fromAndTo[1]-fromAndTo[0]+1;
            },
            _exonCell: function(index) {
                return index > 2;
            },
            _findENSE: function(isoAccessions, exonByIsoform) {

                var i;
                var accessions = [];
                for (i = 0; i < isoAccessions.length; i++) {

                    if (isoAccessions[i] in exonByIsoform) {
                        if (exonByIsoform[isoAccessions[i]].accession) {
                            accessions.push(exonByIsoform[isoAccessions[i]].accession);
                        }
                    }
                }

                if (accessions.length> 0) {
                    return accessions[0];
                }
                return null;
            }
        });
    </script>
</dom-module>